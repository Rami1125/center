<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Chosen Palette: Main catalog now light blue/white with bold text. Advisor Modal retains enhanced glassmorphism. -->
    <!-- Application Structure Plan: The core SPA remains kiosk-centric with a filter sidebar and product grid, now with a refreshed light blue and white theme. The "Advanced Product Advisor" modal is significantly enhanced: it now provides concise answers, offers dynamic follow-up actions (expand details, related products), remembers chat history, and can display tables/emojis. Image fetching from Google Search is integrated for product visuals. The button to open it is centralized and uses an advanced POPUP style. The order system with WhatsApp remains. This structure provides a highly sophisticated AI-driven consultation experience alongside a visually appealing and functional product catalog. -->
    <!-- Visualization & Content Choices:
        - Product Catalog & Filtering: Goal -> Visually refreshed catalog with light blue/white theme. Viz/Presentation -> Updated product cards, filters, and search bar with new color scheme and bold text. Interaction -> Filters and search instantly update the grid. Justification -> Modernized, clearer interface.
        - Product Detail Modal: Goal -> Consistent styling within the new theme. Viz/Presentation -> Maintains glassmorphism but with updated text colors and button styles to match. Interaction -> Tabs for detailed info, quantity calculator. Justification -> Retains functional richness with updated aesthetics.
        - Dynamic Quantity Calculator: Goal -> Functional, clear. Viz/Presentation -> Styled inputs and result display within the modal. Interaction -> Real-time calculation. Justification -> Essential professional tool.
        - Barcode Scanning: Goal -> Quick lookup. Viz/Presentation -> Button, simple prompt. Interaction -> User input, product display. Justification -> Streamlined in-store lookup.
        - Advanced Product Advisor (LLM Feature - Major Update): Goal -> Concise, precise, interactive AI advice with chat memory. Viz/Presentation -> Dedicated modal (light blue/white glassmorphism) with typing effect, emojis, and dynamic buttons for follow-up questions ("הרחב", "מוצרים נלווים"). The modal features a sophisticated POPUP behavior for opening/closing. Interaction -> User query, AI responds briefly, then prompts for deeper engagement. Chat history persists across modal openings. Justification -> Addresses previous feedback for conciseness and adds significant interactivity and depth to AI consultation.
        - WhatsApp Ordering: Goal -> Streamlined submission. Viz/Presentation -> Standard cart modal leading to a WhatsApp link. Interaction -> User fills form, redirects to WhatsApp. Justification -> Simplified ordering process.
        - Image Fetching: Goal -> Display richer product images. Viz/Presentation -> Dynamically loaded images from Google Search in product cards and modals. Interaction -> Automatic. Justification -> Enhances visual appeal and product representation.
        - Brand Logos: Goal -> Display brand logos. Viz/Presentation -> Small logo on product cards and in product modal. Interaction -> Passive display. Justification -> Visual identification of brands.
        - Company Logo: Goal -> Display H.Saban logo. Viz/Presentation -> Prominently placed in header. Interaction -> Passive display. Justification -> Branding.
        - Branch Gallery: Goal -> Showcase store images. Viz/Presentation -> New modal with grid layout, filter buttons. Interaction -> Open modal, filter images. Justification -> Provides visual context for branches.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <title>קטלוג פרימיום אינטראקטיבי - ח.סבן חומרי בניין</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background: linear-gradient(to bottom right, #e0f2f7, #ffffff); /* Light blue to white gradient */
            color: #1a202c; /* Darker text for contrast */
        }
        .main-container {
            direction: rtl;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .btn-primary {
            @apply bg-gradient-to-br from-blue-500 to-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105;
        }
        .btn-secondary {
            @apply bg-white bg-opacity-80 text-blue-700 font-bold py-2 px-6 rounded-full border border-blue-300 hover:bg-blue-100 transition-all duration-300;
        }
        .product-card {
            @apply bg-white bg-opacity-90 rounded-2xl shadow-lg overflow-hidden transform hover:-translate-y-2 transition-transform duration-300 cursor-pointer border border-blue-100;
        }
        .product-card:hover {
             box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .modal {
            @apply fixed inset-0 flex items-center justify-center p-4 z-50;
            background: rgba(0, 0, 0, 0.5);
            transition: opacity 0.4s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-content-wrapper {
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform: scale(0.9) translateY(20px);
            opacity: 0;
        }
        .modal:not(.hidden) .modal-content-wrapper {
            transform: scale(1) translateY(0);
            opacity: 1;
        }
        .modal-content {
            @apply glass-effect rounded-3xl shadow-2xl w-full max-w-5xl max-h-[95vh] flex flex-col;
        }
        .tab-button {
            @apply px-5 py-3 font-semibold text-gray-600 border-b-4 border-transparent hover:bg-blue-50 hover:bg-opacity-50 hover:text-blue-700 transition-all duration-300;
        }
        .tab-button.active {
            @apply text-blue-700 border-blue-500;
        }
        .typing-effect::after {
            content: '|';
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { color: transparent }
            50% { color: #2563EB; } /* Blue for typing effect */
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
        ::-webkit-scrollbar-thumb { background: #90CAF9; border-radius: 4px; } /* Light blue scrollbar */
        ::-webkit-scrollbar-thumb:hover { background: #2196F3; } /* Darker blue on hover */

        /* New Advisor Modal Styles */
        .advisor-modal-content {
            background: rgba(255, 255, 255, 0.95); /* More opaque white */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(173, 216, 230, 0.7); /* Light blue border */
            @apply rounded-3xl shadow-2xl w-full max-w-3xl max-h-[95vh] flex flex-col;
        }
        .advisor-modal-header {
            @apply bg-gradient-to-br from-[#ADD8E6] to-[#87CEEB] text-white p-6 rounded-t-3xl;
            border-bottom: 1px solid rgba(255, 255, 255, 0.6);
        }
        .advisor-input-area {
            @apply bg-white bg-opacity-80 border border-blue-200 focus:ring-blue-300;
        }
        .advisor-response-area {
            @apply bg-blue-50 bg-opacity-70 border border-blue-200 text-blue-800;
        }
        .advisor-loading-spinner {
            border-color: #87CEEB;
            border-top-color: transparent;
        }
        .chat-message {
            @apply p-3 rounded-lg my-2 max-w-[85%];
        }
        .chat-message.user {
            @apply bg-blue-100 text-blue-900 self-end ml-auto;
        }
        .chat-message.ai {
            @apply bg-gray-100 text-gray-800 self-start mr-auto;
        }
        .chat-message.ai strong {
            color: #2563EB; /* Make strong text blue in AI responses */
        }
        .chat-options-container {
            @apply flex flex-wrap gap-2 mt-3;
        }
        .chat-option-button {
            @apply bg-blue-200 text-blue-800 px-3 py-1 rounded-full text-sm hover:bg-blue-300 transition-colors;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: rgba(255,255,255,0.7);
            border-radius: 0.75rem; /* rounded-xl */
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        th, td {
            padding: 0.75rem;
            text-align: right;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        th {
            background-color: #e0f2f7; /* Light blue header */
            font-weight: bold;
            color: #2563eb;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tr:nth-child(even) {
            background-color: rgba(240, 248, 255, 0.5); /* Alice Blue subtle stripe */
        }
        /* Gallery modal specific styles */
        .gallery-modal-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(173, 216, 230, 0.7);
            @apply rounded-3xl shadow-2xl w-full max-w-5xl max-h-[95vh] flex flex-col;
        }
        .gallery-image-card {
            @apply bg-white rounded-lg shadow-md overflow-hidden border border-blue-100;
        }
        .gallery-image-card img {
            @apply w-full h-40 object-cover;
        }
    </style>
</head>
<body class="main-container">

    <div id="app" class="min-h-screen">
        <header class="glass-effect shadow-md p-4 flex justify-between items-center sticky top-0 z-40">
            <div class="flex items-center">
                <img src="https://i0.wp.com/saban94.wordpress.com/wp-content/uploads/2020/01/cropped-22489661_366092580492942_6527060566628824285_n-1.jpg?resize=200%2C200&ssl=1" alt="לוגו ח.סבן" class="h-16 w-16 mr-3 rounded-full object-cover">
                <h1 class="text-3xl font-bold text-blue-800">ח.סבן חומרי בניין</h1>
            </div>
            <div class="flex items-center space-x-4 space-x-reverse">
                <div class="relative">
                    <input id="searchInput" type="text" placeholder="הקלד לחיפוש מוצר..." class="w-64 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 glass-effect">
                    <span id="searchIcon" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">🔍</span>
                </div>
                <button id="projectAdvisorButton" class="btn-secondary">✨ יועץ מוצר מתקדם ✨</button>
                <button id="showGalleryButton" class="btn-secondary">🖼️ גלריית סניפים</button>
                <button id="cartButton" class="relative btn-secondary">
                    🛒
                    <span id="cartCount" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center border-2 border-white">0</span>
                    <span class="mr-2">הזמנה</span>
                </button>
                 <button id="scanBarcode" class="btn-secondary">סריקת ברקוד</button>
            </div>
        </header>

        <main class="p-8 grid grid-cols-1 lg:grid-cols-4 gap-8">
            <aside class="lg:col-span-1 glass-effect p-6 rounded-2xl shadow-lg h-fit sticky top-24">
                <h2 class="text-2xl font-bold mb-6 border-b border-gray-300 pb-3 text-blue-800">סינון מוצרים</h2>
                <div id="filters">
                    <div>
                        <h3 class="font-bold text-lg mb-3 text-blue-700">קטגוריה</h3>
                        <div id="categoryFilters" class="space-y-2"></div>
                    </div>
                    <div class="mt-8">
                        <h3 class="font-bold text-lg mb-3 text-blue-700">מותג</h3>
                        <div id="brandFilters" class="space-y-2"></div>
                    </div>
                     <div class="mt-8">
                        <button id="clearFilters" class="w-full btn-secondary">נקה סינונים</button>
                    </div>
                </div>
            </aside>

            <section id="productGrid" class="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
            </section>
        </main>
    </div>

    <div id="productModal" class="modal hidden">
        <div id="modalContentWrapper" class="modal-content-wrapper">
             <!-- Content will be injected by JS -->
        </div>
    </div>
    
    <div id="cartModal" class="modal hidden">
         <div class="modal-content-wrapper w-full max-w-2xl">
            <div class="modal-content">
                 <header class="p-6 border-b border-gray-300 flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-blue-800">ההזמנה שלי</h2>
                    <button id="closeCartModal" class="text-3xl font-bold text-gray-500 hover:text-red-500 transition-colors">&times;</button>
                </header>
                <div id="cartItemsContainer" class="p-6 overflow-y-auto flex-grow">
                </div>
                <footer class="p-6 border-t border-gray-200 bg-white bg-opacity-30">
                     <h3 class="text-xl font-bold mb-4 text-blue-700">פרטי מילוי הזמנה</h3>
                     <form id="orderForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <input type="text" placeholder="שם מלא" id="customerName" class="p-3 border rounded-lg bg-white bg-opacity-90 border-blue-300 focus:ring-2 focus:ring-blue-500" required>
                         <input type="tel" placeholder="מספר טלפון" id="customerPhone" class="p-3 border rounded-lg bg-white bg-opacity-90 border-blue-300 focus:ring-2 focus:ring-blue-500" required>
                         <textarea placeholder="הערות להזמנה..." rows="2" id="orderNotes" class="p-3 border rounded-lg md:col-span-2 bg-white bg-opacity-90 border-blue-300 focus:ring-2 focus:ring-blue-500"></textarea>
                         <button type="submit" class="btn-primary md:col-span-2 mt-2">שלח הזמנה לוואטסאפ</button>
                     </form>
                </footer>
            </div>
        </div>
    </div>

    <div id="projectAdvisorModal" class="modal hidden">
        <div class="modal-content-wrapper w-full max-w-3xl">
            <div class="advisor-modal-content">
                <header class="advisor-modal-header flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-white">✨ יועץ מוצר מתקדם ✨</h2>
                    <button id="closeProjectAdvisorModal" class="text-3xl font-bold text-white hover:text-red-300 transition-colors">&times;</button>
                </header>
                <div id="advisorChatHistory" class="p-6 flex-grow overflow-y-auto flex flex-col items-start">
                    <!-- Chat messages will be injected here -->
                    <div id="initialAdvisorMessage" class="chat-message ai">
                        שלום! אני יועץ המוצר המתקדם של ח.סבן חומרי בניין. איך אוכל לעזור לך היום? 😊
                    </div>
                </div>
                <footer class="p-6 border-t border-blue-200 bg-white bg-opacity-90">
                    <div class="mb-4">
                        <textarea id="projectAdvisorInput" class="advisor-input-area w-full p-3 border rounded-lg h-20 resize-none" placeholder="תאר את הפרויקט שלך או שאל שאלה על חומרים..."></textarea>
                    </div>
                    <button id="getAdvisorAdvice" class="btn-primary w-full">קבל ייעוץ</button>
                    <div id="advisorLoading" class="hidden mt-4 text-center text-blue-600">
                        <span class="inline-block h-6 w-6 border-4 border-t-4 rounded-full animate-spin advisor-loading-spinner"></span>
                        <span class="mr-2">טוען ייעוץ...</span>
                    </div>
                </footer>
            </div>
        </div>
    </div>

    <div id="galleryModal" class="modal hidden">
        <div class="modal-content-wrapper w-full max-w-5xl">
            <div class="gallery-modal-content">
                <header class="advisor-modal-header flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-white">🖼️ גלריית סניפים</h2>
                    <button id="closeGalleryModal" class="text-3xl font-bold text-white hover:text-red-300 transition-colors">&times;</button>
                </header>
                <div class="p-6 flex flex-col flex-grow overflow-hidden">
                    <div class="flex justify-center mb-6 gap-3">
                        <button data-branch-filter="all" class="btn-secondary active-filter-btn">הכל</button>
                        <button data-branch-filter="החרש" class="btn-secondary">סניף החרש</button>
                        <button data-branch-filter="התלמיד" class="btn-secondary">סניף התלמיד</button>
                    </div>
                    <div id="galleryImageContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto flex-grow">
                        <!-- Gallery images will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Use google_search tool to fetch product images.
        // Product data will be enhanced with image URLs from the internet.
        // It will provide concise AI answers and then offer to expand on details or find related products.
        // It will remember chat history within the session.
        // It will have a light blue/white premium design with bold text and glassmorphism.

        // Initial product data (will be enhanced with images dynamically)
        const products = [
            {
                id: 1,
                name: "תרמוקיר טיח תרמי 300",
                brand: "תרמוקיר",
                brand_logo_url: "https://termokir.co.il/logo.png",
                image: "https://termokir.co.il/wp-content/uploads/2020/05/th300-lca-218x345.jpg", // Updated image
                category: "טיח",
                description: "טיח תרמי איכותי לבידוד תרמי של מבנים, עומד בתקנים מחמירים.",
                specs: {
                    "צפיפות יבשה": "פחות מ-300 ק\"ג/מ\"ק",
                    "מוליכות תרמית": "0.085 W/(m*k)",
                    "חוזק לחיצה (28 יום)": "מעל 1.0 מגפ\"ס",
                    "צריכה אופיינית": "0.5-1.4 מ\"ר/שק (תלוי בעובי)",
                    "תקנים": "ת\"י 1414, ת\"י 1045, ת\"י 5282, תו ירוק",
                },
                application: [
                    "יש לנקות ולשטוף את התשתית יום לפני היישום.",
                    "לערבב 11-12 ליטר מים עם שק 25 ק\"ג עד לקבלת עיסה אחידה.",
                    "להמתין 5 דקות ולערבב שוב.",
                    "ליישם שכבה דקה ומהודקת, ולאחר מכן להשלים לעובי הנדרש (20-70 מ\"מ).",
                    "במערכת מורכבת, יש ליישם 48 שעות לאחר שכבת טיח תרמי 400 TH, ו-72 שעות לפני שליכט בגר."
                ],
                drying: {
                    "זמן שמישות לעבודה": "כשעה",
                    "בין שכבות במערכת": "48-72 שעות",
                    "חשיפה למים": "יש להימנע בתקופת הייבוש הראשונית"
                },
                calculator: {
                    type: 'coverage_thickness_kg',
                    unit: 'שקים',
                    bag_weight_kg: 25,
                    coverage_per_sqm_per_mm_kg: 0.3,
                    min_thickness_mm: 20,
                    max_thickness_mm: 70
                },
                related_products_ids: []
            },
            {
                id: 2,
                name: "תרמוקיר דבק AD 603",
                brand: "תרמוקיר",
                brand_logo_url: "https://termokir.co.il/logo.png",
                image: "https://termokir.co.il/wp-content/uploads/2014/01/0005_AD603.jpg", // Updated image
                category: "דבקים לריצוף",
                description: "דבק צמנטי גמיש להדבקת אריחים, סיווג C2TE S1.",
                specs: {
                    "סיווג": "C2TE S1",
                    "חוזק הידבקות במתיחה": "מעל 1.0-1.5 מגפ\"ס",
                    "עיווי רוחבי (גמישות)": "> 2.5 מ\"מ",
                    "עובי יישום": "5-10 מ\"מ",
                    "תקנים": "ת\"י 4004, ת\"י 1555, תו ירוק",
                },
                application: [
                    "לערבב כ-6.5 ליטר מים עם שק 25 ק\"ג.",
                    "למרוח שכבה דקה ומהודקת על התשתית ועל גב האריח.",
                    "לסרק שכבה נוספת על התשתית במאלג' משונן.",
                    "להצמיד את האריח בשיטת 'רטוב על רטוב' ולהדק."
                ],
                drying: {
                    "זמן שמישות לעבודה": "כשעה",
                    "זמן פתוח": "30 דקות",
                    "אי-חשיפה למים": "72 שעות לפחות"
                },
                calculator: {
                    type: 'coverage_thickness_kg',
                    unit: 'שקים',
                    bag_weight_kg: 25,
                    coverage_per_sqm_per_mm_kg: 1.40,
                    min_thickness_mm: 5,
                    max_thickness_mm: 10
                },
                related_products_ids: [9] // רובה
            },
            {
                id: 3,
                name: "כרמית דבק גמיש 116",
                brand: "כרמית מיסטר פיקס",
                brand_logo_url: "https://www.carmit-mrfix.com/wp-content/uploads/2023/12/%D7%93%D7%91%D7%A7-%D7%92%D7%9E%D7%99%D7%A9-116-%D7%A4%D7%A8%D7%99%D7%9E%D7%99%D7%95%D7%9D-C2TE-S1.png",
                category: "דבקים לריצוף",
                description: "דבק צמנטי גמיש במיוחד להדבקת כל סוגי האריחים, סיווג C2TE-S1.",
                specs: {
                    "סיווג": "C2TE-S1",
                    "חוזק הידבקות במתיחה": "מעל 1 מגפ\"ס",
                    "החלקה אנכית": "פחות מ-0.5 מ\"מ",
                    "עובי יישום": "4-10 מ\"מ",
                    "תקנים": "ת\"י 1555, ת\"י 4004, ת\"י 2378, תו ירוק",
                },
                application: [
                    "לערבב 8-8.5 ליטר מים עם שק 25 ק\"ג.",
                    "על תשתיות לא סופגות, יש ליישם פריימר 82-P ולהמתין 90 דקות.",
                    "למרוח 100% כיסוי על גב האריח.",
                    "להצמיד לתשתית, לטלטל ולהדק עם פטיש גומי."
                ],
                drying: {
                    "זמן שמישות לעבודה": "עד 3 שעות",
                    "זמן פתוח": "30 דקות",
                    "אי-חשיפה למים": "24 שעות"
                },
                calculator: {
                    type: 'coverage_thickness_kg',
                    unit: 'שקים',
                    bag_weight_kg: 25,
                    coverage_per_sqm_per_mm_kg: 1.5,
                    min_thickness_mm: 4,
                    max_thickness_mm: 10
                },
                related_products_ids: [9] // רובה
            },
            {
                id: 4,
                name: "טמבור טיח צמנטי 984",
                brand: "טמבור",
                brand_logo_url: "https://tambour.co.il/wp-content/uploads/2018/06/984_web1.jpg",
                category: "טיח",
                description: "טיח על בסיס צמנט ליישור קירות ותקרות במרחבים מוגנים (ממ\"ד).",
                specs: {
                    "צריכה אופיינית": "1.7 ק\"ג/מ\"ר לעובי 1 מ\"מ",
                    "שימוש": "קירות פנים וחוץ, ממ\"דים",
                    "תקנים": "ת\"י 5075, EPD, ISO14001",
                },
                application: [
                    "מתאים ליישום על בטון, בלוקים וטיח קיים.",
                    "יש להקפיד על תשתית נקייה ויציבה.",
                    "מיועד ליישום ידני או במכונה."
                ],
                drying: {
                    "זמן ייבוש סופי": "28 יום"
                },
                calculator: {
                    type: 'coverage_thickness_kg',
                    unit: 'שקים',
                    bag_weight_kg: 25,
                    coverage_per_sqm_per_mm_kg: 1.7,
                    min_thickness_mm: 10,
                    max_thickness_mm: 30
                },
                related_products_ids: [1,5] // טיח תרמי, שליכט
            },
            {
                id: 5,
                name: "נירלט שליכט EXTRA M100",
                brand: "נירלט",
                brand_logo_url: "https://nirlat.com/wp-content/uploads/2012/06/%D7%A9%D7%9C%D7%99%D7%9B%D7%98-100.png",
                category: "טיח",
                description: "שליכט אקרילי גמיש בגימור מט, עמיד בתנאי אקלים קשים.",
                specs: {
                    "כושר כיסוי": "משתנה לפי מרקם (כ-2 ק\"ג/מ\"ר)",
                    "גישור על סדקים": "עד 1 מ\"מ",
                    "תקנים": "ת\"י 1731",
                },
                application: [
                    "יש ליישם שכבת פריימר ולהמתין 6 שעות לייבוש.",
                    "לבחוש היטב לפני השימוש.",
                    "ליישם באמצעות מאלג' מתכת ולשפשף במאלג' פלסטיק."
                ],
                drying: {
                    "ייבוש למגע": "3-4 שעות",
                    "ייבוש סופי": "72 שעות",
                    "הגבלות": "לא ליישם בטמפ' מתחת ל-7°C או מעל 35°C, או אם צפוי גשם/אבק ב-72 השעות הקרובות."
                },
                calculator: {
                    type: 'coverage_kg',
                    unit: 'דליים',
                    coverage_per_sqm: 2.0,
                    bag_weight_kg: 24
                },
                related_products_ids: [4] // טיח
            },
            {
                id: 6,
                name: "בוש מברגה/מקדחה GSB 185-LI",
                brand: "בוש",
                brand_logo_url: "https://www.ledico.com/wp-content/uploads/2022/12/19K3.100-Ledico.png",
                category: "כלי עבודה",
                description: "מברגה/מקדחה רוטטת נטענת, 18V, קומפקטית עם מנוע ללא פחמים.",
                specs: {
                    "מתח": "18V",
                    "מומנט (רך/קשה)": "21/50 Nm",
                    "מהירות סיבוב": "0-500 / 0-1,900 סל\"ד",
                    "קצב הלימה": "27,000 פל\"ד",
                    "מנוע": "ללא פחמים (Brushless)"
                },
                application: [
                    "הברגת ברגים בעץ עד 10 מ\"מ.",
                    "קידוח בעץ עד 35 מ\"מ, במתכת או בנייה עד 10 מ\"מ."
                ],
                drying: {},
                warranty: "12 חודשים (ניתן להרחיב לשנתיים נוספות ברישום)",
                related_products_ids: [7] // אימפקט
            },
            {
                id: 7,
                name: "מקיטה אימפקט DTD152Z",
                brand: "מקיטה",
                brand_logo_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/7/7b/Makita_logo.svg/320px-Makita_logo.svg.png",
                category: "כלי עבודה",
                description: "מברגת אימפקט 18V חזקה ואמינה לעבודות מאומצות (גוף בלבד).",
                specs: {
                    "מתח": "18V",
                    "מהירות סיבוב": "0-2,900 סל\"ד",
                    "רטיטות לדקה": "0-3,500 פל\"ד",
                    "מומנט פיתול מרבי": "165 Nm",
                    "טכנולוגיה": "XPT - הגנה מאבק ומים"
                },
                application: [
                    "אידיאלית להידוק ברגים, עבודות דק ופרגולות.",
                    "מנגנון אימפקט מפחית את העומס על המשתמש."
                ],
                drying: {},
                warranty: "24 חודשים (יבואן רשמי)",
                related_products_ids: [6] // מברגה/מקדחה
            },
            {
                id: 8,
                name: "טמבור לוח גבס לבן",
                brand: "טמבור",
                brand_logo_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Tambour_logo.svg/320px-Tambour_logo.svg.png",
                category: "מוצרי גבס",
                description: "לוח גבס סטנדרטי לבניית מחיצות, תקרות וחיפויים בבנייה קלה.",
                specs: {
                    "עובי סטנדרטי": "12.7 מ\"מ (זמין בעוביים נוספים)",
                    "מידות": "1200x2600/3000 מ\"מ",
                    "תקנים": "ת\"י 1490, ת\"י 62088, תו ירוק, ISO14001"
                },
                application: [
                    "יש להתקין על קונסטרוקציית פח מגולוון (ניצבים ומסלולים).",
                    "יש להשתמש בברגים ייעודיים לגבס.",
                    "חיבורי הלוחות מטופלים בשפכטל וסרט שריון."
                ],
                drying: {},
                related_products_ids: []
            },
            {
                id: 9,
                name: "תרמוקיר רובה SAKRET JF 930",
                brand: "תרמוקיר",
                brand_logo_url: "https://termokir.co.il/logo.png",
                category: "רובה",
                description: "רובה אקרילית איכותית למילוי מישקים ברוחב 3-10 מ\"מ, סיווג CG2 WA.",
                specs: {
                    "סיווג": "CG2 WA",
                    "חוזק לחיצה (28 יום)": "מעל 15.0 מגפ\"ס",
                    "עמידות לשחיקה": "גבוהה (< 1000 מ\"מ³)",
                    "ספיגות מים": "מופחתת",
                    "תקנים": "ת\"י 1661, ת\"י 1555, תו ירוק, EPD"
                },
                application: [
                    "לערבב עם כ-4 ליטר מים לשק 15 ק\"ג.",
                    "ליישם במאלג' גומי בזווית אלכסונית למישקים.",
                    "לאחר 10-30 דקות, לנקות עודפים עם ספוג לח."
                ],
                drying: {
                    "דריכה קלה": "2-3 שעות",
                    "שימוש רגיל": "48 שעות",
                    "אי-חשיפה למים": "6 שעות לפחות"
                },
                calculator: {
                    type: 'grout_calculator',
                    unit: 'שקים',
                    bag_weight_kg: 15,
                    grout_density_factor: 1.8,
                    default_tile_length_mm: 600,
                    default_tile_width_mm: 600,
                    default_joint_width_mm: 5,
                    default_joint_depth_mm: 10
                },
                related_products_ids: [2,3,19] // דבקים לריצוף, מגב רובה
            },
            {
                id: 10,
                name: "סיקה Sikaflex-11 FC+",
                brand: "סיקה",
                brand_logo_url: "https://gilar.co.il/wp-content/themes/gilar/images/sika.svg",
                category: "איטום",
                description: "דבק-איטום פוליאוריטני רב תכליתי, עמיד בפני תזוזות ותנאי חוץ.",
                specs: {
                    "בסיס כימי": "i-Cure® Technology polyurethane",
                    "גמישות": "גבוהה (±35%)",
                    "עמידות UV": "טובה",
                    "טמפ' יישום": "+5°C עד +40°C"
                },
                application: [
                    "לנקות היטב את המשטח מאבק, שומן ומזהמים.",
                    "ליישם את החומר באמצעות אקדח ייעודי באופן רציף.",
                    "להחליק את החומר תוך 10 דקות מרגע היישום."
                ],
                drying: {
                    "קצב אשפרה": "כ-3 מ\"מ ב-24 שעות",
                    "ייבוש למגע": "כ-70 דקות",
                    "התקשות מלאה": "מספר ימים (תלוי בעובי)"
                },
                warranty: "מוגבל לטיב החומר",
                related_products_ids: [11] // איטום נוסף
            },
            {
                id: 11,
                name: "סיקה SikaTop Seal-107",
                brand: "סיקה",
                brand_logo_url: "https://gilar.co.il/wp-content/themes/gilar/images/sika.svg",
                category: "איטום",
                description: "מערכת איטום צמנטית דו-רכיבית, גמישה במקצת, לאיטום והגנה על בטון.",
                specs: {
                    "סיווג": "CM O2P (EN 1504-2)",
                    "חוזק הידבקות": ">1.0 מגפ\"ס",
                    "כושר גישור סדקים": ">0.75 מ\"מ",
                    "צריכה": "כ-2.0 ק\"ג/מ\"ר/מ\"מ (מומלץ 2 שכבות)"
                },
                application: [
                    "לערבב רכיב A (נוזל) ו-B (אבקה) עד לקבלת תערובת אחידה.",
                    "ליישם שכבה ראשונה במברשת, רולר או התזה.",
                    "להמתין 4-8 שעות וליישם שכבה שנייה בניצב לראשונה."
                ],
                drying: {
                    "בין שכבות": "4-8 שעות",
                    "בדיקת הצפה": "72 שעות לפחות",
                    "מוכנות לחיפוי": "7 ימים"
                },
                calculator: {
                    type: 'coverage_kg',
                    unit: 'יחידות',
                    coverage_per_sqm: 4.0,
                    bag_weight_kg: 20
                },
                related_products_ids: [10, 18, 19] // איטום נוסף, כלי עבודה
            },
            {
                id: 12,
                name: "חמת ברז מטבח נשלף סיטי",
                brand: "חמת",
                brand_logo_url: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRz-S4X7_S4z_D1h-j_z2sS1C2v2g7Qy1y_wQ&s",
                category: "ברזים",
                description: "ברז יוקרתי לכיור מטבח מבית חמת, עיצוב מודרני, פיה נשלפת וגימור ניקל מוברש.",
                specs: {
                    "חומר": "פליז בציפוי כרום/ניקל",
                    "גימור": "ניקל מוברש / כרום / שחור מט",
                    "פיה": "נשלפת עם 2 מצבי זרימה",
                    "מנגנון": "מנגנון ספרדי איכותי",
                    "אחריות": "7 שנים על גוף הברז ומנגנון"
                },
                application: [
                    "ודא שנקודות המים החמים והקרים מוכנות.",
                    "הצב את הברז בחור הייעודי בכיור או במשטח.",
                    "חבר את צינורות הברז לנקודות הממים והדק.",
                    "וודא אטימה מלאה של החיבורים לפני פתיחת זרם הממים הראשי."
                ],
                drying: {},
                related_products_ids: [13] // אינטרפוץ
            },
            {
                id: 13,
                name: "חמת סט אינטרפוץ 4 דרך",
                brand: "חמת",
                brand_logo_url: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRz-S4X7_S4z_D1h-j_z2sS1C2v2g7Qy1y_wQ&s",
                category: "אינסטלציה",
                description: "סט מקלחת יוקרתי הכולל ראש גשם, מזלף ידני, ברז סוללה ואינטרפוץ 4 דרך.",
                specs: {
                    "חומר": "פליז בציפוי כרום",
                    "גימור": "כרום / שחור מט",
                    "ראש גשם": "עגול/מרובע, דק במיוחד",
                    "מזלף": "מספר מצבי זרימה, אנטי אבנית",
                    "אינטרפוץ": "4 דרך, מנגנון קרמי"
                },
                application: [
                    "תכנן את מיקום נקודות הממים ונקז המקלחת בשלב בניית התשתית.",
                    "התקן את יחידת האינטרפוץ בקיר לפי הוראות היצרן.",
                    "חבר את הצנרת לראש הגשם ולמזלף הידני.",
                    "לאחר סיום עבודות החיפוי, הרכב את הפריטים הגלויים."
                ],
                drying: {},
                related_products_ids: [12] // ברז מטבח
            },
            {
                id: 14,
                name: "חול ים (למילוי/בנייה)",
                brand: "כללי",
                brand_logo_url: "", // No specific logo for "general"
                category: "חומרי בניין בצובר",
                description: "חול ים נקי ואיכותי למילוי, יציקות בטון, טיח ותשתיות ריצוף. נמכר בנפח של מעל 0.5 קוב.",
                specs: {
                    "נפח אריזה": "מינימום 0.5 קוב (בלה)",
                    "צבע": "בהיר-אפרפר",
                    "גודל גרגר": "עדין-בינוני (0.2-2 מ\"מ)",
                    "שימוש עיקרי": "מילוי, בטון, טיח, ריצוף"
                },
                application: [
                    "למילוי: פריסה אחידה ושטיחה באמצעות כלים ייעודיים.",
                    "לטיח: ערבוב עם צמנט ומים ליצירת טיט.",
                    "לתשתית ריצוף: פריסה בשכבה אחידה והידוק."
                ],
                drying: {},
                calculator: {
                    type: 'volume_thickness_m3',
                    unit: 'בלות',
                    material_volume_per_sqm_per_mm: 0.001,
                    min_thickness_mm: 50,
                    max_thickness_mm: 300,
                    volume_per_unit: 0.5 // 0.5 קוב לבלה
                },
                related_products_ids: [15,16,17,18] // סומסום, חצץ, טיט, מריצה
            },
            {
                id: 15,
                name: "סומסום (תשתית)",
                brand: "כללי",
                brand_logo_url: "",
                category: "חומרי בניין בצובר",
                description: "סומסום - חצץ דק בגודל 0-4 מ\"מ, אידיאלי לתשתיות ריצוף וניקוז. נמכר בנפח של מעל 0.5 קוב.",
                specs: {
                    "נפח אריזה": "מינימום 0.5 קוב (בלה)",
                    "צבע": "אפור-בז'",
                    "גודל גרגר": "0-4 מ\"מ",
                    "שימוש עיקרי": "תשתית ריצוף, שכבת ניקוז, ייצוב"
                },
                application: [
                    "לפרוס בשכבה אחידה ומהודקת מעל תשתית קיימת.",
                    "להידוק מומלץ שימוש במהדק אדמה (קומפקטור).",
                    "לוודא שיפועים נכונים לניקוז."
                ],
                drying: {},
                calculator: {
                    type: 'volume_thickness_m3',
                    unit: 'בלות',
                    material_volume_per_sqm_per_mm: 0.001,
                    min_thickness_mm: 50,
                    max_thickness_mm: 150,
                    volume_per_unit: 0.5
                },
                related_products_ids: [14,16,17,18] // חול, חצץ, טיט, מריצה
            },
            {
                id: 16,
                name: "חצץ (בטון/ניקוז)",
                brand: "כללי",
                brand_logo_url: "",
                category: "חומרי בניין בצובר",
                description: "חצץ נקי בגדלים שונים, אידיאלי ליציקות בטון, ניקוז ומילוי. נמכר בנפח של מעל 0.5 קוב.",
                specs: {
                    "נפח אריזה": "מינימום 0.5 קוב (בלה)",
                    "צבע": "אפור",
                    "גודל גרגר": "משתנה (לדוגמה 20/40 מ\"מ)",
                    "שימוש עיקרי": "בטון, ניקוז, מילוי, שבילי גישה"
                },
                application: [
                    "ליציקות בטון: ערבוב עם צמנט וחול ביחסים מתאימים.",
                    "לניקוז: פריסה בשכבה עבה בתחתית תעלות או כבסיס.",
                    "למילוי: שימוש למילוי חללים גדולים."
                ],
                drying: {},
                calculator: {
                    type: 'volume_thickness_m3',
                    unit: 'בלות',
                    material_volume_per_sqm_per_mm: 0.001,
                    min_thickness_mm: 100,
                    max_thickness_mm: 500,
                    volume_per_unit: 0.5
                },
                related_products_ids: [14,15,17,18] // חול, סומסום, טיט, מריצה
            },
            {
                id: 17,
                name: "טיט מוכן",
                brand: "כללי",
                brand_logo_url: "",
                category: "חומרי בניין בצובר",
                description: "טיט צמנטי מוכן לשימוש (יבש), מתאים לטיח, ריצוף ובנייה. נמכר בנפח של מעל 0.5 קוב.",
                specs: {
                    "נפח אריזה": "שק 25 ק\"ג / 0.5 קוב (בלה)",
                    "מרכיבים": "צמנט, חול, תוספים",
                    "שימוש עיקרי": "טיח, הדבקה, בניה (בלוקים), מילוי"
                },
                application: [
                    "לערבב עם מים ביחסים המומלצים עד לקבלת עבידות רצויה.",
                    "ליישם במאלג' או בכף בנאים לפי הצורך.",
                    "להקפיד על כיסוי אחיד ויישור."
                ],
                drying: {
                    "זמן שמישות": "כ-2 שעות (לטיט מעורבב)",
                    "ייבוש למגע": "כ-6-12 שעות",
                    "ייבוש סופי": "28 יום (לאשפרה מלאה)"
                },
                calculator: {
                    type: 'coverage_thickness_kg',
                    unit: 'בלות',
                    bag_weight_kg: 25,
                    coverage_per_sqm_per_mm_kg: 1.8,
                    min_thickness_mm: 10,
                    max_thickness_mm: 50,
                    volume_per_unit: 0.5,
                    density_kg_per_m3: 1800
                },
                related_products_ids: [14,15,16,18] // חול, סומסום, חצץ, מריצה
            },
            {
                id: 18,
                name: "מריצה ידנית",
                brand: "כללי",
                brand_logo_url: "",
                category: "כלי עבודה",
                description: "מריצה ידנית חזקה ועמידה, אידיאלית להובלת חומרי בניין באתר.",
                specs: {
                    "חומר": "פלדה מגולוונת / פלסטיק מחוזק",
                    "נפח": "80-120 ליטר",
                    "גלגל": "פניאומטי מחוזק"
                },
                application: ["להובלת חול, חצץ, מלט, פסולת בניין ועוד."],
                drying: {},
                related_products_ids: [14,15,16,17] // חומרי בניין בצובר
            },
            {
                id: 19,
                name: "מגב גומי לרובה",
                brand: "כללי",
                brand_logo_url: "",
                category: "כלי עבודה",
                description: "מגב גומי מקצועי ליישום והחלקת רובה, מונע שריטות ומבטיח מילוי אחיד של המישקים.",
                specs: {
                    "חומר": "ידית פלסטיק, גומי עמיד",
                    "רוחב": "20-25 ס\"מ",
                    "שימוש": "מילוי מישקים ברובה"
                },
                application: [
                    "לאחר מריחת הרובה, יש להחליק את העודפים באמצעות המגב בזווית של 45 מעלות.",
                    "לנקות את המגב לעיתים קרובות."
                ],
                drying: {},
                related_products_ids: [9] // רובה
            }
        ];

        // Store images for the gallery
        const storeImages = [
            { src: 'https://saban94.wordpress.com/wp-content/uploads/2020/01/46453331_572490759853122_8215770119347896320_o.jpg?w=150', alt: 'סניף החרש - תמונה 1', branch: 'החרש' }, // Updated
            { src: 'https://lh3.googleusercontent.com/gps-cs-s/AC9h4nqlBp3hwdZ0DCc5VkRch2XsAFcczEiJpsFv46V298ogtFuufhTcKOgIlKAKc9wu-KP0feUNBzNk7pCO43sZZiw84AAC_ds8tveDgdCR1McM2vDU4BR08jVEcwL7RlqcOejXVbPU-A=s680-w680-h510-rw', alt: 'סניף החרש - תמונה 2', branch: 'החרש' },
            { src: 'https://lh3.googleusercontent.com/gps-cs-s/AC9h4nqGYOwHRxkJvKdNccy5DmQBCfiXazfJUT8tX0Uvlj2GlCNGZNDOytXKoZuxmOzwAiKVnCQbIJ6rnTUNnggzUFNRYHFwaSheBLYJ2T_5ggfpezNXguQyDnjdGLjptEKzoHkWcTy3Vw=s680-w680-h510-rw', alt: 'סניף החרש - תמונה 3', branch: 'החרש' },
            { src: 'https://lh3.googleusercontent.com/p/AF1QipOgVXhXUkM2-v-4mKM7sYlXIG_bu5TWtw01kzRv=s680-w680-h510-rw', alt: 'סניף התלמיד - תמונה 1', branch: 'התלמיד' },
            { src: 'https://lh3.googleusercontent.com/p/AF1QipP-L-0l0QGsJjsiNaC7c7lfUbuJOUs99G22nEc7=s680-w680-h510-rw', alt: 'סניף התלמיד - תמונה 2', branch: 'התלמיד' }, // Updated
            { src: 'https://lh3.googleusercontent.com/p/AF1QipPOMllf9Sy3iXFChJAdOBV6Zzro0wWW-3Twp2ST=s680-w680-h510-rw', alt: 'סניף התלמיד - תמונה 3', branch: 'התלמיד' },
            { src: 'https://lh3.googleusercontent.com/gps-cs-s/AC9h4nqjNHZQhRzSv-K0LQpLxS6SDv78owI1i-fAK8kOa-ict6wdGfvcfuw2y-7LH6_GPOSp7e6t5EsCCj3T2DpTfuJNdd1m3Hb42q-C3t3zR1lrndDUBwCwObeGg9itpVtRpJrIfmIE=s680-w680-h510-rw', alt: 'סניף התלמיד - תמונה 4', branch: 'התלמיד' },
        ];


        const app = document.getElementById('app');
        const productGrid = document.getElementById('productGrid');
        const productModal = document.getElementById('productModal');
        const modalContentWrapper = document.getElementById('modalContentWrapper');
        const cartModal = document.getElementById('cartModal');
        const closeCartModal = document.getElementById('closeCartModal');
        const cartButton = document.getElementById('cartButton');
        const cartCount = document.getElementById('cartCount');
        const cartItemsContainer = document.getElementById('cartItemsContainer');
        const categoryFiltersContainer = document.getElementById('categoryFilters');
        const brandFiltersContainer = document.getElementById('brandFilters');
        const clearFiltersButton = document.getElementById('clearFilters');
        const searchInput = document.getElementById('searchInput');
        const scanBarcodeButton = document.getElementById('scanBarcode');
        const orderForm = document.getElementById('orderForm');
        const customerNameInput = document.getElementById('customerName');
        const customerPhoneInput = document = document.getElementById('customerPhone');
        const orderNotesInput = document.getElementById('orderNotes');

        const projectAdvisorButton = document.getElementById('projectAdvisorButton');
        const projectAdvisorModal = document.getElementById('projectAdvisorModal');
        const closeProjectAdvisorModal = document.getElementById('closeProjectAdvisorModal');
        const getAdvisorAdviceButton = document.getElementById('getAdvisorAdvice');
        const projectAdvisorInput = document.getElementById('projectAdvisorInput');
        const advisorChatHistoryDiv = document.getElementById('advisorChatHistory');
        const advisorLoading = document.getElementById('advisorLoading');

        const showGalleryButton = document.getElementById('showGalleryButton');
        const galleryModal = document.getElementById('galleryModal');
        const closeGalleryModal = document.getElementById('closeGalleryModal');
        const galleryImageContainer = document.getElementById('galleryImageContainer');


        let activeFilters = { category: [], brand: [] };
        let cart = [];
        let currentFilteredProducts = [];
        let currentProductIndexInFilteredList = -1;
        let chatHistory = []; // Stores the full chat conversation

        // Function to fetch image URLs using google_search API (simulated via Gemini)
        async function fetchProductImage(productName, brandName) {
            const query = `${productName} ${brandName} product image URL`;
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [{
                        text: `Perform a web search for an image of "${query}" and return only the direct URL of the first highly relevant image result. Do not return any other text, just the URL. If no relevant URL is found, return "NO_IMAGE_FOUND".`
                    }]
                }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const llmResponse = result.candidates[0].content.parts[0].text.trim();
                    if (llmResponse.startsWith('http') && (llmResponse.endsWith('.jpg') || llmResponse.endsWith('.png') || llmResponse.endsWith('.jpeg') || llmResponse.endsWith('.webp'))) {
                        return llmResponse;
                    }
                }
            } catch (error) {
                console.error("Error fetching image via Gemini API:", error);
            }
            // Fallback to placeholder if no image found or error
            return `https://placehold.co/400x300/E0F2F7/2563EB?text=${encodeURIComponent(productName)}`;
        }

        // Cache for image URLs
        const imageUrlCache = {};

        async function populateProductImages() {
            // First, render with placeholders
            renderProducts(products);

            // Then, fetch images asynchronously and update
            const productCards = document.querySelectorAll('.product-card');
            for (let i = 0; i < products.length; i++) {
                const product = products[i];
                // Only fetch if image is not already set (e.g., from provided data) AND not in cache
                if (!product.image && !imageUrlCache[product.id]) {
                    const imageUrl = await fetchProductImage(product.name, product.brand);
                    imageUrlCache[product.id] = imageUrl;
                    product.image = imageUrl; // Update the product object with fetched image
                    
                    // Update the specific card's image
                    const cardImage = productCards[i]?.querySelector('.product-main-image');
                    if (cardImage) {
                        cardImage.src = imageUrl;
                        cardImage.onerror = null; // Remove onerror to prevent infinite loops if the fetched URL is bad
                    }
                } else if (imageUrlCache[product.id]) { // If in cache, use cached image
                    product.image = imageUrlCache[product.id];
                    const cardImage = productCards[i]?.querySelector('.product-main-image');
                    if (cardImage) {
                        cardImage.src = imageUrlCache[product.id];
                        cardImage.onerror = null;
                    }
                }
            }
        }

        function renderProducts(productsToRender) {
            productGrid.innerHTML = '';
            currentFilteredProducts = productsToRender;
            if (productsToRender.length === 0) {
                productGrid.innerHTML = `<p class="text-center text-gray-500 col-span-full">לא נמצאו מוצרים התואמים את הסינון.</p>`;
                return;
            }
            productsToRender.forEach((product, index) => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.dataset.filteredIndex = index;
                card.innerHTML = `
                    <img src="${product.image || `https://placehold.co/400x300/E0F2F7/2563EB?text=${encodeURIComponent(product.name)}`}" alt="${product.name}" class="w-full h-40 object-cover product-main-image" onerror="this.src='https://placehold.co/400x300/E0F2F7/2563EB?text=Image+Not+Found'">
                    <div class="p-4 flex items-center justify-between">
                        <div>
                            <span class="text-sm text-gray-500">${product.brand}</span>
                            <h3 class="font-bold text-xl mt-1 truncate text-blue-800">${product.name}</h3>
                        </div>
                        ${product.brand_logo_url ? `<img src="${product.brand_logo_url}" alt="${product.brand} logo" class="w-12 h-12 object-contain ml-2" onerror="this.src='https://placehold.co/48x48/CCCCCC/333333?text=Logo'">` : ''}
                    </div>
                `;
                productGrid.appendChild(card);
            });
        }
        
        function createTimeline(dryingData) {
            let html = '<div class="space-y-4">';
            for (const [key, value] of Object.entries(dryingData)) {
                if (value && typeof value === 'string' && value.trim() !== "") {
                     html += `
                        <div class="flex items-center">
                            <span class="w-1/3 text-gray-600 font-semibold">${key}</span>
                            <span class="w-2/3 font-bold text-lg text-blue-800">${value}</span>
                        </div>
                    `;
                }
            }
            html += '</div>';
            return html;
        }

        function createCalculatorHTML(product) {
            if (!product.calculator) return '<p class="text-center text-gray-500">מחשבון כמות אינו זמין עבור מוצר זה.</p>';
            
            const { type, unit, bag_weight_kg, coverage_per_sqm_per_mm_kg, min_thickness_mm, max_thickness_mm, coverage_per_sqm, grout_density_factor, default_tile_length_mm, default_tile_width_mm, default_joint_width_mm, default_joint_depth_mm, material_volume_per_sqm_per_mm, volume_per_unit, density_kg_per_m3 } = product.calculator;

            let inputsHtml = '';
            if (type === 'coverage_thickness_kg' || type === 'volume_thickness_m3') {
                inputsHtml = `
                    <div class="mb-4">
                        <label for="calcArea" class="block text-blue-700 text-sm font-bold mb-2">שטח במ"ר:</label>
                        <input type="number" id="calcArea" value="10" min="0.1" step="0.1" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline border-blue-300">
                    </div>
                    <div class="mb-4">
                        <label for="calcThickness" class="block text-blue-700 text-sm font-bold mb-2">עובי שכבה במ"מ (${min_thickness_mm}-${max_thickness_mm} מומלץ):</label>
                        <input type="number" id="calcThickness" value="${min_thickness_mm}" min="${min_thickness_mm}" step="0.1" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline border-blue-300">
                    </div>
                `;
            } else if (type === 'coverage_kg') {
                inputsHtml = `
                    <div class="mb-4">
                        <label for="calcArea" class="block text-blue-700 text-sm font-bold mb-2">שטח במ"ר:</label>
                        <input type="number" id="calcArea" value="10" min="0.1" step="0.1" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline border-blue-300">
                    </div>`;
            } else if (type === 'grout_calculator') {
                 inputsHtml = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="mb-2 col-span-2">
                            <label for="calcArea" class="block text-blue-700 text-sm font-bold mb-2">שטח ריצוף במ"ר:</label>
                            <input type="number" id="calcArea" value="10" min="0.1" step="0.1" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 border-blue-300">
                        </div>
                        <div class="mb-2">
                            <label for="calcTileLength" class="block text-blue-700 text-sm font-bold mb-2">אורך אריח (מ"מ):</label>
                            <input type="number" id="calcTileLength" value="${default_tile_length_mm}" min="1" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 border-blue-300">
                        </div>
                        <div class="mb-2">
                            <label for="calcTileWidth" class="block text-blue-700 text-sm font-bold mb-2">רוחב אריח (מ"מ):</label>
                            <input type="number" id="calcTileWidth" value="${default_tile_width_mm}" min="1" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 border-blue-300">
                        </div>
                        <div class="mb-2">
                            <label for="calcJointWidth" class="block text-blue-700 text-sm font-bold mb-2">רוחב מישק (מ"מ):</label>
                            <input type="number" id="calcJointWidth" value="${default_joint_width_mm}" min="1" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 border-blue-300">
                        </div>
                        <div class="mb-2">
                            <label for="calcJointDepth" class="block text-blue-700 text-sm font-bold mb-2">עומק מישק (מ"מ):</label>
                            <input type="number" id="calcJointDepth" value="${default_joint_depth_mm}" min="1" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 border-blue-300">
                        </div>
                    </div>`;
            }

            return `
                <div class="p-4">
                    <h3 class="font-bold text-xl mb-4 text-blue-700">מחשבון כמות</h3>
                    ${inputsHtml}
                    <button id="calculateBtn" class="btn-primary w-full mt-4">חשב כמות</button>
                    <div class="mt-4 p-4 bg-white bg-opacity-70 rounded-lg text-center text-xl font-bold text-blue-800 border border-blue-200">
                        <span>הכמות הנדרשת:</span>
                        <span id="calcResult" class="ml-2">הזן נתונים לחישוב</span>
                    </div>
                </div>`;
        }
        
        function attachCalculatorListeners(product) {
            const calculateBtn = document.getElementById('calculateBtn');
            if (!calculateBtn) return;
            
            const calcFunc = () => {
                const { type, unit, bag_weight_kg, coverage_per_sqm_per_mm_kg, coverage_per_sqm, grout_density_factor, volume_per_unit, density_kg_per_m3 } = product.calculator;
                const area = parseFloat(document.getElementById('calcArea')?.value) || 0;
                let resultText = 'אנא הזן ערכים חוקיים.';

                if (type === 'coverage_thickness_kg' || type === 'volume_thickness_m3') {
                    const thickness = parseFloat(document.getElementById('calcThickness')?.value) || 0;
                    if (area > 0 && thickness > 0) {
                        if (type === 'coverage_thickness_kg') {
                            const totalKg = area * thickness * coverage_per_sqm_per_mm_kg;
                            resultText = `${totalKg.toFixed(2)} ק"ג`;
                            if (bag_weight_kg > 0) {
                                if (unit === 'בלות' && density_kg_per_m3 > 0 && volume_per_unit > 0) {
                                    const totalKiloBags = Math.ceil(totalKg / bag_weight_kg);
                                    const totalVolume = (totalKg / density_kg_per_m3);
                                    const totalBaleBags = Math.ceil(totalVolume / volume_per_unit);
                                    resultText += ` (כ-${totalKiloBags} שקים או ${totalBaleBags} בלות)`;
                                } else {
                                     const numBags = Math.ceil(totalKg / bag_weight_kg);
                                     resultText += ` (כ-${numBags} ${unit})`;
                                }
                            }
                        } else { // volume_thickness_m3
                            const totalCubicMeters = area * thickness * 0.001;
                            resultText = `${totalCubicMeters.toFixed(3)} קוב`;
                             if (volume_per_unit > 0) {
                                const numUnits = Math.ceil(totalCubicMeters / volume_per_unit);
                                resultText += ` (כ-${numUnits} ${unit})`;
                            }
                        }
                    }
                } else if (type === 'coverage_kg') {
                    if (area > 0) {
                        const totalKg = area * coverage_per_sqm;
                        resultText = `${totalKg.toFixed(2)} ק"ג`;
                        if (bag_weight_kg > 0) {
                            const numBags = Math.ceil(totalKg / bag_weight_kg);
                            resultText += ` (כ-${numBags} ${unit})`;
                        }
                    }
                } else if (type === 'grout_calculator') {
                    const tileLength = parseFloat(document.getElementById('calcTileLength').value) || 0;
                    const tileWidth = parseFloat(document.getElementById('calcTileWidth').value) || 0;
                    const jointWidth = parseFloat(document.getElementById('calcJointWidth').value) || 0;
                    const jointDepth = parseFloat(document.getElementById('calcJointDepth').value) || 0;
                    if (area > 0 && tileLength > 0 && tileWidth > 0 && jointWidth > 0 && jointDepth > 0) {
                        const groutPerSqm = ((tileLength + tileWidth) * jointWidth * jointDepth * grout_density_factor) / (tileLength * tileWidth);
                        const totalGroutKg = area * groutPerSqm;
                        resultText = `${totalGroutKg.toFixed(2)} ק"ג`;
                        if (bag_weight_kg > 0) {
                            const numBags = Math.ceil(totalGroutKg / bag_weight_kg);
                            resultText += ` (כ-${numBags} ${unit})`;
                        }
                    }
                }
                document.getElementById('calcResult').textContent = resultText;
            };

            calculateBtn.onclick = calcFunc;
            const inputs = productModal.querySelectorAll('#tab-calculator input');
            inputs.forEach(input => input.addEventListener('input', calcFunc));
            calcFunc();
        }

        function openProductModal(filteredIndex) {
            currentProductIndexInFilteredList = filteredIndex;
            const product = currentFilteredProducts[filteredIndex];
            if (!product) return;
            
            const modalContentWrapper = document.getElementById('modalContentWrapper');
            modalContentWrapper.innerHTML = `
                <div class="modal-content">
                    <header class="p-6 border-b border-white border-opacity-40 flex justify-between items-start">
                        <div>
                            <span class="text-lg text-gray-600 flex items-center">
                                ${product.brand_logo_url ? `<img src="${product.brand_logo_url}" alt="${product.brand} logo" class="w-8 h-8 object-contain mr-2" onerror="this.src='https://placehold.co/32x32/CCCCCC/333333?text=Logo'">` : ''}
                                ${product.brand}
                            </span>
                            <h2 class="text-4xl font-bold text-blue-800">${product.name}</h2>
                        </div>
                        <button id="closeModal" class="text-4xl font-bold text-gray-500 hover:text-red-500 transition-colors">&times;</button>
                    </header>
                    <div class="flex flex-col md:flex-row flex-grow overflow-hidden">
                        <div class="w-full md:w-2/5 p-6">
                             <img src="${product.image || `https://placehold.co/400x300/E0F2F7/2563EB?text=${encodeURIComponent(product.name)}`}" alt="${product.name}" class="rounded-2xl shadow-lg w-full object-cover" onerror="this.src='https://placehold.co/400x300/E0F2F7/2563EB?text=Image+Not+Found'">
                             <p class="mt-4 text-gray-700">${product.description}</p>
                             ${product.warranty ? `<div class="mt-4 p-3 bg-white bg-opacity-70 rounded-lg text-center border border-blue-100"><p class="font-bold text-blue-700">אחריות: ${product.warranty}</p></div>` : ''}
                        </div>
                        <div class="w-full md:w-3/5 flex flex-col">
                            <nav id="modalTabs" class="border-b border-blue-200 flex-shrink-0 flex">
                                <button data-tab="tab-specs" class="tab-button active">מפרט טכני</button>
                                <button data-tab="tab-application" class="tab-button">הוראות יישום</button>
                                ${Object.keys(product.drying).length > 0 ? `<button data-tab="tab-drying" class="tab-button">זמני ייבוש</button>` : ''}
                                ${product.calculator ? `<button data-tab="tab-calculator" class="tab-button">מחשבון כמות</button>` : ''}
                            </nav>
                            <div class="p-6 overflow-y-auto flex-grow">
                                <div id="tab-specs" class="tab-content">
                                     <h3 class="font-bold text-xl mb-4 text-blue-700">מפרט טכני מלא</h3>
                                     <div class="space-y-2">
                                        ${Object.entries(product.specs).map(([key, value]) => `
                                            <div class="flex border-b border-blue-100 py-3">
                                                <strong class="w-1/3 text-gray-600">${key}</strong>
                                                <span class="w-2/3 text-blue-800 font-semibold">${value}</span>
                                            </div>`).join('')}
                                     </div>
                                </div>
                                <div id="tab-application" class="tab-content hidden">
                                    <h3 class="font-bold text-xl mb-4 text-blue-700">הוראות יישום</h3>
                                    <ol class="list-decimal pr-5 space-y-3 text-blue-800">
                                        ${product.application.map(step => `<li>${step}</li>`).join('')}
                                    </ol>
                                </div>
                                <div id="tab-drying" class="tab-content hidden">
                                    <h3 class="font-bold text-xl mb-4 text-blue-700">זמני ייבוש ואשפרה</h3>
                                    ${createTimeline(product.drying)}
                                </div>
                                <div id="tab-calculator" class="tab-content hidden">
                                    ${createCalculatorHTML(product)}
                                </div>
                            </div>
                        </div>
                    </div>
                     <footer class="p-4 bg-white bg-opacity-70 border-t border-white border-opacity-40 flex justify-between items-center">
                        <button id="prevProduct" class="btn-secondary ${currentProductIndexInFilteredList === 0 ? 'opacity-50 cursor-not-allowed' : ''}">⬅️ קודם</button>
                        <button id="addToCart" data-product-id="${product.id}" class="btn-primary">הוסף להזמנה</button>
                        <button id="nextProduct" class="btn-secondary ${currentProductIndexInFilteredList === currentFilteredProducts.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}">הבא ➡️</button>
                    </footer>
                </div>
            `;
            
            productModal.classList.remove('hidden');

            document.getElementById('closeModal').addEventListener('click', () => productModal.classList.add('hidden'));
            
            document.getElementById('addToCart').addEventListener('click', (e) => {
                const productId = e.target.dataset.productId;
                addToCart(productId);
                productModal.classList.add('hidden');
            });

            document.getElementById('prevProduct').addEventListener('click', () => {
                if (currentProductIndexInFilteredList > 0) openProductModal(currentProductIndexInFilteredList - 1);
            });
            document.getElementById('nextProduct').addEventListener('click', () => {
                if (currentProductIndexInFilteredList < currentFilteredProducts.length - 1) openProductModal(currentProductIndexInFilteredList + 1);
            });

            const tabs = productModal.querySelectorAll('.tab-button');
            const tabContents = productModal.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    tabContents.forEach(content => content.classList.add('hidden'));
                    document.getElementById(tab.dataset.tab).classList.remove('hidden');
                });
            });
            
            if (product.calculator) {
                attachCalculatorListeners(product);
            }
        }
        
        function setupFilters() {
            const categories = [...new Set(products.map(p => p.category))];
            const brands = [...new Set(products.map(p => p.brand))];

            categoryFiltersContainer.innerHTML = categories.map(category => `
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" data-filter="category" value="${category}" class="form-checkbox h-5 w-5 text-blue-600 rounded border-gray-400 focus:ring-blue-600">
                    <span class="mr-3 text-blue-800 font-bold">${category}</span>
                </label>
            `).join('');

            brandFiltersContainer.innerHTML = brands.map(brand => `
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" data-filter="brand" value="${brand}" class="form-checkbox h-5 w-5 text-blue-600 rounded border-gray-400 focus:ring-blue-600">
                    <span class="mr-3 text-blue-800 font-bold">${brand}</span>
                </label>
            `).join('');
            
            document.querySelectorAll('#filters input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', applyFilters);
            });
        }
        
        function applyFilters() {
            const selectedCategories = Array.from(document.querySelectorAll('input[data-filter="category"]:checked')).map(cb => cb.value);
            const selectedBrands = Array.from(document.querySelectorAll('input[data-filter="brand"]:checked')).map(cb => cb.value);
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            let filteredProducts = products.filter(product => {
                const categoryMatch = selectedCategories.length === 0 || selectedCategories.includes(product.category);
                const brandMatch = selectedBrands.length === 0 || selectedBrands.includes(product.brand);
                const searchMatch = searchTerm === '' || product.name.toLowerCase().includes(searchTerm) || product.brand.toLowerCase().includes(searchTerm) || product.description.toLowerCase().includes(searchTerm);
                return categoryMatch && brandMatch && searchMatch;
            });
            renderProducts(filteredProducts);
        }

        function clearFilters() {
            document.querySelectorAll('#filters input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
            searchInput.value = '';
            applyFilters();
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === parseInt(productId));
            const existingItem = cart.find(item => item.id === product.id);

            if (existingItem) existingItem.quantity++;
            else cart.push({ ...product, quantity: 1 });
            
            updateCart();
        }

        function updateCart() {
            const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
            cartCount.textContent = totalItems;
            cartCount.classList.toggle('hidden', totalItems === 0);
            renderCartItems();
        }
        
        function renderCartItems() {
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = `<p class="text-center text-gray-500 py-8">עגלת ההזמנות ריקה.</p>`;
                return;
            }
            cartItemsContainer.innerHTML = `
                <div class="space-y-4">
                    ${cart.map(item => `
                        <div class="flex items-center justify-between p-3 border-b border-gray-200 bg-white bg-opacity-70 rounded-lg">
                            <div class="flex items-center">
                                <img src="${item.image || `https://placehold.co/100x100/E0F2F7/2563EB?text=img`}" class="w-16 h-16 rounded-lg object-cover mr-4" onerror="this.src='https://placehold.co/100x100/E0F2F7/2563EB?text=Image+Not+Found'">
                                <div>
                                    <p class="font-bold text-blue-800">${item.name}</p>
                                    <p class="text-sm text-gray-500">${item.brand}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4 space-x-reverse">
                                 <button class="quantity-change font-bold text-lg text-blue-600 hover:text-blue-800" data-id="${item.id}" data-change="-1">-</button>
                                 <span class="font-semibold text-lg text-blue-800">${item.quantity}</span>
                                 <button class="quantity-change font-bold text-lg text-blue-600 hover:text-blue-800" data-id="${item.id}" data-change="1">+</button>
                                 <button class="remove-item text-red-500 hover:text-red-700" data-id="${item.id}">🗑️</button>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        }

        function handleCartInteraction(e) {
            const target = e.target.closest('button');
            if (!target) return;

            const id = parseInt(target.dataset.id);
            const item = cart.find(i => i.id === id);

            if (target.classList.contains('quantity-change')) {
                const change = parseInt(target.dataset.change);
                if (item) {
                    item.quantity += change;
                    if (item.quantity <= 0) cart = cart.filter(i => i.id !== id);
                }
            } else if (target.classList.contains('remove-item')) {
                 cart = cart.filter(i => i.id !== id);
            }
            updateCart();
        }

        productGrid.addEventListener('click', (e) => {
            const card = e.target.closest('.product-card');
            if (card) {
                const filteredIndex = parseInt(card.dataset.filteredIndex);
                openProductModal(filteredIndex);
            }
        });
        
        cartButton.addEventListener('click', () => cartModal.classList.remove('hidden'));
        closeCartModal.addEventListener('click', () => cartModal.classList.add('hidden'));

        projectAdvisorButton.addEventListener('click', () => {
            projectAdvisorModal.classList.remove('hidden');
            advisorChatHistoryDiv.scrollTop = advisorChatHistoryDiv.scrollHeight; // Scroll to bottom
            renderChatHistory(); // Ensure chat history is rendered on open
        });
        closeProjectAdvisorModal.addEventListener('click', () => {
            projectAdvisorModal.classList.add('hidden');
            clearInterval(typingInterval); // Stop any ongoing typing effect
        });

        scanBarcodeButton.addEventListener('click', () => {
            const barcode = prompt("אנא סרוק או הקלד ברקוד:");
            if (barcode) {
                const product = products.find(p => p.id.toString() === barcode.trim());
                if (product) {
                    const indexInFullList = products.indexOf(product);
                    currentFilteredProducts = products;
                    openProductModal(indexInFullList);
                } else {
                    // Using a custom alert-like message instead of window.alert
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-500 text-white p-4 rounded-lg shadow-xl z-[9999]';
                    msgDiv.textContent = `מוצר עם ברקוד ${barcode} לא נמצא.`;
                    document.body.appendChild(msgDiv);
                    setTimeout(() => msgDiv.remove(), 3000);
                }
            }
        });
        
        orderForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if(cart.length === 0) {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-500 text-white p-4 rounded-lg shadow-xl z-[9999]';
                msgDiv.textContent = "עגלת ההזמנות ריקה. לא ניתן לשלוח בקשה.";
                document.body.appendChild(msgDiv);
                setTimeout(() => msgDiv.remove(), 3000);
                return;
            }

            const customerName = customerNameInput.value.trim();
            const customerPhone = customerPhoneInput.value.trim();
            const orderNotes = orderNotesInput.value.trim();

            let whatsappMessage = `*הזמנה חדשה מח.סבן חומרי בניין*\n\n`;
            whatsappMessage += `*פרטי לקוח:*\n`;
            whatsappMessage += `שם: ${customerName}\n`;
            whatsappMessage += `טלפון: ${customerPhone}\n\n`;
            
            whatsappMessage += `*פרטי הזמנה:*\n`;
            cart.forEach(item => {
                whatsappMessage += `- ${item.name} (מותג: ${item.brand}), כמות: ${item.quantity}\n`;
            });

            if (orderNotes) {
                whatsappMessage += `\n*הערות נוספות:*\n${orderNotes}\n`;
            }

            const whatsappUrl = `https://wa.me/972508860896?text=${encodeURIComponent(whatsappMessage)}`;
            
            window.open(whatsappUrl, '_blank');

            const msgDiv = document.createElement('div');
            msgDiv.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white p-4 rounded-lg shadow-xl z-[9999]';
            msgDiv.textContent = "הבקשה להזמנה נשלחה בהצלחה לוואטסאפ! נציג ייצור עמך קשר בהקדם.";
            document.body.appendChild(msgDiv);
            setTimeout(() => msgDiv.remove(), 3000);

            cart = [];
            updateCart();
            orderForm.reset();
            cartModal.classList.add('hidden');
        });

        // Function to call Gemini API
        async function getLLMResponse(chatHistoryData) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const payload = { contents: chatHistoryData };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("LLM response structure unexpected:", result);
                    return "אירעה שגיאה בקבלת הייעוץ. נסה שוב מאוחר יותר. 😔";
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return "אירעה שגיאה ברשת או בשרת. אנא נסה שוב. 🌐";
            }
        }

        let currentTypingIndex = 0;
        let fullAdvisorResponseText = "";
        let typingInterval;

        function typeAdvisorResponse(element, text, callback = () => {}) {
            fullAdvisorResponseText = text;
            currentTypingIndex = 0;
            element.innerHTML = ""; // Use innerHTML to allow markdown
            clearInterval(typingInterval);
            typingInterval = setInterval(() => {
                if (currentTypingIndex < fullAdvisorResponseText.length) {
                    element.innerHTML = marked.parse(fullAdvisorResponseText.substring(0, currentTypingIndex + 1));
                    currentTypingIndex++;
                    advisorChatHistoryDiv.scrollTop = advisorChatHistoryDiv.scrollHeight; // Keep scrolling
                } else {
                    clearInterval(typingInterval);
                    callback();
                }
            }, 30); // Typing speed
        }

        function addMessageToChat(role, text, options = {}) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            advisorChatHistoryDiv.appendChild(messageDiv);

            if (role === 'ai') {
                typeAdvisorResponse(messageDiv, text, () => {
                    if (options.showOptions) {
                         addChatOptions(messageDiv, text);
                    }
                    if (options.relatedProducts && options.relatedProducts.length > 0) {
                        displayRelatedProductsInChat(advisorChatHistoryDiv, options.relatedProducts);
                    }
                });
            } else {
                messageDiv.innerHTML = marked.parse(text); // For user messages, directly parse markdown if any
            }
            advisorChatHistoryDiv.scrollTop = advisorChatHistoryDiv.scrollHeight;
        }

        function addChatOptions(messageDiv, responseText) {
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'chat-options-container';
            messageDiv.appendChild(optionsContainer);

            // Try to identify a product mentioned in the last AI response
            const productNameMatch = responseText.match(/מוצר (.+?) מומלץ/); // Simple regex to find product name
            const productName = productNameMatch ? productNameMatch[1].trim() : null;
            let product = null;
            if (productName) {
                product = products.find(p => p.name.includes(productName) || productName.includes(p.name));
            }
            
            if (product) {
                const expandButton = document.createElement('button');
                expandButton.className = 'chat-option-button';
                expandButton.textContent = `הרחב על ${product.name} 📚`;
                expandButton.onclick = () => {
                    addMessageToChat('user', `הרחב על ${product.name}`);
                    getAdvisorAdviceForProduct(product.id, 'expand');
                    optionsContainer.remove(); // Remove options after selection
                };
                optionsContainer.appendChild(expandButton);

                if (product.related_products_ids && product.related_products_ids.length > 0) {
                    const relatedButton = document.createElement('button');
                    relatedButton.className = 'chat-option-button';
                    relatedButton.textContent = `מוצרים נלווים ל ${product.name} 🛠️`;
                    relatedButton.onclick = () => {
                        addMessageToChat('user', `מוצרים נלווים ל ${product.name}`);
                        getAdvisorAdviceForProduct(product.id, 'related');
                        optionsContainer.remove(); // Remove options after selection
                    };
                    optionsContainer.appendChild(relatedButton);
                }
            }
        }

        async function getAdvisorAdviceForProduct(productId, type) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                addMessageToChat('ai', "מצטער, לא מצאתי מידע על המוצר המבוקש. 🤔");
                return;
            }

            advisorLoading.classList.remove('hidden');
            let prompt = "";
            let relatedProductsToShow = [];

            if (type === 'expand') {
                prompt = `הרחב בבקשה את המידע על המוצר ${product.name} (מותג: ${product.brand}, קטגוריה: ${product.category}). ציין מפרט טכני, הוראות יישום וזמני ייבוש בצורה מסודרת, יחד עם אימוג'י רלוונטי. הצג את המפרט בטבלה.`;
            } else if (type === 'related') {
                const relatedProductNames = product.related_products_ids
                    .map(id => products.find(p => p.id === id)?.name)
                    .filter(name => name);
                
                let relatedProductsText = relatedProductNames.length > 0 ? relatedProductNames.join(', ') : "אין מידע זמין על מוצרים נלווים ספציפיים בקטלוג.";
                
                prompt = `הצג לי מוצרים נלווים למוצר ${product.name} (מותג: ${product.brand}). בנוסף למוצרים מהקטלוג, הצע גם כלים חיוניים ספציפיים שנדרשים ליישום מוצר זה. ספק תשובה תמציתית עם אימוג'י. רשימת מוצרים נלווים ידועים: ${relatedProductsText}.`;
                
                // Collect product objects for display in chat
                relatedProductsToShow = product.related_products_ids.map(id => products.find(p => p.id === id)).filter(p => p);
            }

            const systemPrompt = `אתה יועץ מוצר מתקדם ומומחה לחומרי בניין מטעם ח.סבן חומרי בניין. ענה על שאלות המשתמש בצורה מקצועית, מפורטת ומדויקת, כאילו אתה מומחה בעל ידע עמוק בתחום.
            * **דיוק ותמצות**: ענה על השאלה בתמציתיות ובדיוק תחילה.
            * **שאלות המשך**: לאחר מתן התשובה התמציתית (אלא אם כן זו הרחבה), שאל את המשתמש האם ירצה להרחיב בפרטים נוספים על המוצר המומלץ או לראות מוצרים נלווים. לדוגמה: "האם תרצה להרחיב בפרטים נוספים על [שם המוצר] או לראות מוצרים נלווים? 💡".
            * **נתונים ספציפיים**: במידת הרלוונטיות, התייחס לסוגי חומרים וכלים ספציפיים מהקטלוג שלנו (תרמוקיר, סיקה, בוש, מקיטה, חמת, טיח, איטום, דבקים, רובה, כלי עבודה, גבס, חומרי צובר).
            * **פרויקטים**: אם השאלה עוסקת בפרויקט, ספק שלבים כלליים או טיפים חשובים לביצוע.
            * **שילוב מידע על ח.סבן**: "ח.סבן חומרי בניין היא חברה ותיקה ומובילה בתחום חומרי הבניין בישראל. אנו מציעים מגוון רחב של מוצרים וכלים ממיטב המותגים. לחברה מספר סניפים ברחבי הארץ, עם מחלקות ייעודיות לטיח, איטום, אינסטלציה, כלי עבודה, גבס וחומרי צובר. אנו מספקים שירותי הובלה יעילים עד אתר הלקוח."
            * **שילוב אימוג'י**: הוסף אימוג'י רלוונטי וממחיש לתשובה.
            * **פורמט טבלאי**: אם התשובה כוללת השוואה או רשימה של נתונים, הצג אותם בפורמט של טבלה (באמצעות Markdown).
            * **זיהוי מוצרים קטלוגיים**: נסה לזהות שמות מוצרים מהקטלוג כדי להציע קישורים או פרטים נוספים.
            * **מוצרים נלווים ספציפיים**: כאשר המשתמש מבקש "מוצרים נלווים" למוצר מסוים (לדוגמה: SikaTop Seal-107), נסה להציע גם כלים ספציפיים (כגון מברשת זפת או רולר ליישום, כפפות, דלי ערבוב) בנוסף למוצרי עזר אחרים.

            תשובתך צריכה להיות בעברית בלבד.`;

            const currentChatHistory = [...chatHistory]; // Copy current history
            currentChatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const llmResponse = await getLLMResponse(currentChatHistory);
            
            advisorLoading.classList.add('hidden');
            addMessageToChat('ai', llmResponse, { showOptions: (type === 'expand' || type === 'related') ? false : true, relatedProducts: relatedProductsToShow });
            chatHistory.push({ role: "model", parts: [{ text: llmResponse }] });
        }


        function displayRelatedProductsInChat(container, relatedProducts) {
            if (relatedProducts.length === 0) return;

            const relatedDiv = document.createElement('div');
            relatedDiv.className = 'flex flex-wrap gap-4 mt-4 justify-start'; // Align items to start

            relatedProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'w-32 bg-white bg-opacity-80 rounded-lg shadow p-2 text-center text-sm border border-blue-100 cursor-pointer hover:bg-blue-50 transition-colors';
                productCard.onclick = () => openProductModal(products.indexOf(product)); // Open product modal
                productCard.innerHTML = `
                    <img src="${product.image || `https://placehold.co/100x75/E0F2F7/2563EB?text=img`}" alt="${product.name}" class="w-full h-20 object-cover rounded mb-2" onerror="this.src='https://placehold.co/100x75/E0F2F7/2563EB?text=Image+Not+Found'">
                    <p class="font-bold text-blue-800 truncate">${product.name}</p>
                    <p class="text-gray-600">${product.brand}</p>
                `;
                relatedDiv.appendChild(productCard);
            });
            container.appendChild(relatedDiv);
            container.scrollTop = container.scrollHeight;
        }


        // Event listener for the "Get Advice" button in Project Advisor Modal
        getAdvisorAdviceButton.addEventListener('click', async () => {
            const userQuery = projectAdvisorInput.value.trim();

            if (!userQuery) {
                addMessageToChat('ai', "אנא הזן את הפרויקט שלך או שאלה. 🧐");
                return;
            }

            addMessageToChat('user', userQuery);
            chatHistory.push({ role: "user", parts: [{ text: userQuery }] });
            projectAdvisorInput.value = ""; // Clear input after sending

            // Show loading indicator
            advisorLoading.classList.remove('hidden');

            const systemPrompt = `אתה יועץ מוצר מתקדם ומומחה לחומרי בניין מטעם ח.סבן חומרי בניין. ענה על שאלות המשתמש בצורה מקצועית, מפורטת ומדויקת, כאילו אתה מומחה בעל ידע עמוק בתחום.
            * **דיוק ותמצות**: ענה על השאלה בתמציתיות ובדיוק תחילה.
            * **שאלות המשך**: לאחר מתן התשובה התמציתית, שאל את המשתמש האם ירצה להרחיב בפרטים נוספים על המוצר המומלץ או לראות מוצרים נלווים. לדוגמה: "האם תרצה להרחיב בפרטים נוספים על [שם המוצר] או לראות מוצרים נלווים? 💡".
            * **נתונים ספציפיים**: במידת הרלוונטיות, התייחס לסוגי חומרים וכלים ספציפיים מהקטלוג שלנו (תרמוקיר, סיקה, בוש, מקיטה, חמת, טיח, איטום, דבקים, רובה, כלי עבודה, גבס, חומרי צובר).
            * **פרויקטים**: אם השאלה עוסקת בפרויקט, ספק שלבים כלליים או טיפים חשובים לביצוע.
            * **שילוב מידע על ח.סבן**: "ח.סבן חומרי בניין היא חברה ותיקה ומובילה בתחום חומרי הבניין בישראל. אנו מציעים מגוון רחב של מוצרים וכלים ממיטב המותגים. לחברה מספר סניפים ברחבי הארץ, עם מחלקות ייעודיות לטיח, איטום, אינסטלציה, כלי עבודה, גבס וחומרי צובר. אנו מספקים שירותי הובלה יעילים עד אתר הלקוח."
            * **שילוב אימוג'י**: הוסף אימוג'י רלוונטי וממחיש לתשובה.
            * **פורמט טבלאי**: אם התשובה כוללת השוואה או רשימה של נתונים, הצג אותם בפורמט של טבלה (באמצעות Markdown).
            * **זיהוי מוצרים קטלוגיים**: נסה לזהות שמות מוצרים מהקטלוג כדי להציע קישורים או פרטים נוספים.
            * **מוצרים נלווים ספציפיים**: כאשר המשתמש מבקש "מוצרים נלווים" למוצר מסוים (לדוגמה: SikaTop Seal-107), נסה להציע גם כלים ספציפיים (כגון מברשת זפת או רולר ליישום, כפפות, דלי ערבוב) בנוסף למוצרי עזר אחרים.

            תשובתך צריכה להיות בעברית בלבד.`;

            const fullPrompt = [
                { role: "user", parts: [{ text: systemPrompt }] },
                ...chatHistory // Append previous chat messages
            ];

            const llmResponse = await getLLMResponse(fullPrompt);
            
            // Hide loading indicator
            advisorLoading.classList.add('hidden');
            addMessageToChat('ai', llmResponse, { showOptions: true }); // Show options after initial response
            chatHistory.push({ role: "model", parts: [{ text: llmResponse }] }); // Add AI response to history
        });

        clearFiltersButton.addEventListener('click', clearFilters);
        searchInput.addEventListener('input', applyFilters);
        cartItemsContainer.addEventListener('click', handleCartInteraction);

        // --- Gallery Modal Logic ---
        function renderGalleryImages(filterBranch = 'all') {
            galleryImageContainer.innerHTML = '';
            const imagesToDisplay = filterBranch === 'all' ? storeImages : storeImages.filter(img => img.branch === filterBranch);

            if (imagesToDisplay.length === 0) {
                galleryImageContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full">אין תמונות זמינות עבור סניף זה.</p>`;
                return;
            }

            imagesToDisplay.forEach(image => {
                const imgCard = document.createElement('div');
                imgCard.className = 'gallery-image-card';
                imgCard.innerHTML = `
                    <img src="${image.src}" alt="${image.alt}" onerror="this.src='https://placehold.co/600x400/E0F2F7/2563EB?text=תמונה+לא+נמצאה'">
                    <p class="p-2 text-sm font-semibold text-blue-800">${image.alt}</p>
                `;
                galleryImageContainer.appendChild(imgCard);
            });
        }

        showGalleryButton.addEventListener('click', () => {
            galleryModal.classList.remove('hidden');
            renderGalleryImages('all'); // Show all by default
            document.querySelectorAll('.active-filter-btn').forEach(btn => btn.classList.remove('active-filter-btn'));
            document.querySelector('[data-branch-filter="all"]').classList.add('active-filter-btn');
        });

        closeGalleryModal.addEventListener('click', () => {
            galleryModal.classList.add('hidden');
        });

        galleryModal.querySelectorAll('.btn-secondary[data-branch-filter]').forEach(button => {
            button.addEventListener('click', (e) => {
                const branch = e.target.dataset.branchFilter;
                renderGalleryImages(branch);
                galleryModal.querySelectorAll('.active-filter-btn').forEach(btn => btn.classList.remove('active-filter-btn'));
                e.target.classList.add('active-filter-btn');
            });
        });
        // --- End Gallery Modal Logic ---


        // Typing effect for search placeholder
        const placeholderText = "חיפוש לפי שם, מותג, תיאור...";
        let i = 0;
        function typeWriter() {
            if (i < placeholderText.length) {
                searchInput.placeholder = placeholderText.substring(0, i + 1);
                i++;
                setTimeout(typeWriter, 80);
            } else {
                 searchInput.placeholder += "|";
                 setInterval(() => {
                    const placeholder = searchInput.placeholder;
                    if (placeholder.endsWith('|')) {
                        searchInput.placeholder = placeholder.slice(0, -1);
                    } else {
                        searchInput.placeholder += '|';
                    }
                 }, 500);
            }
        }

        // Load marked.js for Markdown parsing in chat responses
        const markedScript = document.createElement('script');
        markedScript.src = "https://cdn.jsdelivr.net/npm/marked/marked.min.js";
        markedScript.onload = () => {
             // After marked.js is loaded, set up the renderer
            const renderer = {
                table(header, body) {
                    return `<table class="min-w-full"><thead>${header}</thead><tbody>${body}</tbody></table>`;
                },
                tablerow(content) {
                    return `<tr>${content}</tr>`;
                },
                tablecell(content, flags) {
                    const tag = flags.header ? 'th' : 'td';
                    return `<${tag}>${content}</${tag}>`;
                },
                strong(text) {
                    return `<strong>${text}</strong>`;
                },
                paragraph(text) {
                    return `<p class="mb-2">${text}</p>`;
                }
            };

            if (typeof marked !== 'undefined' && typeof marked.use === 'function') {
                marked.use({ renderer });
            } else if (typeof marked !== 'undefined' && typeof marked.Renderer !== 'undefined') {
                const defaultRenderer = new marked.Renderer();
                for (const prop in renderer) {
                    if (renderer.hasOwnProperty(prop)) {
                        defaultRenderer[prop] = renderer[prop];
                    }
                }
                marked.setOptions({ renderer: defaultRenderer });
            } else {
                console.warn("Marked.js is not loaded or is an unsupported version. Markdown rendering might not work as expected.");
            }
             // Initial render of chat history after marked.js is ready
            projectAdvisorModal.addEventListener('transitionend', () => {
                if (!projectAdvisorModal.classList.contains('hidden')) {
                    renderChatHistory();
                }
            }, { once: true }); // Only run once per open
        };
        document.head.appendChild(markedScript);

        // Initialize chat history display when modal opens
        function renderChatHistory() {
            advisorChatHistoryDiv.innerHTML = '';
            // Add initial welcome message only if chat history is empty
            if (chatHistory.length === 0) {
                const initialMessageDiv = document.createElement('div');
                initialMessageDiv.className = 'chat-message ai';
                initialMessageDiv.textContent = 'שלום! אני יועץ המוצר המתקדם של ח.סבן חומרי בניין. איך אוכל לעזור לך היום? 😊';
                advisorChatHistoryDiv.appendChild(initialMessageDiv);
            } else {
                chatHistory.forEach(msg => {
                    if (msg.role !== 'system') { // Don't render the system prompt
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${msg.role}`;
                        messageDiv.innerHTML = marked.parse(msg.parts[0].text);
                        advisorChatHistoryDiv.appendChild(messageDiv);
                    }
                });
            }
            advisorChatHistoryDiv.scrollTop = advisorChatHistoryDiv.scrollHeight;
        }


        document.addEventListener('DOMContentLoaded', async () => {
            await populateProductImages(); // Fetch and set images
            setupFilters();
            updateCart();
            typeWriter();
            renderChatHistory(); // Render initial chat history
            renderGalleryImages('all'); // Initial render of gallery
        });

    </script>
</body>
</html>
