<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×§×˜×œ×•×’ ×¤×¨×™××™×•× ××™× ×˜×¨××§×˜×™×‘×™ - ×—.×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background: linear-gradient(to bottom right, #e0f2f7, #ffffff); /* Light blue to white gradient */
            color: #1a202c; /* Darker text for contrast */
            overflow-x: hidden; /* Prevent horizontal scroll due to animations */
        }
        .main-container {
            direction: rtl;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .btn-primary {
            @apply bg-gradient-to-br from-blue-500 to-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105;
        }
        .btn-secondary {
            @apply bg-white bg-opacity-80 text-blue-700 font-bold py-2 px-6 rounded-full border border-blue-300 hover:bg-blue-100 transition-all duration-300;
        }
        .product-card {
            @apply bg-white bg-opacity-90 rounded-2xl shadow-lg overflow-hidden transform hover:-translate-y-2 transition-transform duration-300 cursor-pointer border border-blue-100;
        }
        .product-card:hover {
             box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
             border-color: #90CAF9; /* Subtle highlight on hover */
        }

        /* Modal specific styles for animation and centering */
        .modal {
            @apply fixed inset-0 flex items-center justify-center p-4 z-50;
            background: rgba(0, 0, 0, 0.5);
            transition: opacity 0.4s ease-in-out;
        }
        .modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-content-wrapper {
            transition: all 0.5s cubic-bezier(0.25, 0.8, 0.25, 1); /* Slightly longer transition */
            transform: scale(0.8) translateY(20px); /* Start slightly smaller and lower */
            opacity: 0;
        }
        .modal:not(.hidden) .modal-content-wrapper {
            transform: scale(1) translateY(0); /* End at full size and center */
            opacity: 1;
        }
        .modal-content, .advisor-modal-content, .gallery-modal-content, .keyboard-modal-content {
            @apply glass-effect rounded-3xl shadow-2xl w-full max-h-[95vh] flex flex-col relative;
            background-image: url('https://i0.wp.com/saban94.wordpress.com/wp-content/uploads/2020/01/cropped-22489661_366092580492942_6527060566628824285_n-1.jpg?resize=200%2C200&ssl=1');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 50%; /* Adjusted for better visibility */
            background-blend-mode: overlay; /* Blends logo with background */
        }
        .modal-content > *, .advisor-modal-content > *, .gallery-modal-content > *, .keyboard-modal-content > * {
             position: relative; /* Ensure content is above the background image */
             z-index: 10;
        }
        .modal-content::before, .advisor-modal-content::before, .gallery-modal-content::before, .keyboard-modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9); /* Opaque white layer over background image */
            backdrop-filter: blur(10px); /* Ensures a good glass effect */
            -webkit-backdrop-filter: blur(10px);
            border-radius: inherit; /* Inherit rounded corners */
            z-index: 5; /* Below content, above background image */
        }
        
        /* Specific modal header adjustments */
        .modal-content header, .advisor-modal-header, .gallery-modal-header, .keyboard-modal-header {
             z-index: 11; /* Ensure headers are always on top */
             position: relative;
        }


        /* Updated Tab Buttons with Glass Effect */
        .tab-button {
            @apply px-5 py-3 text-lg font-semibold rounded-xl shadow-sm cursor-pointer; /* More rounded, subtle shadow */
            @apply ml-4; /* Add spacing between buttons */
            background: rgba(255, 255, 255, 0.8); /* Slightly more opaque glass */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5); /* Lighter border for glass look */
            color: #2563EB; /* Blue text for normal state */
            transition: all 0.3s ease-in-out;
        }
        .tab-button:hover {
            background: rgba(255, 255, 255, 0.95); /* More opaque on hover */
            border-color: #90CAF9; /* Light blue border on hover */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); /* Stronger shadow on hover */
        }
        .tab-button.active {
            @apply bg-blue-600 text-white shadow-md border-blue-600; /* Active state: strong blue background, white text, solid border */
            box-shadow: 0 6px 15px rgba(37, 99, 235, 0.3); /* Even stronger shadow for active */
        }

        .typing-effect::after {
            content: '|';
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            from, to { color: transparent }
            50% { color: #2563EB; } /* Blue for typing effect */
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
        ::-webkit-scrollbar-thumb { background: #90CAF9; border-radius: 4px; } /* Light blue scrollbar */
        ::-webkit-scrollbar-thumb:hover { background: #2196F3; } /* Darker blue on hover */

        /* New Advisor Modal Styles - Adjusted for clarity and text size */
        .advisor-modal-content {
            background: rgba(255, 255, 255, 0.95); /* More opaque white */
            border: 1px solid rgba(173, 216, 230, 0.7); /* Light blue border */
            @apply rounded-3xl shadow-2xl w-full max-w-3xl max-h-[95vh] flex flex-col;
        }
        .advisor-modal-header {
            @apply bg-gradient-to-br from-[#ADD8E6] to-[#87CEEB] text-white p-6 rounded-t-3xl;
            border-bottom: 1px solid rgba(255, 255, 255, 0.6);
            font-size: 2.25rem; /* text-4xl */
            font-weight: 700; /* font-bold */
        }
        .advisor-input-area {
            @apply bg-white bg-opacity-90 border border-blue-300 focus:ring-2 focus:ring-blue-500 text-lg; /* Larger text */
        }
        .advisor-response-area {
            @apply bg-blue-50 bg-opacity-70 border border-blue-200 text-blue-800 text-lg; /* Larger text */
        }
        .advisor-loading-spinner {
            border-color: #87CEEB;
            border-top-color: transparent;
        }
        .chat-message {
            @apply p-4 rounded-xl my-2 max-w-[85%] text-lg; /* Larger padding, bolder radius, larger text */
            line-height: 1.6; /* Improved readability */
        }
        .chat-message.user {
            @apply bg-blue-100 text-blue-900 self-end ml-auto shadow-md; /* Subtle shadow */
        }
        .chat-message.ai {
            @apply bg-gray-100 text-gray-800 self-start mr-auto shadow-md; /* Subtle shadow */
        }
        .chat-message.ai strong {
            color: #2563EB; /* Make strong text blue in AI responses */
        }
        .chat-options-container {
            @apply flex flex-wrap gap-3 mt-4; /* Larger gap */
        }
        .chat-option-button {
            @apply bg-blue-200 text-blue-800 px-4 py-2 rounded-full text-base hover:bg-blue-300 transition-colors shadow-sm; /* Larger padding, base text */
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: rgba(255,255,255,0.7);
            border-radius: 0.75rem; /* rounded-xl */
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        th, td {
            padding: 0.75rem;
            text-align: right;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            font-size: 1rem; /* Base font size for tables */
        }
        th {
            background-color: #e0f2f7; /* Light blue header */
            font-weight: bold;
            color: #2563eb;
        }
        /* Gallery modal specific styles */
        .gallery-modal-content {
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(173, 216, 230, 0.7);
            @apply rounded-3xl shadow-2xl w-full max-w-5xl max-h-[95vh] flex flex-col;
        }
        .gallery-image-card {
            @apply bg-white rounded-lg shadow-md overflow-hidden border border-blue-100;
        }
        .gallery-image-card img {
            @apply w-full h-40 object-cover;
        }

        /* H.Saban logo frame */
        .saban-logo-frame {
            @apply p-2 rounded-full bg-white bg-opacity-70 shadow-lg border border-blue-200;
        }

        /* Product Datasheet Button */
        .btn-datasheet {
            @apply bg-green-500 text-white font-bold py-2 px-5 rounded-full shadow-md hover:bg-green-600 transition-colors text-sm;
        }

        /* Virtual Keyboard */
        .keyboard-modal {
            @apply fixed bottom-0 left-0 right-0 p-4 z-50;
            background: rgba(0, 0, 0, 0.6);
            transition: all 0.4s ease-in-out;
            transform: translateY(100%);
            opacity: 0;
            display: flex;
            justify-content: center;
        }
        .keyboard-modal.active {
            transform: translateY(0);
            opacity: 1;
        }
        .keyboard-modal-content {
            @apply bg-white bg-opacity-95 rounded-t-3xl shadow-2xl w-full max-w-4xl p-6 flex flex-col;
            border-top: 1px solid rgba(173, 216, 230, 0.7);
            z-index: 55; /* Higher than other modals to ensure it's on top */
            background-image: url('https://i0.wp.com/saban94.wordpress.com/wp-content/uploads/2020/01/cropped-22489661_366092580492942_6527060566628824285_n-1.jpg?resize=200%2C200&ssl=1');
            background-repeat: no-repeat;
            background-position: center bottom;
            background-size: 30%;
            background-blend-mode: overlay;
        }
        .keyboard-layout {
            display: grid;
            gap: 8px;
            grid-template-columns: repeat(10, 1fr); /* Default 10 columns */
        }
        .keyboard-layout.hebrew {
            grid-template-columns: repeat(11, 1fr); /* Hebrew has more keys in top row */
        }
        .keyboard-key {
            @apply bg-blue-100 text-blue-800 font-semibold p-3 rounded-lg shadow-sm hover:bg-blue-200 active:bg-blue-300 transition-all text-xl flex items-center justify-center cursor-pointer;
            min-width: 40px;
            height: 55px; /* Fixed height for keys */
        }
        .keyboard-key.wide {
            grid-column: span 2;
        }
        .keyboard-key.extra-wide {
            grid-column: span 3;
        }
        .keyboard-key.space {
            grid-column: span 5;
        }
        .keyboard-header {
            @apply flex justify-between items-center pb-4 border-b border-blue-200 mb-4;
        }
        .keyboard-header button {
            @apply text-blue-700 hover:text-blue-900 text-3xl font-bold;
        }
        .keyboard-header .lang-toggle {
            @apply bg-blue-500 text-white px-3 py-1 rounded-full text-base font-semibold hover:bg-blue-600 transition-colors;
        }
        .keyboard-header .emoji-toggle {
            @apply bg-yellow-400 text-gray-800 px-3 py-1 rounded-full text-base font-semibold hover:bg-yellow-500 transition-colors;
        }

        /* Focus state for input with keyboard */
        .input-with-keyboard-active {
             outline: 2px solid #2563EB;
             box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.3);
             border-color: #2563EB;
             transform: translateY(-50px); /* Move input up to center with keyboard below */
             transition: transform 0.3s ease-out;
        }
        .input-with-keyboard-active + .keyboard-modal {
             transform: translateY(0);
             opacity: 1;
        }
    </style>
</head>
<body class="main-container">

    <div id="app" class="min-h-screen">
        <header class="glass-effect shadow-md p-4 flex justify-between items-center sticky top-0 z-40">
            <div class="flex items-center">
                <div class="saban-logo-frame">
                    <img src="https://i0.wp.com/saban94.wordpress.com/wp-content/uploads/2020/01/cropped-22489661_366092580492942_6527060566628824285_n-1.jpg?resize=200%2C200&ssl=1" alt="×œ×•×’×• ×—.×¡×‘×Ÿ" class="h-16 w-16 rounded-full object-cover">
                </div>
                <h1 class="text-3xl font-bold text-blue-800 mr-3">×—.×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ</h1>
            </div>
            <div class="flex items-center space-x-4 space-x-reverse">
                <div class="relative">
                    <input id="searchInput" type="text" placeholder="×”×§×œ×“ ×œ×—×™×¤×•×© ××•×¦×¨..." class="w-64 px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 glass-effect text-lg">
                    <span id="searchIcon" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">ğŸ”</span>
                </div>
                <button id="projectAdvisorButton" class="btn-secondary">âœ¨ ×™×•×¢×¥ ××•×¦×¨ ××ª×§×“× âœ¨</button>
                <button id="showGalleryButton" class="btn-secondary">ğŸ–¼ï¸ ×’×œ×¨×™×™×ª ×¡× ×™×¤×™×</button>
                <button id="cartButton" class="relative btn-secondary">
                    ğŸ›’
                    <span id="cartCount" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center border-2 border-white">0</span>
                    <span class="mr-2">×”×–×× ×”</span>
                </button>
                 <button id="scanBarcode" class="btn-secondary">×¡×¨×™×§×ª ×‘×¨×§×•×“</button>
            </div>
        </header>

        <main class="p-8 grid grid-cols-1 lg:grid-cols-4 gap-8">
            <aside class="lg:col-span-1 glass-effect p-6 rounded-2xl shadow-lg h-fit sticky top-24">
                <h2 class="text-2xl font-bold mb-6 border-b border-gray-300 pb-3 text-blue-800">×¡×™× ×•×Ÿ ××•×¦×¨×™×</h2>
                <div id="filters">
                    <div>
                        <h3 class="font-bold text-xl mb-3 text-blue-700">×§×˜×’×•×¨×™×”</h3>
                        <div id="categoryFilters" class="space-y-2 text-lg"></div>
                    </div>
                    <div class="mt-8">
                        <h3 class="font-bold text-xl mb-3 text-blue-700">××•×ª×’</h3>
                        <div id="brandFilters" class="space-y-2 text-lg"></div>
                    </div>
                     <div class="mt-8">
                        <button id="clearFilters" class="w-full btn-secondary">× ×§×” ×¡×™× ×•× ×™×</button>
                    </div>
                </div>
            </aside>

            <section id="productGrid" class="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-8">
            </section>
        </main>
    </div>

    <div id="productModal" class="modal hidden">
        <div id="modalContentWrapper" class="modal-content-wrapper w-full max-w-5xl">
             <!-- Content will be injected by JS -->
        </div>
    </div>
    
    <div id="cartModal" class="modal hidden">
         <div class="modal-content-wrapper w-full max-w-2xl">
            <div class="modal-content">
                 <header class="p-6 border-b border-gray-300 flex justify-between items-center bg-gradient-to-br from-[#ADD8E6] to-[#87CEEB] text-white rounded-t-3xl">
                    <h2 class="text-3xl font-bold">×”×”×–×× ×” ×©×œ×™</h2>
                    <button id="closeCartModal" class="text-3xl font-bold text-white hover:text-red-300 transition-colors">&times;</button>
                </header>
                <div id="cartItemsContainer" class="p-6 overflow-y-auto flex-grow text-lg">
                </div>
                <footer class="p-6 border-t border-blue-200 bg-white bg-opacity-90 rounded-b-3xl">
                     <h3 class="text-2xl font-bold mb-4 text-blue-700">×¤×¨×˜×™ ××™×œ×•×™ ×”×–×× ×”</h3>
                     <form id="orderForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <input type="text" placeholder="×©× ××œ×" id="customerName" class="p-3 border rounded-lg bg-white bg-opacity-90 border-blue-300 focus:ring-2 focus:ring-blue-500 text-lg" required>
                         <input type="tel" placeholder="××¡×¤×¨ ×˜×œ×¤×•×Ÿ" id="customerPhone" class="p-3 border rounded-lg bg-white bg-opacity-90 border-blue-300 focus:ring-2 focus:ring-blue-500 text-lg" required>
                         <textarea placeholder="×”×¢×¨×•×ª ×œ×”×–×× ×”..." rows="2" id="orderNotes" class="p-3 border rounded-lg md:col-span-2 bg-white bg-opacity-90 border-blue-300 focus:ring-2 focus:ring-blue-500 text-lg"></textarea>
                         <button type="submit" class="btn-primary md:col-span-2 mt-2">×©×œ×— ×”×–×× ×” ×œ×•×•××˜×¡××¤</button>
                     </form>
                </footer>
            </div>
        </div>
    </div>

    <div id="projectAdvisorModal" class="modal hidden">
        <div class="modal-content-wrapper w-full max-w-3xl">
            <div class="advisor-modal-content">
                <header class="advisor-modal-header flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-white">âœ¨ ×™×•×¢×¥ ××•×¦×¨ ××ª×§×“× âœ¨</h2>
                    <button id="closeProjectAdvisorModal" class="text-3xl font-bold text-white hover:text-red-300 transition-colors">&times;</button>
                </header>
                <div id="advisorChatHistory" class="p-6 flex-grow overflow-y-auto flex flex-col items-start">
                    <!-- Chat messages will be injected here -->
                    <div id="initialAdvisorMessage" class="chat-message ai">
                        ×©×œ×•×! ×× ×™ ×™×•×¢×¥ ×”××•×¦×¨ ×”××ª×§×“× ×©×œ ×—.×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ. ××™×š ××•×›×œ ×œ×¢×–×•×¨ ×œ×š ×”×™×•×? ğŸ˜Š
                    </div>
                </div>
                <footer class="p-6 border-t border-blue-200 bg-white bg-opacity-90 rounded-b-3xl">
                    <div class="mb-4">
                        <textarea id="projectAdvisorInput" class="advisor-input-area w-full p-3 border rounded-lg h-20 resize-none" placeholder="×ª××¨ ××ª ×”×¤×¨×•×™×§×˜ ×©×œ×š ××• ×©××œ ×©××œ×” ×¢×œ ×—×•××¨×™×..."></textarea>
                    </div>
                    <button id="getAdvisorAdvice" class="btn-primary w-full">×§×‘×œ ×™×™×¢×•×¥</button>
                    <div id="advisorLoading" class="hidden mt-4 text-center text-blue-600 text-lg">
                        <span class="inline-block h-6 w-6 border-4 border-t-4 rounded-full animate-spin advisor-loading-spinner mr-2"></span>
                        <span class="mr-2">×˜×•×¢×Ÿ ×™×™×¢×•×¥...</span>
                    </div>
                </footer>
            </div>
        </div>
    </div>

    <div id="galleryModal" class="modal hidden">
        <div class="modal-content-wrapper w-full max-w-5xl">
            <div class="gallery-modal-content">
                <header class="advisor-modal-header flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-white">ğŸ–¼ï¸ ×’×œ×¨×™×™×ª ×¡× ×™×¤×™×</h2>
                    <button id="closeGalleryModal" class="text-3xl font-bold text-white hover:text-red-300 transition-colors">&times;</button>
                </header>
                <div class="p-6 flex flex-col flex-grow overflow-hidden">
                    <div class="flex justify-center mb-6 gap-3">
                        <button data-branch-filter="all" class="btn-secondary active-filter-btn">×”×›×œ</button>
                        <button data-branch-filter="×”×—×¨×©" class="btn-secondary">×¡× ×™×£ ×”×—×¨×©</button>
                        <button data-branch-filter="×”×ª×œ××™×“" class="btn-secondary">×¡× ×™×£ ×”×ª×œ××™×“</button>
                    </div>
                    <div id="galleryImageContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto flex-grow">
                        <!-- Gallery images will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="virtualKeyboard" class="keyboard-modal">
        <div class="keyboard-modal-content">
            <div class="keyboard-header">
                <button id="closeKeyboard" class="text-gray-600 hover:text-red-500">&times;</button>
                <div class="flex gap-2">
                    <button id="toggleLang" class="lang-toggle">×¢×‘/EN</button>
                    <button id="toggleEmoji" class="emoji-toggle">ğŸ˜€</button>
                </div>
            </div>
            <div id="keyboardLayout" class="keyboard-layout">
                <!-- Keys will be injected here -->
            </div>
        </div>
    </div>

    <script>
        // Initial product data (will be enhanced with images dynamically)
        const products = [
            {
                id: 1,
                name: "×ª×¨××•×§×™×¨ ×˜×™×— ×ª×¨××™ 300",
                brand: "×ª×¨××•×§×™×¨",
                brand_logo_url: "https://termokir.co.il/logo.png",
                image: "https://termokir.co.il/wp-content/uploads/2020/05/th300-lca-218x345.jpg", // Updated image
                category: "×˜×™×—",
                description: "×˜×™×— ×ª×¨××™ ××™×›×•×ª×™ ×œ×‘×™×“×•×“ ×ª×¨××™ ×©×œ ××‘× ×™×, ×¢×•××“ ×‘×ª×§× ×™× ××—××™×¨×™×.",
                datasheet_url: "https://termokir.co.il/product/%D7%98%D7%99%D7%97-%D7%AA%D7%A8%D7%9E%D7%99-300-th/",
                specs: {
                    "×¦×¤×™×¤×•×ª ×™×‘×©×”": "×¤×—×•×ª ×-300 ×§\"×’/×\"×§",
                    "××•×œ×™×›×•×ª ×ª×¨××™×ª": "0.085 W/(m*k)",
                    "×—×•×–×§ ×œ×—×™×¦×” (28 ×™×•×)": "××¢×œ 1.0 ××’×¤\"×¡",
                    "×¦×¨×™×›×” ××•×¤×™×™× ×™×ª": "0.5-1.4 ×\"×¨/×©×§ (×ª×œ×•×™ ×‘×¢×•×‘×™)",
                    "×ª×§× ×™×": "×ª\"×™ 1414, ×ª\"×™ 1045, ×ª\"×™ 5282, ×ª×• ×™×¨×•×§",
                },
                application: [
                    "×™×© ×œ× ×§×•×ª ×•×œ×©×˜×•×£ ××ª ×”×ª×©×ª×™×ª ×™×•× ×œ×¤× ×™ ×”×™×™×©×•×.",
                    "×œ×¢×¨×‘×‘ 11-12 ×œ×™×˜×¨ ××™× ×¢× ×©×§ 25 ×§\"×’ ×¢×“ ×œ×§×‘×œ×ª ×¢×™×¡×” ××—×™×“×”.",
                    "×œ×”××ª×™×Ÿ 5 ×“×§×•×ª ×•×œ×¢×¨×‘×‘ ×©×•×‘.",
                    "×œ×™×™×©× ×©×›×‘×” ×“×§×” ×•××”×•×“×§×ª, ×•×œ××—×¨ ××›×Ÿ ×œ×”×©×œ×™× ×œ×¢×•×‘×™ ×”× ×“×¨×© (20-70 ×\"×).",
                    "×‘××¢×¨×›×ª ××•×¨×›×‘×ª, ×™×© ×œ×™×™×©× 48 ×©×¢×•×ª ×œ××—×¨ ×©×›×‘×ª ×˜×™×— ×ª×¨××™ 400 TH, ×•-72 ×©×¢×•×ª ×œ×¤× ×™ ×©×œ×™×›×˜ ×‘×’×¨."
                ],
                drying: {
                    "×–××Ÿ ×©××™×©×•×ª ×œ×¢×‘×•×“×”": "×›×©×¢×”",
                    "×‘×™×Ÿ ×©×›×‘×•×ª ×‘××¢×¨×›×ª": "48-72 ×©×¢×•×ª",
                    "×—×©×™×¤×” ×œ××™×": "×™×© ×œ×”×™×× ×¢ ×‘×ª×§×•×¤×ª ×”×™×™×‘×•×© ×”×¨××©×•× ×™×ª"
                },
                calculator: {
                    type: 'coverage_thickness_kg',
                    unit: '×©×§×™×',
                    bag_weight_kg: 25,
                    coverage_per_sqm_per_mm_kg: 0.3,
                    min_thickness_mm: 20,
                    max_thickness_mm: 70
                },
                related_products_ids: []
            },
            {
                id: 2,
                name: "×ª×¨××•×§×™×¨ ×“×‘×§ AD 603",
                brand: "×ª×¨××•×§×™×¨",
                brand_logo_url: "https://termokir.co.il/logo.png",
                image: "https://termokir.co.il/wp-content/uploads/2014/01/0005_AD603.jpg", // Updated image
                category: "×“×‘×§×™× ×œ×¨×™×¦×•×£",
                description: "×“×‘×§ ×¦×× ×˜×™ ×’××™×© ×œ×”×“×‘×§×ª ××¨×™×—×™×, ×¡×™×•×•×’ C2TE S1.",
                datasheet_url: "https://termokir.co.il/product/%D7%93%D7%91%D7%A7-ad-603/",
                specs: {
                    "×¡×™×•×•×’": "C2TE S1",
                    "×—×•×–×§ ×”×™×“×‘×§×•×ª ×‘××ª×™×—×”": "××¢×œ 1.0-1.5 ××’×¤\"S",
                    "×¢×™×•×•×™ ×¨×•×—×‘×™ (×’××™×©×•×ª)": "> 2.5 ×\"×",
                    "×¢×•×‘×™ ×™×™×©×•×": "5-10 ×\"×",
                    "×ª×§× ×™×": "×ª\"×™ 4004, ×ª\"×™ 1555, ×ª×• ×™×¨×•×§",
                },
                application: [
                    "×œ×¢×¨×‘×‘ ×›-6.5 ×œ×™×˜×¨ ××™× ×¢× ×©×§ 25 ×§\"×’.",
                    "×œ××¨×•×— ×©×›×‘×” ×“×§×” ×•××”×•×“×§×ª ×¢×œ ×”×ª×©×ª×™×ª ×•×¢×œ ×’×‘ ×”××¨×™×—.",
                    "×œ×¡×¨×§ ×©×›×‘×” × ×•×¡×¤×ª ×¢×œ ×”×ª×©×ª×™×ª ×‘×××œ×’' ××©×•× ×Ÿ.",
                    "×œ×”×¦××™×“ ××ª ×”××¨×™×— ×‘×©×™×˜×ª '×¨×˜×•×‘ ×¢×œ ×¨×˜×•×‘' ×•×œ×”×“×§."
                ],
                drying: {
                    "×–××Ÿ ×©××™×©×•×ª ×œ×¢×‘×•×“×”": "×›×©×¢×”",
                    "×–××Ÿ ×¤×ª×•×—": "30 ×“×§×•×ª",
                    "××™-×—×©×™×¤×” ×œ××™×": "72 ×©×¢×•×ª ×œ×¤×—×•×ª"
                },
                calculator: {
                    type: 'coverage_thickness_kg',
                    unit: '×©×§×™×',
                    bag_weight_kg: 25,
                    coverage_per_sqm_per_mm_kg: 1.40,
                    min_thickness_mm: 5,
                    max_thickness_mm: 10
                },
                related_products_ids: [9] // ×¨×•×‘×”
            },
            {
                id: 3,
                name: "×›×¨××™×ª ×“×‘×§ ×’××™×© 116",
                brand: "×›×¨××™×ª ××™×¡×˜×¨ ×¤×™×§×¡",
                brand_logo_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/Karmit_logo.svg/320px-Karmit_logo.svg.png",
                category: "×“×‘×§×™× ×œ×¨×™×¦×•×£",
                description: "×“×‘×§ ×¦×× ×˜×™ ×’××™×© ×‘××™×•×—×“ ×œ×”×“×‘×§×ª ×›×œ ×¡×•×’×™ ×”××¨×™×—×™×, ×¡×™×•×•×’ C2TE-S1.",
                datasheet_url: "https://www.karmit.co.il/product/%D7%93%D7%91%D7%A7-%D7%90%D7%A8%D7%99%D7%97%D7%99%D7%9D-%D7%97%D7%92%D7%9E%D7%99%D7%A9-116-c2te-s1/",
                specs: {
                    "×¡×™×•×•×’": "C2TE-S1",
                    "×—×•×–×§ ×”×™×“×‘×§×•×ª ×‘××ª×™×—×”": "××¢×œ 1 ××’×¤\"×¡",
                    "×”×—×œ×§×” ×× ×›×™×ª": "×¤×—×•×ª ×-0.5 ×\"×",
                    "×¢×•×‘×™ ×™×™×©×•×": "4-10 ×\"×",
                    "×ª×§× ×™×": "×ª\"×™ 1555, ×ª\"×™ 4004, ×ª\"×™ 2378, ×ª×• ×™×¨×•×§",
                },
                application: [
                    "×œ×¢×¨×‘×‘ 8-8.5 ×œ×™×˜×¨ ××™× ×¢× ×©×§ 25 ×§\"×’.",
                    "×¢×œ ×ª×©×ª×™×•×ª ×œ× ×¡×•×¤×’×•×ª, ×™×© ×œ×™×™×©× ×¤×¨×™×™××¨ 82-P ×•×œ×”××ª×™×Ÿ 90 ×“×§×•×ª.",
                    "×œ××¨×•×— 100% ×›×™×¡×•×™ ×¢×œ ×’×‘ ×”××¨×™×—.",
                    "×œ×”×¦××™×“ ×œ×ª×©×ª×™×ª, ×œ×˜×œ×˜×œ ×•×œ×”×“×§ ×¢× ×¤×˜×™×© ×’×•××™."
                ],
                drying: {
                    "×–××Ÿ ×©××™×©×•×ª ×œ×¢×‘×•×“×”": "×¢×“ 3 ×©×¢×•×ª",
                    "×–××Ÿ ×¤×ª×•×—": "30 ×“×§×•×ª",
                    "××™-×—×©×™×¤×” ×œ××™×": "24 ×©×¢×•×ª"
                },
                calculator: {
                    type: 'coverage_thickness_kg',
                    unit: '×©×§×™×',
                    bag_weight_kg: 25,
                    coverage_per_sqm_per_mm_kg: 1.5,
                    min_thickness_mm: 4,
                    max_thickness_mm: 10
                },
                related_products_ids: [9] // ×¨×•×‘×”
            },
            {
                id: 4,
                name: "×˜××‘×•×¨ ×˜×™×— ×¦×× ×˜×™ 984",
                brand: "×˜××‘×•×¨",
                brand_logo_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Tambour_logo.svg/320px-Tambour_logo.svg.png",
                category: "×˜×™×—",
                description: "×˜×™×— ×¢×œ ×‘×¡×™×¡ ×¦×× ×˜ ×œ×™×™×©×•×¨ ×§×™×¨×•×ª ×•×ª×§×¨×•×ª ×‘××¨×—×‘×™× ××•×’× ×™× (××\"×“).",
                datasheet_url: "https://www.tambour.co.il/product/%D7%98%D7%99%D7%97-%D7%A6%D7%9E%D7%A0%D7%98%D7%99-984/",
                specs: {
                    "×¦×¨×™×›×” ××•×¤×™×™× ×™×ª": "1.7 ×§\"×’/×\"×¨ ×œ×¢×•×‘×™ 1 ×\"×",
                    "×©×™××•×©": "×§×™×¨×•×ª ×¤× ×™× ×•×—×•×¥, ××\"×“×™×",
                    "×ª×§× ×™×": "×ª\"×™ 5075, EPD, ISO14001",
                },
                application: [
                    "××ª××™× ×œ×™×™×©×•× ×¢×œ ×‘×˜×•×Ÿ, ×‘×œ×•×§×™× ×•×˜×™×— ×§×™×™×.",
                    "×™×© ×œ×”×§×¤×™×“ ×¢×œ ×ª×©×ª×™×ª × ×§×™×™×” ×•×™×¦×™×‘×”.",
                    "××™×•×¢×“ ×œ×™×™×©×•× ×™×“× ×™ ××• ×‘××›×•× ×”."
                ],
                drying: {
                    "×–××Ÿ ×™×™×‘×•×© ×¡×•×¤×™": "28 ×™×•×"
                },
                calculator: {
                    type: 'coverage_thickness_kg',
                    unit: '×©×§×™×',
                    bag_weight_kg: 25,
                    coverage_per_sqm_per_mm_kg: 1.7,
                    min_thickness_mm: 10,
                    max_thickness_mm: 30
                },
                related_products_ids: [1,5] // ×˜×™×— ×ª×¨××™, ×©×œ×™×›×˜
            },
            {
                id: 5,
                name: "× ×™×¨×œ×˜ ×©×œ×™×›×˜ EXTRA M100",
                brand: "× ×™×¨×œ×˜",
                brand_logo_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/cf/Nirlat_logo.svg/320px-Nirlat_logo.svg.png",
                category: "×˜×™×—",
                description: "×©×œ×™×›×˜ ××§×¨×™×œ×™ ×’××™×© ×‘×’×™××•×¨ ××˜, ×¢××™×“ ×‘×ª× ××™ ××§×œ×™× ×§×©×™×.",
                datasheet_url: "https://www.nirlat.com/product/%D7%A9%D7%9C%D7%99%D7%9B%D7%98-extra-m100/",
                specs: {
                    "×›×•×©×¨ ×›×™×¡×•×™": "××©×ª× ×” ×œ×¤×™ ××¨×§× (×›-2 ×§\"×’/×\"×¨)",
                    "×’×™×©×•×¨ ×¢×œ ×¡×“×§×™×": "×¢×“ 1 ×\"×",
                    "×ª×§× ×™×": "×ª\"×™ 1731",
                },
                application: [
                    "×™×© ×œ×™×™×©× ×©×›×‘×ª ×¤×¨×™×™××¨ ×•×œ×”××ª×™×Ÿ 6 ×©×¢×•×ª ×œ×™×™×‘×•×©.",
                    "×œ×‘×—×•×© ×”×™×˜×‘ ×œ×¤× ×™ ×”×©×™××•×©.",
                    "×œ×™×™×©× ×‘×××¦×¢×•×ª ×××œ×’' ××ª×›×ª ×•×œ×©×¤×©×£ ×‘×××œ×’' ×¤×œ×¡×˜×™×§."
                ],
                drying: {
                    "×™×™×‘×•×© ×œ××’×¢": "3-4 ×©×¢×•×ª",
                    "×™×™×‘×•×© ×¡×•×¤×™": "72 ×©×¢×•×ª",
                    "×”×’×‘×œ×•×ª": "×œ× ×œ×™×™×©× ×‘×˜××¤' ××ª×—×ª ×œ-7Â°C ××• ××¢×œ 35Â°C, ××• ×× ×¦×¤×•×™ ×’×©×/××‘×§ ×‘-72 ×”×©×¢×•×ª ×”×§×¨×•×‘×•×ª."
                },
                calculator: {
                    type: 'coverage_kg',
                    unit: '×“×œ×™×™×',
                    coverage_per_sqm: 2.0,
                    bag_weight_kg: 24
                },
                related_products_ids: [4] // ×˜×™×—
            },
            {
                id: 6,
                name: "×‘×•×© ××‘×¨×’×”/××§×“×—×” GSB 185-LI",
                brand: "×‘×•×©",
                brand_logo_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/b/b3/Bosch_logo.svg/320px-Bosch_logo.svg.png",
                category: "×›×œ×™ ×¢×‘×•×“×”",
                description: "××‘×¨×’×”/××§×“×—×” ×¨×•×˜×˜×ª × ×˜×¢× ×ª, 18V, ×§×•××¤×§×˜×™×ª ×¢× ×× ×•×¢ ×œ×œ× ×¤×—××™×.",
                datasheet_url: "https://www.bosch-professional.com/il/he/products/gsb-185-li-06019K3100",
                specs: {
                    "××ª×—": "18V",
                    "××•×× ×˜ (×¨×š/×§×©×”)": "21/50 Nm",
                    "××”×™×¨×•×ª ×¡×™×‘×•×‘": "0-500 / 0-1,900 ×¡×œ\"×“",
                    "×§×¦×‘ ×”×œ×™××”": "27,000 ×¤×œ\"×“",
                    "×× ×•×¢": "×œ×œ× ×¤×—××™× (Brushless)"
                },
                application: [
                    "×”×‘×¨×’×ª ×‘×¨×’×™× ×‘×¢×¥ ×¢×“ 10 ×\"×.",
                    "×§×™×“×•×— ×‘×¢×¥ ×¢×“ 35 ×\"×, ×‘××ª×›×ª ××• ×‘× ×™×™×” ×¢×“ 10 ×\"×."
                ],
                drying: {},
                warranty: "12 ×—×•×“×©×™× (× ×™×ª×Ÿ ×œ×”×¨×—×™×‘ ×œ×©× ×ª×™×™× × ×•×¡×¤×•×ª ×‘×¨×™×©×•×)",
                related_products_ids: [7] // ××™××¤×§×˜
            },
            {
                id: 7,
                name: "××§×™×˜×” ××™××¤×§×˜ DTD152Z",
                brand: "××§×™×˜×”",
                brand_logo_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/7/7b/Makita_logo.svg/320px-Makita_logo.svg.png",
                category: "×›×œ×™ ×¢×‘×•×“×”",
                description: "××‘×¨×’×ª ××™××¤×§×˜ 18V ×—×–×§×” ×•×××™× ×” ×œ×¢×‘×•×“×•×ª ×××•××¦×•×ª (×’×•×£ ×‘×œ×‘×“).",
                datasheet_url: "https://www.makita.co.il/product/%D7%9E%D7%91%D7%A8%D7%92%D7%AA-%D7%90%D7%99%D7%9E%D7%A4%D7%A7%D7%98-18V-DTD152Z/",
                specs: {
                    "××ª×—": "18V",
                    "××”×™×¨×•×ª ×¡×™×‘×•×‘": "0-2,900 ×¡×œ\"×“",
                    "×¨×˜×™×˜×•×ª ×œ×“×§×”": "0-3,500 ×¤×œ\"×“",
                    "××•×× ×˜ ×¤×™×ª×•×œ ××¨×‘×™": "165 Nm",
                    "×˜×›× ×•×œ×•×’×™×”": "XPT - ×”×’× ×” ×××‘×§ ×•××™×"
                },
                application: [
                    "××™×“×™××œ×™×ª ×œ×”×™×“×•×§ ×‘×¨×’×™×, ×¢×‘×•×“×•×ª ×“×§ ×•×¤×¨×’×•×œ×•×ª.",
                    "×× ×’× ×•×Ÿ ××™××¤×§×˜ ××¤×—×™×ª ××ª ×”×¢×•××¡ ×¢×œ ×”××©×ª××©."
                ],
                drying: {},
                warranty: "24 ×—×•×“×©×™× (×™×‘×•××Ÿ ×¨×©××™)",
                related_products_ids: [6] // ××‘×¨×’×”/××§×“×—×”
            },
            {
                id: 8,
                name: "×˜××‘×•×¨ ×œ×•×— ×’×‘×¡ ×œ×‘×Ÿ",
                brand: "×˜××‘×•×¨",
                brand_logo_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Tambour_logo.svg/320px-Tambour_logo.svg.png",
                category: "××•×¦×¨×™ ×’×‘×¡",
                description: "×œ×•×— ×’×‘×¡ ×¡×˜× ×“×¨×˜×™ ×œ×‘× ×™×™×ª ××—×™×¦×•×ª, ×ª×§×¨×•×ª ×•×—×™×¤×•×™×™× ×‘×‘× ×™×™×” ×§×œ×”.",
                datasheet_url: "https://www.tambour.co.il/product/%D7%9C%D7%95%D7%97-%D7%92%D7%91%D7%A1-%D7%9C%D7%91%D7%9F/",
                specs: {
                    "×¢×•×‘×™ ×¡×˜× ×“×¨×˜×™": "12.7 ×\"× (×–××™×Ÿ ×‘×¢×•×‘×™×™× × ×•×¡×¤×™×)",
                    "××™×“×•×ª": "1200x2600/3000 ×\"M",
                    "×ª×§× ×™×": "×ª\"×™ 1490, ×ª\"×™ 62088, ×ª×• ×™×¨×•×§, ISO14001"
                },
                application: [
                    "×™×© ×œ×”×ª×§×™×Ÿ ×¢×œ ×§×•× ×¡×˜×¨×•×§×¦×™×™×ª ×¤×— ××’×•×œ×•×•×Ÿ (× ×™×¦×‘×™× ×•××¡×œ×•×œ×™×).",
                    "×™×© ×œ×”×©×ª××© ×‘×‘×¨×’×™× ×™×™×¢×•×“×™×™× ×œ×’×‘×¡.",
                    "×—×™×‘×•×¨×™ ×”×œ×•×—×•×ª ××˜×•×¤×œ×™× ×‘×©×¤×›×˜×œ ×•×¡×¨×˜ ×©×¨×™×•×Ÿ."
                ],
                drying: {},
                related_products_ids: []
            },
            {
                id: 9,
                name: "×ª×¨××•×§×™×¨ ×¨×•×‘×” SAKRET JF 930",
                brand: "×ª×¨××•×§×™×¨",
                brand_logo_url: "https://termokir.co.il/logo.png",
                category: "×¨×•×‘×”",
                description: "×¨×•×‘×” ××§×¨×™×œ×™×ª ××™×›×•×ª×™×ª ×œ××™×œ×•×™ ××™×©×§×™× ×‘×¨×•×—×‘ 3-10 ×\"×, ×¡×™×•×•×’ CG2 WA.",
                datasheet_url: "https://termokir.co.il/product/%D7%A8%D7%95%D7%91%D7%94-sakret-jf-930/",
                specs: {
                    "×¡×™×•×•×’": "CG2 WA",
                    "×—×•×–×§ ×œ×—×™×¦×” (28 ×™×•×)": "××¢×œ 15.0 ××’×¤\"×¡",
                    "×¢××™×“×•×ª ×œ×©×—×™×§×”": "×’×‘×•×”×” (< 1000 ×\"×Â³)",
                    "×¡×¤×™×’×•×ª ××™×": "××•×¤×—×ª×ª",
                    "×ª×§× ×™×": "×ª\"×™ 1661, ×ª\"×™ 1555, ×ª×• ×™×¨×•×§, EPD"
                },
                application: [
                    "×œ×¢×¨×‘×‘ ×¢× ×›-4 ×œ×™×˜×¨ ××™× ×œ×©×§ 15 ×§\"×’.",
                    "×œ×™×™×©× ×‘×××œ×’' ×’×•××™ ×‘×–×•×•×™×ª ××œ×›×¡×•× ×™×ª ×œ××™×©×§×™×.",
                    "×œ××—×¨ 10-30 ×“×§×•×ª, ×œ× ×§×•×ª ×¢×•×“×¤×™× ×¢× ×¡×¤×•×’ ×œ×—."
                ],
                drying: {
                    "×“×¨×™×›×” ×§×œ×”": "2-3 ×©×¢×•×ª",
                    "×©×™××•×© ×¨×’×™×œ": "48 ×©×¢×•×ª",
                    "××™-×—×©×™×¤×” ×œ××™×": "6 ×©×¢×•×ª ×œ×¤×—×•×ª"
                },
                calculator: {
                    type: 'grout_calculator',
                    unit: '×©×§×™×',
                    bag_weight_kg: 15,
                    grout_density_factor: 1.8,
                    default_tile_length_mm: 600,
                    default_tile_width_mm: 600,
                    default_joint_width_mm: 5,
                    default_joint_depth_mm: 10
                },
                related_products_ids: [2,3,19] // ×“×‘×§×™× ×œ×¨×™×¦×•×£, ××’×‘ ×¨×•×‘×”
            },
            {
                id: 10,
                name: "×¡×™×§×” Sikaflex-11 FC+",
                brand: "×¡×™×§×”",
                brand_logo_url: "https://gilar.co.il/wp-content/themes/gilar/images/sika.svg",
                category: "××™×˜×•×",
                description: "×“×‘×§-××™×˜×•× ×¤×•×œ×™××•×¨×™×˜× ×™ ×¨×‘ ×ª×›×œ×™×ª×™, ×¢××™×“ ×‘×¤× ×™ ×ª×–×•×–×•×ª ×•×ª× ××™ ×—×•×¥.",
                datasheet_url: "https://isr.sika.com/he/construction/adhesives-sealants/sealants/sikaflexr-11-fc.html",
                specs: {
                    "×‘×¡×™×¡ ×›×™××™": "i-CureÂ® Technology polyurethane",
                    "×’××™×©×•×ª": "×’×‘×•×”×” (Â±35%)",
                    "×¢××™×“×•×ª UV": "×˜×•×‘×”",
                    "×˜××¤' ×™×™×©×•×": "+5Â°C ×¢×“ +40Â°C"
                },
                application: [
                    "×œ× ×§×•×ª ×”×™×˜×‘ ××ª ×”××©×˜×— ×××‘×§, ×©×•××Ÿ ×•××–×”××™×.",
                    "×œ×™×™×©× ××ª ×”×—×•××¨ ×‘×××¦×¢×•×ª ××§×“×— ×™×™×¢×•×“×™ ×‘××•×¤×Ÿ ×¨×¦×™×£.",
                    "×œ×”×—×œ×™×§ ××ª ×”×—×•××¨ ×ª×•×š 10 ×“×§×•×ª ××¨×’×¢ ×”×™×™×©×•×."
                ],
                drying: {
                    "×§×¦×‘ ××©×¤×¨×”": "×›-3 ×\"× ×‘-24 ×©×¢×•×ª",
                    "×™×™×‘×•×© ×œ××’×¢": "×›-70 ×“×§×•×ª",
                    "×”×ª×§×©×•×ª ××œ××”": "××¡×¤×¨ ×™××™× (×ª×œ×•×™ ×‘×¢×•×‘×™)"
                },
                warranty: "××•×’×‘×œ ×œ×˜×™×‘ ×”×—×•××¨",
                related_products_ids: [11] // ××™×˜×•× × ×•×¡×£
            },
            {
                id: 11,
                name: "×¡×™×§×” SikaTop Seal-107",
                brand: "×¡×™×§×”",
                brand_logo_url: "https://gilar.co.il/wp-content/themes/gilar/images/sika.svg",
                category: "××™×˜×•×",
                description: "××¢×¨×›×ª ××™×˜×•× ×¦×× ×˜×™×ª ×“×•-×¨×›×™×‘×™×ª, ×’××™×©×” ×‘××§×¦×ª, ×œ××™×˜×•× ×•×”×’× ×” ×¢×œ ×‘×˜×•×Ÿ.",
                datasheet_url: "https://isr.sika.com/he/construction/waterproofing/waterproofing-below-ground/sikaflexr-1a.html", // Placeholder, find actual for Seal-107
                specs: {
                    "×¡×™×•×•×’": "CM O2P (EN 1504-2)",
                    "×—×•×–×§ ×”×™×“×‘×§×•×ª": ">1.0 ××’×¤\"×¡",
                    "×›×•×©×¨ ×’×™×©×•×¨ ×¡×“×§×™×": ">0.75 ×\"×",
                    "×¦×¨×™×›×”": "×›-2.0 ×§\"×’/×\"×¨/×\"× (××•××œ×¥ 2 ×©×›×‘×•×ª)"
                },
                application: [
                    "×œ×¢×¨×‘×‘ ×¨×›×™×‘ A (× ×•×–×œ) ×•-B (××‘×§×”) ×¢×“ ×œ×§×‘×œ×ª ×ª×¢×¨×•×‘×ª ××—×™×“×”.",
                    "×œ×™×™×©× ×©×›×‘×” ×¨××©×•× ×” ×‘××‘×¨×©×ª, ×¨×•×œ×¨ ××• ×”×ª×–×”.",
                    "×œ×”××ª×™×Ÿ 4-8 ×©×¢×•×ª ×•×œ×™×™×©× ×©×›×‘×” ×©× ×™×™×” ×‘× ×™×¦×‘ ×œ×¨××©×•× ×”."
                ],
                drying: {
                    "×‘×™×Ÿ ×©×›×‘×•×ª": "4-8 ×©×¢×•×ª",
                    "×‘×“×™×§×ª ×”×¦×¤×”": "72 ×©×¢×•×ª ×œ×¤×—×•×ª",
                    "××•×›× ×•×ª ×œ×—×™×¤×•×™": "7 ×™××™×"
                },
                calculator: {
                    type: 'coverage_kg',
                    unit: '×™×—×™×“×•×ª',
                    coverage_per_sqm: 4.0,
                    bag_weight_kg: 20
                },
                related_products_ids: [10, 18, 19] // ××™×˜×•× × ×•×¡×£, ×›×œ×™ ×¢×‘×•×“×”
            },
            {
                id: 12,
                name: "×—××ª ×‘×¨×– ××˜×‘×— × ×©×œ×£ ×¡×™×˜×™",
                brand: "×—××ª",
                brand_logo_url: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRz-S4X7_S4z_D1h-j_z2sS1C2v2g7Qy1y_wQ&s",
                category: "×‘×¨×–×™×",
                description: "×‘×¨×– ×™×•×§×¨×ª×™ ×œ×›×™×•×¨ ××˜×‘×— ××‘×™×ª ×—××ª, ×¢×™×¦×•×‘ ××•×“×¨× ×™, ×¤×™×” × ×©×œ×¤×ª ×•×’×™××•×¨ × ×™×§×œ ××•×‘×¨×©.",
                datasheet_url: "https://www.hamat.co.il/product/%D7%91%D7%A8%D7%96-%D7%9E%D7%98%D7%91%D7%97-%D7%A0%D7%A9%D7%9C%D7%A3-%D7%A1%D7%99%D7%98%D7%99/",
                specs: {
                    "×—×•××¨": "×¤×œ×™×– ×‘×¦×™×¤×•×™ ×›×¨×•×/× ×™×§×œ",
                    "×’×™××•×¨": "× ×™×§×œ ××•×‘×¨×© / ×›×¨×•× / ×©×—×•×¨ ××˜",
                    "×¤×™×”": "× ×©×œ×¤×ª ×¢× 2 ××¦×‘×™ ×–×¨×™××”",
                    "×× ×’× ×•×Ÿ": "×× ×’× ×•×Ÿ ×¡×¤×¨×“×™ ××™×›×•×ª×™",
                    "××—×¨×™×•×ª": "7 ×©× ×™× ×¢×œ ×’×•×£ ×”×‘×¨×– ×•×× ×’× ×•×Ÿ"
                },
                application: [
                    "×•×“× ×©× ×§×•×“×•×ª ×”××™× ×”×—××™× ×•×”×§×¨×™× ××•×›× ×•×ª.",
                    "×”×¦×‘ ××ª ×”×‘×¨×– ×‘×—×•×¨ ×”×™×™×¢×•×“×™ ×‘×›×™×•×¨ ××• ×‘××©×˜×—.",
                    "×—×‘×¨ ××ª ×¦×™× ×•×¨×•×ª ×”×‘×¨×– ×œ× ×§×•×“×•×ª ×”×××™× ×•×”×“×§.",
                    "×•×•×“× ××˜×™××” ××œ××” ×©×œ ×”×—×™×‘×•×¨×™× ×œ×¤× ×™ ×¤×ª×™×—×ª ×–×¨× ×”×××™× ×”×¨××©×™."
                ],
                drying: {},
                related_products_ids: [13] // ××™× ×˜×¨×¤×•×¥
            },
            {
                id: 13,
                name: "×—××ª ×¡×˜ ××™× ×˜×¨×¤×•×¥ 4 ×“×¨×š",
                brand: "×—××ª",
                brand_logo_url: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRz-S4X7_S4z_D1h-j_z2sS1C2v2g7Qy1y_wQ&s",
                category: "××™× ×¡×˜×œ×¦×™×”",
                description: "×¡×˜ ××§×œ×—×ª ×™×•×§×¨×ª×™ ×”×›×•×œ×œ ×¨××© ×’×©×, ××–×œ×£ ×™×“× ×™, ×‘×¨×– ×¡×•×œ×œ×” ×•××™× ×˜×¨×¤×•×¥ 4 ×“×¨×š.",
                datasheet_url: "https://www.hamat.co.il/product/%D7%90%D7%99%D7%A0%D7%98%D7%A8%D7%A4%D7%95%D7%A5-4-%D7%93%D7%A8%D7%9B%D7%99%D7%9D/",
                specs: {
                    "×—×•××¨": "×¤×œ×™×– ×‘×¦×™×¤×•×™ ×›×¨×•×",
                    "×’×™××•×¨": "×›×¨×•× / ×©×—×•×¨ ××˜",
                    "×¨××© ×’×©×": "×¢×’×•×œ/××¨×•×‘×¢, ×“×§ ×‘××™×•×—×“",
                    "××–×œ×£": "××¡×¤×¨ ××¦×‘×™ ×–×¨×™××”, ×× ×˜×™ ××‘× ×™×ª",
                    "××™× ×˜×¨×¤×•×¥": "4 ×“×¨×š, ×× ×’× ×•×Ÿ ×§×¨××™"
                },
                application: [
                    "×ª×›× ×Ÿ ××ª ××™×§×•× × ×§×•×“×•×ª ×”×××™× ×•× ×§×– ×”××§×œ×—×ª ×‘×©×œ×‘ ×‘× ×™×™×ª ×”×ª×©×ª×™×ª.",
                    "×”×ª×§×Ÿ ××ª ×™×—×™×“×ª ×”××™× ×˜×¨×¤×•×¥ ×‘×§×™×¨ ×œ×¤×™ ×”×•×¨××•×ª ×”×™×¦×¨×Ÿ.",
                    "×—×‘×¨ ××ª ×”×¦× ×¨×ª ×œ×¨××© ×”×’×©× ×•×œ××–×œ×£ ×”×™×“× ×™.",
                    "×œ××—×¨ ×¡×™×•× ×¢×‘×•×“×•×ª ×”×—×™×¤×•×™, ×”×¨×›×‘ ××ª ×”×¤×¨×™×˜×™× ×”×’×œ×•×™×™×."
                ],
                drying: {},
                related_products_ids: [12] // ×‘×¨×– ××˜×‘×—
            },
            {
                id: 14,
                name: "×—×•×œ ×™× (×œ××™×œ×•×™/×‘× ×™×™×”)",
                brand: "×›×œ×œ×™",
                brand_logo_url: "", // No specific logo for "general"
                category: "×—×•××¨×™ ×‘× ×™×™×Ÿ ×‘×¦×•×‘×¨",
                description: "×—×•×œ ×™× × ×§×™ ×•××™×›×•×ª×™ ×œ××™×œ×•×™, ×™×¦×™×§×•×ª ×‘×˜×•×Ÿ, ×˜×™×— ×•×ª×©×ª×™×•×ª ×¨×™×¦×•×£. × ××›×¨ ×‘× ×¤×— ×©×œ ××¢×œ 0.5 ×§×•×‘.",
                datasheet_url: "https://did.li/QQ4TY", // Example datasheet URL
                specs: {
                    "× ×¤×— ××¨×™×–×”": "××™× ×™××•× 0.5 ×§×•×‘ (×‘×œ×”)",
                    "×¦×‘×¢": "×‘×”×™×¨-××¤×¨×¤×¨",
                    "×’×•×“×œ ×’×¨×’×¨": "×¢×“×™×Ÿ-×‘×™× ×•× ×™ (0.2-2 ×\"×)",
                    "×©×™××•×© ×¢×™×§×¨×™": "××™×œ×•×™, ×‘×˜×•×Ÿ, ×˜×™×—, ×¨×™×¦×•×£"
                },
                application: [
                    "×œ××™×œ×•×™: ×¤×¨×™×¡×” ××—×™×“×” ×•×©×˜×™×—×” ×‘×××¦×¢×•×ª ×›×œ×™× ×™×™×¢×•×“×™×™×.",
                    "×œ×˜×™×—: ×¢×¨×‘×•×‘ ×¢× ×¦×× ×˜ ×•××™× ×œ×™×¦×™×¨×ª ×˜×™×˜.",
                    "×œ×ª×©×ª×™×ª ×¨×™×¦×•×£: ×¤×¨×™×¡×” ×‘×©×›×‘×” ××—×™×“×” ×•×”×™×“×•×§."
                ],
                drying: {},
                calculator: {
                    type: 'volume_thickness_m3',
                    unit: '×‘×œ×•×ª',
                    material_volume_per_sqm_per_mm: 0.001,
                    min_thickness_mm: 50,
                    max_thickness_mm: 300,
                    volume_per_unit: 0.5 // 0.5 ×§×•×‘ ×œ×‘×œ×”
                },
                related_products_ids: [15,16,17,18] // ×¡×•××¡×•×, ×—×¦×¥, ×˜×™×˜, ××¨×™×¦×”
            },
            {
                id: 15,
                name: "×¡×•××¡×•× (×ª×©×ª×™×ª)",
                brand: "×›×œ×œ×™",
                brand_logo_url: "",
                category: "×—×•××¨×™ ×‘× ×™×™×Ÿ ×‘×¦×•×‘×¨",
                description: "×¡×•××¡×•× - ×—×¦×¥ ×“×§ ×‘×’×•×“×œ 0-4 ×\"×, ××™×“×™××œ×™ ×œ×ª×©×ª×™×•×ª ×¨×™×¦×•×£ ×•× ×™×§×•×–. × ××›×¨ ×‘× ×¤×— ×©×œ ××¢×œ 0.5 ×§×•×‘.",
                datasheet_url: "https://did.li/QQ4TY", // Example datasheet URL
                specs: {
                    "× ×¤×— ××¨×™×–×”": "××™× ×™××•× 0.5 ×§×•×‘ (×‘×œ×”)",
                    "×¦×‘×¢": "××¤×•×¨-×‘×–'",
                    "×’×•×“×œ ×’×¨×’×¨": "0-4 ×\"×",
                    "×©×™××•×© ×¢×™×§×¨×™": "×ª×©×ª×™×ª ×¨×™×¦×•×£, ×©×›×‘×ª × ×™×§×•×–, ×™×™×¦×•×‘"
                },
                application: [
                    "×œ×¤×¨×•×¡ ×‘×©×›×‘×” ××—×™×“×” ×•××”×•×“×§×ª ××¢×œ ×ª×©×ª×™×ª ×§×™×™××ª.",
                    "×œ×”×™×“×•×§ ××•××œ×¥ ×©×™××•×© ×‘××”×“×§ ××“××” (×§×•××¤×§×˜×•×¨).",
                    "×œ×•×•×“× ×©×™×¤×•×¢×™× × ×›×•× ×™× ×œ× ×™×§×•×–."
                ],
                drying: {},
                calculator: {
                    type: 'volume_thickness_m3',
                    unit: '×‘×œ×•×ª',
                    material_volume_per_sqm_per_mm: 0.001,
                    min_thickness_mm: 50,
                    max_thickness_mm: 150,
                    volume_per_unit: 0.5
                },
                related_products_ids: [14,16,17,18] // ×—×•×œ, ×—×¦×¥, ×˜×™×˜, ××¨×™×¦×”
            },
            {
                id: 16,
                name: "×—×¦×¥ (×‘×˜×•×Ÿ/× ×™×§×•×–)",
                brand: "×›×œ×œ×™",
                brand_logo_url: "",
                category: "×—×•××¨×™ ×‘× ×™×™×Ÿ ×‘×¦×•×‘×¨",
                description: "×—×¦×¥ × ×§×™ ×‘×’×“×œ×™× ×©×•× ×™×, ××™×“×™××œ×™ ×œ×™×¦×™×§×•×ª ×‘×˜×•×Ÿ, × ×™×§×•×– ×•××™×œ×•×™. × ××›×¨ ×‘× ×¤×— ×©×œ ××¢×œ 0.5 ×§×•×‘.",
                datasheet_url: "https://did.li/QQ4TY", // Example datasheet URL
                specs: {
                    "× ×¤×— ××¨×™×–×”": "××™× ×™××•× 0.5 ×§×•×‘ (×‘×œ×”)",
                    "×¦×‘×¢": "××¤×•×¨",
                    "×’×•×“×œ ×’×¨×’×¨": "××©×ª× ×” (×œ×“×•×’××” 20/40 ×\"×)",
                    "×©×™××•×© ×¢×™×§×¨×™": "×‘×˜×•×Ÿ, × ×™×§×•×–, ××™×œ×•×™, ×©×‘×™×œ×™ ×’×™×©×”"
                },
                application: [
                    "×œ×™×¦×™×§×•×ª ×‘×˜×•×Ÿ: ×¢×¨×‘×•×‘ ×¢× ×¦×× ×˜ ×•×—×•×œ ×‘×™×—×¡×™× ××ª××™××™×.",
                    "×œ× ×™×§×•×–: ×¤×¨×™×¡×” ×‘×©×›×‘×” ×¢×‘×” ×‘×ª×—×ª×™×ª ×ª×¢×œ×•×ª ××• ×›×‘×¡×™×¡.",
                    "×œ××™×œ×•×™: ×©×™××•×© ×œ××™×œ×•×™ ×—×œ×œ×™× ×’×“×•×œ×™×."
                ],
                drying: {},
                calculator: {
                    type: 'volume_thickness_m3',
                    unit: '×‘×œ×•×ª',
                    material_volume_per_sqm_per_mm: 0.001,
                    min_thickness_mm: 100,
                    max_thickness_mm: 500,
                    volume_per_unit: 0.5
                },
                related_products_ids: [14,15,17,18] // ×—×•×œ, ×¡×•××¡×•×, ×˜×™×˜, ××¨×™×¦×”
            },
            {
                id: 17,
                name: "×˜×™×˜ ××•×›×Ÿ",
                brand: "×›×œ×œ×™",
                brand_logo_url: "",
                category: "×—×•××¨×™ ×‘× ×™×™×Ÿ ×‘×¦×•×‘×¨",
                description: "×˜×™×˜ ×¦×× ×˜×™ ××•×›×Ÿ ×œ×©×™××•×© (×™×‘×©), ××ª××™× ×œ×˜×™×—, ×¨×™×¦×•×£ ×•×‘× ×™×™×”. × ××›×¨ ×‘× ×¤×— ×©×œ ××¢×œ 0.5 ×§×•×‘.",
                datasheet_url: "https://did.li/QQ4TY", // Example datasheet URL
                specs: {
                    "× ×¤×— ××¨×™×–×”": "×©×§ 25 ×§\"×’ / 0.5 ×§×•×‘ (×‘×œ×”)",
                    "××¨×›×™×‘×™×": "×¦×× ×˜, ×—×•×œ, ×ª×•×¡×¤×™×",
                    "×©×™××•×© ×¢×™×§×¨×™": "×˜×™×—, ×”×“×‘×§×”, ×‘× ×™×” (×‘×œ×•×§×™×), ××™×œ×•×™"
                },
                application: [
                    "×œ×¢×¨×‘×‘ ×¢× ××™× ×‘×™×—×¡×™× ×”××•××œ×¦×™× ×¢×“ ×œ×§×‘×œ×ª ×¢×‘×™×“×•×ª ×¨×¦×•×™×”.",
                    "×œ×™×™×©× ×‘×××œ×’' ××• ×‘×›×£ ×‘× ××™× ×œ×¤×™ ×”×¦×•×¨×š.",
                    "×œ×”×§×¤×™×“ ×¢×œ ×›×™×¡×•×™ ××—×™×“ ×•×™×™×©×•×¨."
                ],
                drying: {
                    "×–××Ÿ ×©××™×©×•×ª": "×›-2 ×©×¢×•×ª (×œ×˜×™×˜ ××¢×•×¨×‘×‘)",
                    "×™×™×‘×•×© ×œ××’×¢": "×›-6-12 ×©×¢×•×ª",
                    "×™×™×‘×•×© ×¡×•×¤×™": "28 ×™×•× (×œ××©×¤×¨×” ××œ××”)"
                },
                calculator: {
                    type: 'coverage_thickness_kg',
                    unit: '×‘×œ×•×ª',
                    bag_weight_kg: 25,
                    coverage_per_sqm_per_mm_kg: 1.8,
                    min_thickness_mm: 10,
                    max_thickness_mm: 50,
                    volume_per_unit: 0.5,
                    density_kg_per_m3: 1800
                },
                related_products_ids: [14,15,16,18] // ×—×•×œ, ×¡×•××¡×•×, ×—×¦×¥, ××¨×™×¦×”
            },
            {
                id: 18,
                name: "××¨×™×¦×” ×™×“× ×™×ª",
                brand: "×›×œ×œ×™",
                brand_logo_url: "",
                category: "×›×œ×™ ×¢×‘×•×“×”",
                description: "××¨×™×¦×” ×™×“× ×™×ª ×—×–×§×” ×•×¢××™×“×”, ××™×“×™××œ×™×ª ×œ×”×•×‘×œ×ª ×—×•××¨×™ ×‘× ×™×™×Ÿ ×‘××ª×¨.",
                datasheet_url: "https://did.li/QQ4TY", // Example datasheet URL
                specs: {
                    "×—×•××¨": "×¤×œ×“×” ××’×•×œ×•×•× ×ª / ×¤×œ×¡×˜×™×§ ××—×•×–×§",
                    "× ×¤×—": "80-120 ×œ×™×˜×¨",
                    "×’×œ×’×œ": "×¤× ×™××•××˜×™ ××—×•×–×§"
                },
                application: ["×œ×”×•×‘×œ×ª ×—×•×œ, ×—×¦×¥, ××œ×˜, ×¤×¡×•×œ×ª ×‘× ×™×™×Ÿ ×•×¢×•×“."],
                drying: {},
                related_products_ids: [14,15,16,17] // ×—×•××¨×™ ×‘× ×™×™×Ÿ ×‘×¦×•×‘×¨
            },
            {
                id: 19,
                name: "××’×‘ ×’×•××™ ×œ×¨×•×‘×”",
                brand: "×›×œ×œ×™",
                brand_logo_url: "",
                category: "×›×œ×™ ×¢×‘×•×“×”",
                description: "××’×‘ ×’×•××™ ××§×¦×•×¢×™ ×œ×™×™×©×•× ×•×”×—×œ×§×ª ×¨×•×‘×”, ××•× ×¢ ×©×¨×™×˜×•×ª ×•××‘×˜×™×— ××™×œ×•×™ ××—×™×“ ×©×œ ×”××™×©×§×™×.",
                datasheet_url: "https://did.li/QQ4TY", // Example datasheet URL
                specs: {
                    "×—×•××¨": "×™×“×™×ª ×¤×œ×¡×˜×™×§, ×’×•××™ ×¢××™×“",
                    "×¨×•×—×‘": "20-25 ×¡\"×",
                    "×©×™××•×©": "××™×œ×•×™ ××™×©×§×™× ×‘×¨×•×‘×”"
                },
                application: [
                    "×œ××—×¨ ××¨×™×—×ª ×”×¨×•×‘×”, ×™×© ×œ×”×—×œ×™×§ ××ª ×”×¢×•×“×¤×™× ×‘×××¦×¢×•×ª ×”××’×‘ ×‘×–×•×•×™×ª ×©×œ 45 ××¢×œ×•×ª.",
                    "×œ× ×§×•×ª ××ª ×”××’×‘ ×œ×¢×™×ª×™× ×§×¨×•×‘×•×ª."
                ],
                drying: {},
                related_products_ids: [9] // ×¨×•×‘×”
            }
        ];

        // Store images for the gallery
        const storeImages = [
            { src: 'https://saban94.wordpress.com/wp-content/uploads/2020/01/46453331_572490759853122_8215770119347896320_o.jpg?w=150', alt: '×¡× ×™×£ ×”×—×¨×© - ×¤× ×™×', branch: '×”×—×¨×©' }, // Updated
            { src: 'https://placehold.co/600x400/ADD8E6/2563EB?text=×¡× ×™×£+×”×—×¨×©+2', alt: '×¡× ×™×£ ×”×—×¨×© - ×—×–×™×ª', branch: '×”×—×¨×©' },
            { src: 'https://placehold.co/600x400/ADD8E6/2563EB?text=×¡× ×™×£+×”×—×¨×©+3', alt: '×¡× ×™×£ ×”×—×¨×© - ××—×¡×Ÿ', branch: '×”×—×¨×©' },
            { src: 'https://placehold.co/600x400/ADD8E6/2563EB?text=×¡× ×™×£+×”×ª×œ××™×“+1', alt: '×¡× ×™×£ ×”×ª×œ××™×“ - ×›× ×™×¡×”', branch: '×”×ª×œ××™×“' },
            { src: 'https://lh3.googleusercontent.com/p/AF1QipP-L-0l0QGsJjsiNaC7c7lfUbuJOUs99G22nEc7=s680-w680-h510-rw', alt: '×¡× ×™×£ ×”×ª×œ××™×“ - ××‘×—×•×¥', branch: '×”×ª×œ××™×“' }, // Updated
            { src: 'https://placehold.co/600x400/ADD8E6/2563EB?text=×¡× ×™×£+×”×ª×œ××™×“+3', alt: '×¡× ×™×£ ×”×ª×œ××™×“ - ××—×œ×§×ª ××™× ×¡×˜×œ×¦×™×”', branch: '×”×ª×œ××™×“' },
            { src: 'https://placehold.co/600x400/ADD8E6/2563EB?text=×¡× ×™×£+×”×ª×œ××™×“+4', alt: '×¡× ×™×£ ×”×ª×œ××™×“ - ×ª×¦×•×’×”', branch: '×”×ª×œ××™×“' },
        ];


        const app = document.getElementById('app');
        const productGrid = document.getElementById('productGrid');
        const productModal = document.getElementById('productModal');
        const modalContentWrapper = document.getElementById('modalContentWrapper');
        const cartModal = document.getElementById('cartModal');
        const closeCartModal = document.getElementById('closeCartModal');
        const cartButton = document.getElementById('cartButton');
        const cartCount = document.getElementById('cartCount');
        const cartItemsContainer = document.getElementById('cartItemsContainer');
        const categoryFiltersContainer = document.getElementById('categoryFilters');
        const brandFiltersContainer = document.getElementById('brandFilters');
        const clearFiltersButton = document.getElementById('clearFilters');
        const searchInput = document.getElementById('searchInput');
        const scanBarcodeButton = document.getElementById('scanBarcode');
        const orderForm = document.getElementById('orderForm');
        const customerNameInput = document.getElementById('customerName');
        const customerPhoneInput = document.getElementById('customerPhone'); // Fixed assignment
        const orderNotesInput = document.getElementById('orderNotes');

        const projectAdvisorButton = document.getElementById('projectAdvisorButton');
        const projectAdvisorModal = document.getElementById('projectAdvisorModal');
        const closeProjectAdvisorModal = document.getElementById('closeProjectAdvisorModal');
        const getAdvisorAdviceButton = document.getElementById('getAdvisorAdvice');
        const projectAdvisorInput = document.getElementById('projectAdvisorInput');
        const advisorChatHistoryDiv = document.getElementById('advisorChatHistory');
        const advisorLoading = document.getElementById('advisorLoading');

        const showGalleryButton = document.getElementById('showGalleryButton');
        const galleryModal = document.getElementById('galleryModal');
        const closeGalleryModal = document.getElementById('closeGalleryModal');
        const galleryImageContainer = document.getElementById('galleryImageContainer');

        const virtualKeyboard = document.getElementById('virtualKeyboard');
        const closeKeyboardBtn = document.getElementById('closeKeyboard');
        const toggleLangBtn = document.getElementById('toggleLang');
        const toggleEmojiBtn = document.getElementById('toggleEmoji');
        const keyboardLayoutDiv = document.getElementById('keyboardLayout');

        let activeFilters = { category: [], brand: [] };
        let cart = [];
        let currentFilteredProducts = [];
        let currentProductIndexInFilteredList = -1;
        let chatHistory = []; // Stores the full chat conversation

        let activeInput = null; // To track which input field is active for the keyboard

        // Keyboard layouts
        const layouts = {
            he: [
                ['×§', '×¨', '×', '×˜', '×•', '×Ÿ', '×', '×¤', ']', '['],
                ['×©', '×“', '×’', '×›', '×¢', '×™', '×—', '×œ', '×š', '×£', ','],
                ['×–', '×¡', '×‘', '×”', '× ', '×', '×¦', '×ª', '×¥', '.', '/'],
                ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0', '-'],
                ['@', '#', '$', '%', '&', '*', '(', ')', '_', '+', '='],
            ],
            en: [
                ['q', 'w', 'e', 'r', 't', 'y', 'u', 'i', 'o', 'p', '{', '}'],
                ['a', 's', 'd', 'f', 'g', 'h', 'j', 'k', 'l', ':', '"'],
                ['z', 'x', 'c', 'v', 'b', 'n', 'm', '<', '>', '?'],
                ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0', '-'],
                ['!', '@', '#', '$', '%', '^', '&', '*', '(', ')', '_', '+', '='],
            ],
            numbers: [
                ['7', '8', '9'],
                ['4', '5', '6'],
                ['1', '2', '3'],
                ['0', '.', '='],
            ],
            emojis: [
                ['ğŸ˜€', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜ƒ', 'ğŸ˜„', 'ï¿½', 'ğŸ˜†', 'ğŸ˜‰', 'ğŸ˜Š'],
                ['ğŸ˜‹', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ™‚', 'ğŸ¤—', 'ğŸ¤”'],
                ['ğŸ˜®', 'ğŸ¤', 'ğŸ™', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤’', 'ğŸ˜·', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®'],
                ['ğŸ‘', 'ğŸ‘', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ™', 'â¤ï¸', 'ğŸ’”', 'ğŸŒŸ', 'ğŸ’¡', 'ğŸš€'],
            ]
        };
        let currentLayout = 'he';
        let isEmojiLayout = false;

        function renderKeyboard() {
            keyboardLayoutDiv.innerHTML = '';
            const layout = isEmojiLayout ? layouts.emojis : layouts[currentLayout];
            keyboardLayoutDiv.classList.toggle('hebrew', currentLayout === 'he' && !isEmojiLayout);
            keyboardLayoutDiv.classList.toggle('english', currentLayout === 'en' && !isEmojiLayout);
            keyboardLayoutDiv.classList.toggle('emoji', isEmojiLayout);

            layout.forEach(row => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'flex gap-2 mb-2 w-full';
                row.forEach(key => {
                    const keyButton = document.createElement('button');
                    keyButton.className = 'keyboard-key flex-grow';
                    if (key === ' ') keyButton.className += ' space'; // Special class for space
                    keyButton.textContent = key;
                    keyButton.dataset.key = key; // Store key value
                    keyButton.addEventListener('click', () => handleKeyPress(key));
                    rowDiv.appendChild(keyButton);
                });
                keyboardLayoutDiv.appendChild(rowDiv);
            });

            // Add special keys (Backspace, Shift, Enter, etc.)
            const specialKeysRow = document.createElement('div');
            specialKeysRow.className = 'flex gap-2 mb-2 w-full';

            const backspace = document.createElement('button');
            backspace.className = 'keyboard-key wide';
            backspace.innerHTML = 'âŒ«'; // Backspace symbol
            backspace.addEventListener('click', handleBackspace);
            specialKeysRow.appendChild(backspace);

            const space = document.createElement('button');
            space.className = 'keyboard-key space';
            space.innerHTML = '×¨×•×•×—'; // Spacebar
            space.addEventListener('click', () => handleKeyPress(' '));
            specialKeysRow.appendChild(space);

            const enter = document.createElement('button');
            enter.className = 'keyboard-key wide';
            enter.innerHTML = 'â†µ'; // Enter symbol
            enter.addEventListener('click', handleEnterPress);
            specialKeysRow.appendChild(enter);

            keyboardLayoutDiv.appendChild(specialKeysRow);
        }

        function handleKeyPress(key) {
            if (activeInput) {
                const start = activeInput.selectionStart;
                const end = activeInput.selectionEnd;
                activeInput.value = activeInput.value.substring(0, start) + key + activeInput.value.substring(end);
                activeInput.selectionStart = activeInput.selectionEnd = start + key.length;
                activeInput.focus();
                activeInput.dispatchEvent(new Event('input', { bubbles: true })); // Trigger input event for search/filters
            }
        }

        function handleBackspace() {
            if (activeInput) {
                const start = activeInput.selectionStart;
                const end = activeInput.selectionEnd;
                if (start === end && start > 0) {
                    activeInput.value = activeInput.value.substring(0, start - 1) + activeInput.value.substring(end);
                    activeInput.selectionStart = activeInput.selectionEnd = start - 1;
                } else {
                    activeInput.value = activeInput.value.substring(0, start) + activeInput.value.substring(end);
                }
                activeInput.focus();
                activeInput.dispatchEvent(new Event('input', { bubbles: true })); // Trigger input event for search/filters
            }
        }

        function handleEnterPress() {
            if (activeInput && activeInput.id === 'projectAdvisorInput') {
                getAdvisorAdviceButton.click(); // Trigger advice if it's the advisor input
            } else if (activeInput && activeInput.id === 'searchInput') {
                applyFilters(); // Trigger search
            }
            // For other inputs, just close keyboard or do nothing specific
            hideKeyboard();
        }

        function showKeyboard(inputElement) {
            if (activeInput) {
                activeInput.classList.remove('input-with-keyboard-active');
            }
            activeInput = inputElement;
            activeInput.classList.add('input-with-keyboard-active');
            virtualKeyboard.classList.add('active');
            activeInput.focus();
        }

        function hideKeyboard() {
            if (activeInput) {
                activeInput.classList.remove('input-with-keyboard-active');
            }
            activeInput = null;
            virtualKeyboard.classList.remove('active');
        }

        closeKeyboardBtn.addEventListener('click', hideKeyboard);

        toggleLangBtn.addEventListener('click', () => {
            isEmojiLayout = false;
            currentLayout = currentLayout === 'he' ? 'en' : 'he';
            renderKeyboard();
        });

        toggleEmojiBtn.addEventListener('click', () => {
            isEmojiLayout = !isEmojiLayout;
            renderKeyboard();
        });


        // Function to fetch image URLs using google_search API (simulated via Gemini)
        async function fetchProductImage(productName, brandName) {
            const query = `${productName} ${brandName} product image URL`;
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [{
                        text: `Perform a web search for an image of "${query}" and return only the direct URL of the first highly relevant image result. Do not return any other text, just the URL. If no relevant URL is found, return "NO_IMAGE_FOUND".`
                    }]
                }]
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("API call failed with status:", response.status, "Response text:", errorText);
                    return `https://placehold.co/400x300/E0F2F7/2563EB?text=Error+Loading`; // Fallback on non-OK response
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const llmResponse = result.candidates[0].content.parts[0].text.trim();
                    if (llmResponse.startsWith('http') && (llmResponse.endsWith('.jpg') || llmResponse.endsWith('.png') || llmResponse.endsWith('.jpeg') || llmResponse.endsWith('.webp'))) {
                        return llmResponse;
                    }
                }
            } catch (error) {
                console.error("Error fetching image via Gemini API (possibly network or parsing JSON):", error);
                // If the error was from response.json(), and response was not okay,
                // the `response.text()` in the `if (!response.ok)` block might have caught it.
                // Otherwise, it's a JSON parsing error on a 200 OK response, or network error.
            }
            // Fallback to placeholder if no image found, error, or unexpected LLM response format
            return `https://placehold.co/400x300/E0F2F7/2563EB?text=${encodeURIComponent(productName)}`;
        }

        // Cache for image URLs
        const imageUrlCache = {};

        async function populateProductImages() {
            // First, render with placeholders
            renderProducts(products);

            // Then, fetch images asynchronously and update
            const productCards = document.querySelectorAll('.product-card');
            for (let i = 0; i < products.length; i++) {
                const product = products[i];
                // Only fetch if image is not already set (e.g., from provided data) AND not in cache
                if (!product.image_fetched && !imageUrlCache[product.id]) { // Use a flag to prevent re-fetching fixed images
                    const imageUrl = await fetchProductImage(product.name, product.brand);
                    imageUrlCache[product.id] = imageUrl;
                    product.image = imageUrl; // Update the product object with fetched image
                    product.image_fetched = true; // Mark as fetched
                    
                    // Update the specific card's image
                    const cardImage = productCards[i]?.querySelector('.product-main-image');
                    if (cardImage) {
                        cardImage.src = imageUrl;
                        cardImage.onerror = null; // Remove onerror to prevent infinite loops if the fetched URL is bad
                    }
                } else if (imageUrlCache[product.id]) { // If in cache, use cached image
                    product.image = imageUrlCache[product.id];
                    const cardImage = productCards[i]?.querySelector('.product-main-image');
                    if (cardImage) {
                        cardImage.src = imageUrlCache[product.id];
                        cardImage.onerror = null;
                    }
                }
            }
        }

        function renderProducts(productsToRender) {
            productGrid.innerHTML = '';
            currentFilteredProducts = productsToRender;
            if (productsToRender.length === 0) {
                productGrid.innerHTML = `<p class="text-center text-gray-500 col-span-full text-xl py-10">×œ× × ××¦××• ××•×¦×¨×™× ×”×ª×•×××™× ××ª ×”×¡×™× ×•×Ÿ.</p>`;
                return;
            }
            productsToRender.forEach((product, index) => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.dataset.filteredIndex = index;
                card.innerHTML = `
                    <img src="${product.image || `https://placehold.co/400x300/E0F2F7/2563EB?text=${encodeURIComponent(product.name)}`}" alt="${product.name}" class="w-full h-40 object-cover product-main-image rounded-t-2xl" onerror="this.src='https://placehold.co/400x300/E0F2F7/2563EB?text=Image+Not+Found'">
                    <div class="p-4 flex items-center justify-between">
                        <div>
                            <span class="text-sm text-gray-500">${product.brand}</span>
                            <h3 class="font-bold text-xl mt-1 truncate text-blue-800">${product.name}</h3>
                        </div>
                        ${product.brand_logo_url ? `<img src="${product.brand_logo_url}" alt="${product.brand} logo" class="w-12 h-12 object-contain ml-2 rounded-lg" onerror="this.src='https://placehold.co/48x48/CCCCCC/333333?text=Logo'">` : ''}
                    </div>
                `;
                productGrid.appendChild(card);
            });
        }
        
        function createTimeline(dryingData) {
            let html = '<div class="space-y-4 text-lg">';
            for (const [key, value] of Object.entries(dryingData)) {
                if (value && typeof value === 'string' && value.trim() !== "") {
                     html += `
                        <div class="flex items-center">
                            <span class="w-1/3 text-gray-600 font-semibold">${key}</span>
                            <span class="w-2/3 font-bold text-blue-800">${value}</span>
                        </div>
                    `;
                }
            }
            html += '</div>';
            return html;
        }

        function createCalculatorHTML(product) {
            if (!product.calculator) return '<p class="text-center text-gray-500 text-lg py-8">××—×©×‘×•×Ÿ ×›××•×ª ××™× ×• ×–××™×Ÿ ×¢×‘×•×¨ ××•×¦×¨ ×–×”.</p>';
            
            const { type, unit, bag_weight_kg, coverage_per_sqm_per_mm_kg, min_thickness_mm, max_thickness_mm, coverage_per_sqm, grout_density_factor, default_tile_length_mm, default_tile_width_mm, default_joint_width_mm, default_joint_depth_mm, material_volume_per_sqm_per_mm, volume_per_unit, density_kg_per_m3 } = product.calculator;

            let inputsHtml = '';
            if (type === 'coverage_thickness_kg' || type === 'volume_thickness_m3') {
                inputsHtml = `
                    <div class="mb-4">
                        <label for="calcArea" class="block text-blue-700 text-base font-bold mb-2">×©×˜×— ×‘×"×¨:</label>
                        <input type="number" id="calcArea" value="10" min="0.1" step="0.1" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline border-blue-300 text-lg">
                    </div>
                    <div class="mb-4">
                        <label for="calcThickness" class="block text-blue-700 text-base font-bold mb-2">×¢×•×‘×™ ×©×›×‘×” ×‘×"× (${min_thickness_mm}-${max_thickness_mm} ××•××œ×¥):</label>
                        <input type="number" id="calcThickness" value="${min_thickness_mm}" min="${min_thickness_mm}" step="0.1" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline border-blue-300 text-lg">
                    </div>
                `;
            } else if (type === 'coverage_kg') {
                inputsHtml = `
                    <div class="mb-4">
                        <label for="calcArea" class="block text-blue-700 text-base font-bold mb-2">×©×˜×— ×‘×"×¨:</label>
                        <input type="number" id="calcArea" value="10" min="0.1" step="0.1" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline border-blue-300 text-lg">
                    </div>`;
            } else if (type === 'grout_calculator') {
                 inputsHtml = `
                    <div class="grid grid-cols-2 gap-4">
                        <div class="mb-2 col-span-2">
                            <label for="calcArea" class="block text-blue-700 text-base font-bold mb-2">×©×˜×— ×¨×™×¦×•×£ ×‘×"×¨:</label>
                            <input type="number" id="calcArea" value="10" min="0.1" step="0.1" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 border-blue-300 text-lg">
                        </div>
                        <div class="mb-2">
                            <label for="calcTileLength" class="block text-blue-700 text-base font-bold mb-2">××•×¨×š ××¨×™×— (×"×):</label>
                            <input type="number" id="calcTileLength" value="${default_tile_length_mm}" min="1" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 border-blue-300 text-lg">
                        </div>
                        <div class="mb-2">
                            <label for="calcTileWidth" class="block text-blue-700 text-base font-bold mb-2">×¨×•×—×‘ ××¨×™×— (×"×):</label>
                            <input type="number" id="calcTileWidth" value="${default_tile_width_mm}" min="1" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 border-blue-300 text-lg">
                        </div>
                        <div class="mb-2">
                            <label for="calcJointWidth" class="block text-blue-700 text-base font-bold mb-2">×¨×•×—×‘ ××™×©×§ (×"×):</label>
                            <input type="number" id="calcJointWidth" value="${default_joint_width_mm}" min="1" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 border-blue-300 text-lg">
                        </div>
                        <div class="mb-2">
                            <label for="calcJointDepth" class="block text-blue-700 text-base font-bold mb-2">×¢×•××§ ××™×©×§ (×"×):</label>
                            <input type="number" id="calcJointDepth" value="${default_joint_depth_mm}" min="1" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 border-blue-300 text-lg">
                        </div>
                    </div>`;
            }

            return `
                <div class="p-4">
                    <h3 class="font-bold text-2xl mb-4 text-blue-700">××—×©×‘×•×Ÿ ×›××•×ª</h3>
                    ${inputsHtml}
                    <button id="calculateBtn" class="btn-primary w-full mt-4">×—×©×‘ ×›××•×ª</button>
                    <div class="mt-4 p-4 bg-white bg-opacity-70 rounded-lg text-center text-xl font-bold text-blue-800 border border-blue-200">
                        <span>×”×›××•×ª ×”× ×“×¨×©×ª:</span>
                        <span id="calcResult" class="ml-2">×”×–×Ÿ × ×ª×•× ×™× ×œ×—×™×©×•×‘</span>
                    </div>
                </div>`;
        }
        
        function attachCalculatorListeners(product) {
            const calculateBtn = document.getElementById('calculateBtn');
            if (!calculateBtn) return;
            
            const calcFunc = () => {
                const { type, unit, bag_weight_kg, coverage_per_sqm_per_mm_kg, coverage_per_sqm, grout_density_factor, volume_per_unit, density_kg_per_m3 } = product.calculator;
                const area = parseFloat(document.getElementById('calcArea')?.value) || 0;
                let resultText = '×× × ×”×–×Ÿ ×¢×¨×›×™× ×—×•×§×™×™×.';

                if (type === 'coverage_thickness_kg' || type === 'volume_thickness_m3') {
                    const thickness = parseFloat(document.getElementById('calcThickness')?.value) || 0;
                    if (area > 0 && thickness > 0) {
                        if (type === 'coverage_thickness_kg') {
                            const totalKg = area * thickness * coverage_per_sqm_per_mm_kg;
                            resultText = `${totalKg.toFixed(2)} ×§"×’`;
                            if (bag_weight_kg > 0) {
                                if (unit === '×‘×œ×•×ª' && density_kg_per_m3 > 0 && volume_per_unit > 0) { // Specific calculation for 'bales' unit
                                    const totalKiloBags = Math.ceil(totalKg / bag_weight_kg);
                                    const totalVolume = (totalKg / density_kg_per_m3);
                                    const totalBaleBags = Math.ceil(totalVolume / volume_per_unit);
                                    resultText += ` (×›-${totalKiloBags} ×©×§×™× ××• ${totalBaleBags} ×‘×œ×•×ª)`;
                                } else {
                                     const numBags = Math.ceil(totalKg / bag_weight_kg);
                                     resultText += ` (×›-${numBags} ${unit})`;
                                }
                            }
                        } else { // volume_thickness_m3
                            const totalCubicMeters = area * thickness * 0.001;
                            resultText = `${totalCubicMeters.toFixed(3)} ×§×•×‘`;
                             if (volume_per_unit > 0) {
                                const numUnits = Math.ceil(totalCubicMeters / volume_per_unit);
                                resultText += ` (×›-${numUnits} ${unit})`;
                            }
                        }
                    }
                } else if (type === 'coverage_kg') {
                    if (area > 0) {
                        const totalKg = area * coverage_per_sqm;
                        resultText = `${totalKg.toFixed(2)} ×§"×’`;
                        if (bag_weight_kg > 0) {
                            const numBags = Math.ceil(totalKg / bag_weight_kg);
                            resultText += ` (×›-${numBags} ${unit})`;
                        }
                    }
                } else if (type === 'grout_calculator') {
                    const tileLength = parseFloat(document.getElementById('calcTileLength').value) || 0;
                    const tileWidth = parseFloat(document.getElementById('calcTileWidth').value) || 0;
                    const jointWidth = parseFloat(document.getElementById('calcJointWidth').value) || 0;
                    const jointDepth = parseFloat(document.getElementById('calcJointDepth').value) || 0;
                    if (area > 0 && tileLength > 0 && tileWidth > 0 && jointWidth > 0 && jointDepth > 0) {
                        const groutPerSqm = ((tileLength + tileWidth) * jointWidth * jointDepth * grout_density_factor) / (tileLength * tileWidth);
                        const totalGroutKg = area * groutPerSqm;
                        resultText = `${totalGroutKg.toFixed(2)} ×§"×’`;
                        if (bag_weight_kg > 0) {
                            const numBags = Math.ceil(totalGroutKg / bag_weight_kg);
                            resultText += ` (×›-${numBags} ${unit})`;
                        }
                    }
                }
                document.getElementById('calcResult').textContent = resultText;
            };

            calculateBtn.onclick = calcFunc;
            const inputs = productModal.querySelectorAll('#tab-calculator input');
            inputs.forEach(input => {
                input.addEventListener('input', calcFunc);
                input.addEventListener('focus', () => showKeyboard(input)); // Show keyboard on focus
            });
            calcFunc();
        }

        function openProductModal(filteredIndex) {
            currentProductIndexInFilteredList = filteredIndex;
            const product = currentFilteredProducts[filteredIndex];
            if (!product) return;
            
            modalContentWrapper.innerHTML = `
                <div class="modal-content">
                    <header class="p-6 border-b border-white border-opacity-40 flex justify-between items-start bg-gradient-to-br from-[#ADD8E6] to-[#87CEEB] text-white rounded-t-3xl">
                        <div>
                            <span class="text-xl text-white flex items-center">
                                ${product.brand_logo_url ? `<img src="${product.brand_logo_url}" alt="${product.brand} logo" class="w-8 h-8 object-contain mr-2 rounded-md" onerror="this.src='https://placehold.co/32x32/CCCCCC/333333?text=Logo'">` : ''}
                                ${product.brand}
                            </span>
                            <h2 class="text-4xl font-bold">${product.name}</h2>
                        </div>
                        <button id="closeModal" class="text-4xl font-bold text-white hover:text-red-300 transition-colors">&times;</button>
                    </header>
                    <div class="flex flex-col md:flex-row flex-grow overflow-hidden">
                        <div class="w-full md:w-2/5 p-6">
                             <img src="${product.image || `https://placehold.co/400x300/E0F2F7/2563EB?text=${encodeURIComponent(product.name)}`}" alt="${product.name}" class="rounded-2xl shadow-lg w-full object-cover border border-blue-200 hover:border-blue-400 hover:shadow-xl transition-all duration-300" onerror="this.src='https://placehold.co/400x300/E0F2F7/2563EB?text=Image+Not+Found'">
                             <p class="mt-4 text-gray-700 text-lg">${product.description}</p>
                             ${product.warranty ? `<div class="mt-4 p-3 bg-white bg-opacity-70 rounded-lg text-center border border-blue-100 text-lg"><p class="font-bold text-blue-700">××—×¨×™×•×ª: ${product.warranty}</p></div>` : ''}
                             ${product.datasheet_url ? `
                                <div class="mt-4 text-center">
                                    <p class="text-blue-800 text-lg font-semibold mb-2">×œ×¦×¤×™×™×” ×‘×ª×“×£ ×”××•×¦×¨ ×××ª×¨ ×”×™×¦×¨×Ÿ:</p>
                                    <button id="openDatasheet" class="btn-datasheet">×œ×—×¥ ×›××Ÿ ×œ×ª×“×£ ğŸ“„</button>
                                </div>
                             ` : ''}
                        </div>
                        <div class="w-full md:w-3/5 flex flex-col">
                            <nav id="modalTabs" class="border-b border-blue-200 flex-shrink-0 flex p-2"> <!-- Added p-2 for internal padding of tabs -->
                                <button data-tab="tab-specs" class="tab-button active">××¤×¨×˜ ×˜×›× ×™</button>
                                <button data-tab="tab-application" class="tab-button">×”×•×¨××•×ª ×™×™×©×•×</button>
                                ${Object.keys(product.drying).length > 0 ? `<button data-tab="tab-drying" class="tab-button">×–×× ×™ ×™×™×‘×•×©</button>` : ''}
                                ${product.calculator ? `<button data-tab="tab-calculator" class="tab-button">××—×©×‘×•×Ÿ ×›××•×ª</button>` : ''}
                            </nav>
                            <div class="p-6 overflow-y-auto flex-grow text-lg">
                                <div id="tab-specs" class="tab-content">
                                     <h3 class="font-bold text-2xl mb-4 text-blue-700">××¤×¨×˜ ×˜×›× ×™ ××œ×</h3>
                                     <div class="space-y-2">
                                        ${Object.entries(product.specs).map(([key, value]) => `
                                            <div class="flex border-b border-blue-100 py-3">
                                                <strong class="w-1/3 text-gray-600">${key}</strong>
                                                <span class="w-2/3 text-blue-800 font-semibold">${value}</span>
                                            </div>`).join('')}
                                     </div>
                                </div>
                                <div id="tab-application" class="tab-content hidden">
                                    <h3 class="font-bold text-2xl mb-4 text-blue-700">×”×•×¨××•×ª ×™×™×©×•×</h3>
                                    <ol class="list-decimal pr-5 space-y-3 text-blue-800">
                                        ${product.application.map(step => `<li>${step}</li>`).join('')}
                                    </ol>
                                </div>
                                <div id="tab-drying" class="tab-content hidden">
                                    <h3 class="font-bold text-2xl mb-4 text-blue-700">×–×× ×™ ×™×™×‘×•×© ×•××©×¤×¨×”</h3>
                                    ${createTimeline(product.drying)}
                                </div>
                                <div id="tab-calculator" class="tab-content hidden">
                                    ${createCalculatorHTML(product)}
                                </div>
                            </div>
                        </div>
                    </div>
                     <footer class="p-4 bg-white bg-opacity-90 border-t border-white border-opacity-40 flex justify-between items-center rounded-b-3xl">
                        <button id="prevProduct" class="btn-secondary ${currentProductIndexInFilteredList === 0 ? 'opacity-50 cursor-not-allowed' : ''}">â¬…ï¸ ×§×•×“×</button>
                        <button id="addToCart" data-product-id="${product.id}" class="btn-primary">×”×•×¡×£ ×œ×”×–×× ×”</button>
                        <button id="nextProduct" class="btn-secondary ${currentProductIndexInFilteredList === currentFilteredProducts.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}">×”×‘× â¡ï¸</button>
                    </footer>
                </div>
            `;
            
            productModal.classList.remove('hidden');

            document.getElementById('closeModal').addEventListener('click', () => productModal.classList.add('hidden'));
            
            document.getElementById('addToCart').addEventListener('click', (e) => {
                const productId = e.target.dataset.productId;
                addToCart(productId);
                productModal.classList.add('hidden');
            });

            document.getElementById('prevProduct').addEventListener('click', () => {
                if (currentProductIndexInFilteredList > 0) openProductModal(currentProductIndexInFilteredList - 1);
            });
            document.getElementById('nextProduct').addEventListener('click', () => {
                if (currentProductIndexInFilteredList < currentFilteredProducts.length - 1) openProductModal(currentProductIndexInFilteredList + 1);
            });

            if (product.datasheet_url) {
                document.getElementById('openDatasheet').addEventListener('click', () => {
                    window.open(product.datasheet_url, '_blank');
                });
            }

            const tabs = productModal.querySelectorAll('.tab-button');
            const tabContents = productModal.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    tabContents.forEach(content => content.classList.add('hidden'));
                    document.getElementById(tab.dataset.tab).classList.remove('hidden');
                });
            });
            
            if (product.calculator) {
                attachCalculatorListeners(product);
            }
        }
        
        function setupFilters() {
            const categories = [...new Set(products.map(p => p.category))];
            const brands = [...new Set(products.map(p => p.brand))];

            categoryFiltersContainer.innerHTML = categories.map(category => `
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" data-filter="category" value="${category}" class="form-checkbox h-5 w-5 text-blue-600 rounded border-gray-400 focus:ring-blue-600">
                    <span class="mr-3 text-blue-800 font-bold">${category}</span>
                </label>
            `).join('');

            brandFiltersContainer.innerHTML = brands.map(brand => `
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" data-filter="brand" value="${brand}" class="form-checkbox h-5 w-5 text-blue-600 rounded border-gray-400 focus:ring-blue-600">
                    <span class="mr-3 text-blue-800 font-bold">${brand}</span>
                </label>
            `).join('');
            
            document.querySelectorAll('#filters input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', applyFilters);
            });
        }
        
        function applyFilters() {
            const selectedCategories = Array.from(document.querySelectorAll('input[data-filter="category"]:checked')).map(cb => cb.value);
            const selectedBrands = Array.from(document.querySelectorAll('input[data-filter="brand"]:checked')).map(cb => cb.value);
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            let filteredProducts = products.filter(product => {
                const categoryMatch = selectedCategories.length === 0 || selectedCategories.includes(product.category);
                const brandMatch = selectedBrands.length === 0 || selectedBrands.includes(product.brand);
                const searchMatch = searchTerm === '' || product.name.toLowerCase().includes(searchTerm) || product.brand.toLowerCase().includes(searchTerm) || product.description.toLowerCase().includes(searchTerm);
                return categoryMatch && brandMatch && searchMatch;
            });
            renderProducts(filteredProducts);
        }

        function clearFilters() {
            document.querySelectorAll('#filters input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
            searchInput.value = '';
            applyFilters();
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === parseInt(productId));
            const existingItem = cart.find(item => item.id === product.id);

            if (existingItem) existingItem.quantity++;
            else cart.push({ ...product, quantity: 1 });
            
            updateCart();
        }

        function updateCart() {
            const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
            cartCount.textContent = totalItems;
            cartCount.classList.toggle('hidden', totalItems === 0);
            renderCartItems();
        }
        
        function renderCartItems() {
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = `<p class="text-center text-gray-500 py-8 text-lg">×¢×’×œ×ª ×”×”×–×× ×•×ª ×¨×™×§×”.</p>`;
                return;
            }
            cartItemsContainer.innerHTML = `
                <div class="space-y-4">
                    ${cart.map(item => `
                        <div class="flex items-center justify-between p-3 border-b border-gray-200 bg-white bg-opacity-70 rounded-lg">
                            <div class="flex items-center">
                                <img src="${item.image || `https://placehold.co/100x100/E0F2F7/2563EB?text=img`}" class="w-16 h-16 rounded-lg object-cover mr-4" onerror="this.src='https://placehold.co/100x100/E0F2F7/2563EB?text=Image+Not+Found'">
                                <div>
                                    <p class="font-bold text-blue-800 text-lg">${item.name}</p>
                                    <p class="text-sm text-gray-500">${item.brand}</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4 space-x-reverse">
                                 <button class="quantity-change font-bold text-xl text-blue-600 hover:text-blue-800" data-id="${item.id}" data-change="-1">-</button>
                                 <span class="font-semibold text-xl text-blue-800">${item.quantity}</span>
                                 <button class="quantity-change font-bold text-xl text-blue-600 hover:text-blue-800" data-id="${item.id}" data-change="1">+</button>
                                 <button class="remove-item text-red-500 hover:text-red-700 text-xl" data-id="${item.id}">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        }

        function handleCartInteraction(e) {
            const target = e.target.closest('button');
            if (!target) return;

            const id = parseInt(target.dataset.id);
            const item = cart.find(i => i.id === id);

            if (target.classList.contains('quantity-change')) {
                const change = parseInt(target.dataset.change);
                if (item) {
                    item.quantity += change;
                    if (item.quantity <= 0) cart = cart.filter(i => i.id !== id);
                }
            } else if (target.classList.contains('remove-item')) {
                 cart = cart.filter(i => i.id !== id);
            }
            updateCart();
        }

        productGrid.addEventListener('click', (e) => {
            const card = e.target.closest('.product-card');
            if (card) {
                const filteredIndex = parseInt(card.dataset.filteredIndex);
                openProductModal(filteredIndex);
            }
        });
        
        cartButton.addEventListener('click', () => cartModal.classList.remove('hidden'));
        closeCartModal.addEventListener('click', () => cartModal.classList.add('hidden'));

        projectAdvisorButton.addEventListener('click', () => {
            projectAdvisorModal.classList.remove('hidden');
            advisorChatHistoryDiv.scrollTop = advisorChatHistoryDiv.scrollHeight; // Scroll to bottom
            renderChatHistory(); // Ensure chat history is rendered on open
        });
        closeProjectAdvisorModal.addEventListener('click', () => {
            projectAdvisorModal.classList.add('hidden');
            clearInterval(typingInterval); // Stop any ongoing typing effect
            hideKeyboard(); // Ensure keyboard is hidden when advisor modal closes
        });

        scanBarcodeButton.addEventListener('click', () => {
            const barcode = prompt("×× × ×¡×¨×•×§ ××• ×”×§×œ×“ ×‘×¨×§×•×“:");
            if (barcode) {
                const product = products.find(p => p.id.toString() === barcode.trim());
                if (product) {
                    const indexInFullList = products.indexOf(product);
                    currentFilteredProducts = products; // Reset filtered products to full list for correct navigation
                    openProductModal(indexInFullList);
                } else {
                    // Using a custom alert-like message instead of window.alert
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-500 text-white p-4 rounded-lg shadow-xl z-[9999] text-xl';
                    msgDiv.textContent = `××•×¦×¨ ×¢× ×‘×¨×§×•×“ ${barcode} ×œ× × ××¦×. ğŸ˜”`;
                    document.body.appendChild(msgDiv);
                    setTimeout(() => msgDiv.remove(), 3000);
                }
            }
        });
        
        orderForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if(cart.length === 0) {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-500 text-white p-4 rounded-lg shadow-xl z-[9999] text-xl';
                msgDiv.textContent = "×¢×’×œ×ª ×”×”×–×× ×•×ª ×¨×™×§×”. ×œ× × ×™×ª×Ÿ ×œ×©×œ×•×— ×‘×§×©×”. ğŸ›’";
                document.body.appendChild(msgDiv);
                setTimeout(() => msgDiv.remove(), 3000);
                return;
            }

            const customerName = customerNameInput.value.trim();
            const customerPhone = customerPhoneInput.value.trim();
            const orderNotes = orderNotesInput.value.trim();

            let whatsappMessage = `*×”×–×× ×” ×—×“×©×” ××—.×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ*\n\n`;
            whatsappMessage += `*×¤×¨×˜×™ ×œ×§×•×—:*\n`;
            whatsappMessage += `×©×: ${customerName}\n`;
            whatsappMessage += `×˜×œ×¤×•×Ÿ: ${customerPhone}\n\n`;
            
            whatsappMessage += `*×¤×¨×˜×™ ×”×–×× ×”:*\n`;
            cart.forEach(item => {
                whatsappMessage += `- ${item.name} (××•×ª×’: ${item.brand}), ×›××•×ª: ${item.quantity}\n`;
            });

            if (orderNotes) {
                whatsappMessage += `\n*×”×¢×¨×•×ª × ×•×¡×¤×•×ª:*\n${orderNotes}\n`;
            }

            const whatsappUrl = `https://wa.me/972508860896?text=${encodeURIComponent(whatsappMessage)}`;
            
            window.open(whatsappUrl, '_blank');

            const msgDiv = document.createElement('div');
            msgDiv.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-green-500 text-white p-4 rounded-lg shadow-xl z-[9999] text-xl';
            msgDiv.textContent = "×”×‘×§×©×” ×œ×”×–×× ×” × ×©×œ×—×” ×‘×”×¦×œ×—×” ×œ×•×•××˜×¡××¤! × ×¦×™×’ ×™×™×¦×•×¨ ×¢××š ×§×©×¨ ×‘×”×§×“×. âœ…";
            document.body.appendChild(msgDiv);
            setTimeout(() => msgDiv.remove(), 3000);

            cart = [];
            updateCart();
            orderForm.reset();
            cartModal.classList.add('hidden');
        });

        // Function to call Gemini API
        async function getLLMResponse(chatHistoryData) {
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const payload = { contents: chatHistoryData };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) { // Check for HTTP errors (e.g., 400, 500)
                    const errorText = await response.text();
                    console.error("Gemini API call failed with status:", response.status, "Response text:", errorText);
                    return "××™×¨×¢×” ×©×’×™××” ×‘×§×‘×œ×ª ×”×™×™×¢×•×¥ ××”×©×¨×ª. ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨. ğŸ˜”";
                }

                const result = await response.json(); // This is where "Unexpected end of input" might occur

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const responseText = result.candidates[0].content.parts[0].text;
                    if (typeof responseText === 'string') {
                        return responseText;
                    } else {
                        console.error("LLM response part is not a string:", responseText);
                        return "××™×¨×¢×” ×©×’×™××” ×‘×¤×•×¨××˜ ×”×ª×©×•×‘×” ××”×™×•×¢×¥. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨. ğŸ˜”";
                    }
                } else {
                    console.error("LLM response structure unexpected or empty:", result);
                    return "××™×¨×¢×” ×©×’×™××” ×‘×§×‘×œ×ª ×”×™×™×¢×•×¥. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨. ğŸ˜”";
                }
            } catch (error) {
                console.error("Error calling Gemini API (network or JSON parsing error):", error);
                return "××™×¨×¢×” ×©×’×™××” ×‘×¨×©×ª ××• ×‘×©×¨×ª. ×× × × ×¡×” ×©×•×‘. ğŸŒ";
            }
        }

        let currentTypingIndex = 0;
        let fullAdvisorResponseText = "";
        let typingInterval;

        function typeAdvisorResponse(element, text, callback = () => {}) {
            fullAdvisorResponseText = text;
            currentTypingIndex = 0;
            element.innerHTML = ""; // Use innerHTML to allow markdown
            clearInterval(typingInterval);
            typingInterval = setInterval(() => {
                if (currentTypingIndex < fullAdvisorResponseText.length) {
                    element.innerHTML = marked.parse(fullAdvisorResponseText.substring(0, currentTypingIndex + 1));
                    currentTypingIndex++;
                    advisorChatHistoryDiv.scrollTop = advisorChatHistoryDiv.scrollHeight; // Keep scrolling
                } else {
                    clearInterval(typingInterval);
                    callback();
                }
            }, 30); // Typing speed
        }

        function addMessageToChat(role, text, options = {}) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            advisorChatHistoryDiv.appendChild(messageDiv);

            if (role === 'ai') {
                typeAdvisorResponse(messageDiv, text, () => {
                    if (options.showOptions) {
                         addChatOptions(messageDiv, text);
                    }
                    if (options.relatedProducts && options.relatedProducts.length > 0) {
                        displayRelatedProductsInChat(advisorChatHistoryDiv, options.relatedProducts);
                    }
                });
            } else {
                messageDiv.innerHTML = marked.parse(text); // For user messages, directly parse markdown if any
            }
            advisorChatHistoryDiv.scrollTop = advisorChatHistoryDiv.scrollHeight;
        }

        function addChatOptions(messageDiv, responseText) {
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'chat-options-container';
            messageDiv.appendChild(optionsContainer);

            // Try to identify a product mentioned in the last AI response
            const productNameMatch = responseText.match(/××•×¦×¨ (.+?) ××•××œ×¥/); // Simple regex to find product name
            const productName = productNameMatch ? productNameMatch[1].trim() : null;
            let product = null;
            if (productName) {
                product = products.find(p => p.name.includes(productName) || productName.includes(p.name));
            }
            
            if (product) {
                const expandButton = document.createElement('button');
                expandButton.className = 'chat-option-button';
                expandButton.textContent = `×”×¨×—×‘ ×¢×œ ${product.name} ğŸ“š`;
                expandButton.onclick = () => {
                    addMessageToChat('user', `×”×¨×—×‘ ×¢×œ ${product.name}`);
                    getAdvisorAdviceForProduct(product.id, 'expand');
                    optionsContainer.remove(); // Remove options after selection
                };
                optionsContainer.appendChild(expandButton);

                if (product.related_products_ids && product.related_products_ids.length > 0) {
                    const relatedButton = document.createElement('button');
                    relatedButton.className = 'chat-option-button';
                    relatedButton.textContent = `××•×¦×¨×™× × ×œ×•×•×™× ×œ ${product.name} ğŸ› ï¸`;
                    relatedButton.onclick = () => {
                        addMessageToChat('user', `××•×¦×¨×™× × ×œ×•×•×™× ×œ ${product.name}`);
                        getAdvisorAdviceForProduct(product.id, 'related');
                        optionsContainer.remove(); // Remove options after selection
                    };
                    optionsContainer.appendChild(relatedButton);
                }
            }
        }

        async function getAdvisorAdviceForProduct(productId, type) {
            const product = products.find(p => p.id === productId);
            if (!product) {
                addMessageToChat('ai', "××¦×˜×¢×¨, ×œ× ××¦××ª×™ ××™×“×¢ ×¢×œ ×”××•×¦×¨ ×”××‘×•×§×©. ğŸ¤”");
                return;
            }

            advisorLoading.classList.remove('hidden');
            let prompt = "";
            let relatedProductsToShow = [];

            if (type === 'expand') {
                prompt = `×”×¨×—×‘ ×‘×‘×§×©×” ××ª ×”××™×“×¢ ×¢×œ ×”××•×¦×¨ ${product.name} (××•×ª×’: ${product.brand}, ×§×˜×’×•×¨×™×”: ${product.category}). ×¦×™×™×Ÿ ××¤×¨×˜ ×˜×›× ×™, ×”×•×¨××•×ª ×™×™×©×•× ×•×–×× ×™ ×™×™×‘×•×© ×‘×¦×•×¨×” ××¡×•×“×¨×ª, ×™×—×“ ×¢× ××™××•×’'×™ ×¨×œ×•×•× ×˜×™. ×”×¦×’ ××ª ×”××¤×¨×˜ ×‘×˜×‘×œ×”.`;
            } else if (type === 'related') {
                const relatedProductNames = product.related_products_ids
                    .map(id => products.find(p => p.id === id)?.name)
                    .filter(name => name);
                
                let relatedProductsText = relatedProductNames.length > 0 ? relatedProductNames.join(', ') : "××™×Ÿ ××™×“×¢ ×–××™×Ÿ ×¢×œ ××•×¦×¨×™× × ×œ×•×•×™× ×¡×¤×¦×™×¤×™×™× ×‘×§×˜×œ×•×’.";
                
                prompt = `×”×¦×’ ×œ×™ ××•×¦×¨×™× × ×œ×•×•×™× ×œ××•×¦×¨ ${product.name} (××•×ª×’: ${product.brand}). ×‘× ×•×¡×£ ×œ××•×¦×¨×™× ××”×§×˜×œ×•×’, ×”×¦×¢ ×’× ×›×œ×™× ×—×™×•× ×™×™× ×¡×¤×¦×™×¤×™×™× ×©× ×“×¨×©×™× ×œ×™×™×©×•× ××•×¦×¨ ×–×”. ×¡×¤×§ ×ª×©×•×‘×” ×ª××¦×™×ª×™×ª ×¢× ××™××•×’'×™. ×¨×©×™××ª ××•×¦×¨×™× × ×œ×•×•×™× ×™×“×•×¢×™×: ${relatedProductsText}.`;
                
                // Collect product objects for display in chat
                relatedProductsToShow = product.related_products_ids.map(id => products.find(p => p.id === id)).filter(p => p);
            }

            const systemPrompt = `××ª×” ×™×•×¢×¥ ××•×¦×¨ ××ª×§×“× ×•××•××—×” ×œ×—×•××¨×™ ×‘× ×™×™×Ÿ ××˜×¢× ×—.×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ. ×¢× ×” ×¢×œ ×©××œ×•×ª ×”××©×ª××© ×‘×¦×•×¨×” ××§×¦×•×¢×™×ª, ××¤×•×¨×˜×ª ×•××“×•×™×§×ª, ×›××™×œ×• ××ª×” ××•××—×” ×‘×¢×œ ×™×“×¢ ×¢××•×§ ×‘×ª×—×•×.
            * **×“×™×•×§ ×•×ª××¦×•×ª**: ×¢× ×” ×¢×œ ×”×©××œ×” ×‘×ª××¦×™×ª×™×•×ª ×•×‘×“×™×•×§ ×ª×—×™×œ×”.
            * **×©××œ×•×ª ×”××©×š**: ×œ××—×¨ ××ª×Ÿ ×”×ª×©×•×‘×” ×”×ª××¦×™×ª×™×ª (××œ× ×× ×›×Ÿ ×–×• ×”×¨×—×‘×”), ×©××œ ××ª ×”××©×ª××© ×”×× ×™×¨×¦×” ×œ×”×¨×—×™×‘ ×‘×¤×¨×˜×™× × ×•×¡×¤×™× ×¢×œ ×”××•×¦×¨ ×”××•××œ×¥ ××• ×œ×¨××•×ª ××•×¦×¨×™× × ×œ×•×•×™×. ×œ×“×•×’××”: "×”×× ×ª×¨×¦×” ×œ×”×¨×—×™×‘ ×‘×¤×¨×˜×™× × ×•×¡×¤×™× ×¢×œ [×©× ×”××•×¦×¨] ××• ×œ×¨××•×ª ××•×¦×¨×™× × ×œ×•×•×™×? ğŸ’¡".
            * **× ×ª×•× ×™× ×¡×¤×¦×™×¤×™×™×**: ×‘××™×“×ª ×”×¨×œ×•×•× ×˜×™×•×ª, ×”×ª×™×™×—×¡ ×œ×¡×•×’×™ ×—×•××¨×™× ×•×›×œ×™× ×¡×¤×¦×™×¤×™×™× ××”×§×˜×œ×•×’ ×©×œ× ×• (×ª×¨××•×§×™×¨, ×¡×™×§×”, ×‘×•×©, ××§×™×˜×”, ×—××ª, ×˜×™×—, ××™×˜×•×, ×“×‘×§×™×, ×¨×•×‘×”, ×›×œ×™ ×¢×‘×•×“×”, ×’×‘×¡, ×—×•××¨×™ ×¦×•×‘×¨).
            * **×¤×¨×•×™×§×˜×™×**: ×× ×”×©××œ×” ×¢×•×¡×§×ª ×‘×¤×¨×•×™×§×˜, ×¡×¤×§ ×©×œ×‘×™× ×›×œ×œ×™×™× ××• ×˜×™×¤×™× ×—×©×•×‘×™× ×œ×‘×™×¦×•×¢.
            * **×©×™×œ×•×‘ ××™×“×¢ ×¢×œ ×—.×¡×‘×Ÿ**: "×—.×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ ×”×™× ×—×‘×¨×” ×•×ª×™×§×” ×•××•×‘×™×œ×” ×‘×ª×—×•× ×—×•××¨×™ ×”×‘× ×™×™×Ÿ ×‘×™×©×¨××œ. ×× ×• ××¦×™×¢×™× ××’×•×•×Ÿ ×¨×—×‘ ×©×œ ××•×¦×¨×™× ×•×›×œ×™× ×××™×˜×‘ ×”××•×ª×’×™×. ×œ×—×‘×¨×” ××¡×¤×¨ ×¡× ×™×¤×™× ×‘×¨×—×‘×™ ×”××¨×¥, ×¢× ××—×œ×§×•×ª ×™×™×¢×•×“×™×•×ª ×œ×˜×™×—, ××™×˜×•×, ××™× ×¡×˜×œ×¦×™×”, ×›×œ×™ ×¢×‘×•×“×”, ×’×‘×¡ ×•×—×•××¨×™ ×¦×•×‘×¨. ×× ×• ××¡×¤×§×™× ×©×™×¨×•×ª×™ ×”×•×‘×œ×” ×™×¢×™×œ×™× ×¢×“ ××ª×¨ ×”×œ×§×•×—."
            * **×©×™×œ×•×‘ ××™××•×’'×™**: ×”×•×¡×£ ××™××•×’'×™ ×¨×œ×•×•× ×˜×™ ×•×××—×™×© ×œ×ª×©×•×‘×”.
            * **×¤×•×¨××˜ ×˜×‘×œ××™**: ×× ×”×ª×©×•×‘×” ×›×•×œ×œ×ª ×”×©×•×•××” ××• ×¨×©×™××” ×©×œ × ×ª×•× ×™×, ×”×¦×’ ××•×ª× ×‘×¤×•×¨××˜ ×©×œ ×˜×‘×œ×” (×‘×××¦×¢×•×ª Markdown).
            * **×–×™×”×•×™ ××•×¦×¨×™× ×§×˜×œ×•×’×™×™×**: × ×¡×” ×œ×–×”×•×ª ×©××•×ª ××•×¦×¨×™× ××”×§×˜×œ×•×’ ×›×“×™ ×œ×”×¦×™×¢ ×§×™×©×•×¨×™× ××• ×¤×¨×˜×™× × ×•×¡×¤×™×.
            * **××•×¦×¨×™× × ×œ×•×•×™× ×¡×¤×¦×™×¤×™×™×**: ×›××©×¨ ×”××©×ª××© ××‘×§×© "××•×¦×¨×™× × ×œ×•×•×™×" ×œ××•×¦×¨ ××¡×•×™× (×œ×“×•×’××”: SikaTop Seal-107), × ×¡×” ×œ×”×¦×™×¢ ×’× ×›×œ×™× ×¡×¤×¦×™×¤×™×™× (×›×’×•×Ÿ ××‘×¨×©×ª ×–×¤×ª ××• ×¨×•×œ×¨ ×œ×™×™×©×•×, ×›×¤×¤×•×ª, ×“×œ×™ ×¢×¨×‘×•×‘) ×‘× ×•×¡×£ ×œ××•×¦×¨×™ ×¢×–×¨ ××—×¨×™×.

            ×ª×©×•×‘×ª×š ×¦×¨×™×›×” ×œ×”×™×•×ª ×‘×¢×‘×¨×™×ª ×‘×œ×‘×“.`;

            const currentChatHistory = [...chatHistory]; // Copy current history
            currentChatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const llmResponse = await getLLMResponse(currentChatHistory);
            
            advisorLoading.classList.add('hidden');
            addMessageToChat('ai', llmResponse, { showOptions: (type === 'expand' || type === 'related') ? false : true, relatedProducts: relatedProductsToShow });
            chatHistory.push({ role: "model", parts: [{ text: llmResponse }] });
        }


        function displayRelatedProductsInChat(container, relatedProducts) {
            if (relatedProducts.length === 0) return;

            const relatedDiv = document.createElement('div');
            relatedDiv.className = 'flex flex-wrap gap-4 mt-4 justify-start'; // Align items to start

            relatedProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'w-32 bg-white bg-opacity-80 rounded-lg shadow p-2 text-center text-sm border border-blue-100 cursor-pointer hover:bg-blue-50 transition-colors';
                productCard.onclick = () => openProductModal(products.indexOf(product)); // Open product modal
                productCard.innerHTML = `
                    <img src="${product.image || `https://placehold.co/100x75/E0F2F7/2563EB?text=img`}" alt="${product.name}" class="w-full h-20 object-cover rounded mb-2" onerror="this.src='https://placehold.co/100x75/E0F2F7/2563EB?text=Image+Not+Found'">
                    <p class="font-bold text-blue-800 truncate">${product.name}</p>
                    <p class="text-gray-600">${product.brand}</p>
                `;
                relatedDiv.appendChild(productCard);
            });
            container.appendChild(relatedDiv);
            container.scrollTop = container.scrollHeight;
        }


        // Event listener for the "Get Advice" button in Project Advisor Modal
        getAdvisorAdviceButton.addEventListener('click', async () => {
            const userQuery = projectAdvisorInput.value.trim();

            if (!userQuery) {
                addMessageToChat('ai', "×× × ×”×–×Ÿ ××ª ×”×¤×¨×•×™×§×˜ ×©×œ×š ××• ×©××œ×”. ğŸ§");
                return;
            }

            addMessageToChat('user', userQuery);
            chatHistory.push({ role: "user", parts: [{ text: userQuery }] });
            projectAdvisorInput.value = ""; // Clear input after sending
            hideKeyboard(); // Hide keyboard after sending message

            // Show loading indicator
            advisorLoading.classList.remove('hidden');

            const systemPrompt = `××ª×” ×™×•×¢×¥ ××•×¦×¨ ××ª×§×“× ×•××•××—×” ×œ×—×•××¨×™ ×‘× ×™×™×Ÿ ××˜×¢× ×—.×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ. ×¢× ×” ×¢×œ ×©××œ×•×ª ×”××©×ª××© ×‘×¦×•×¨×” ××§×¦×•×¢×™×ª, ××¤×•×¨×˜×ª ×•××“×•×™×§×ª, ×›××™×œ×• ××ª×” ××•××—×” ×‘×¢×œ ×™×“×¢ ×¢××•×§ ×‘×ª×—×•×.
            * **×“×™×•×§ ×•×ª××¦×•×ª**: ×¢× ×” ×¢×œ ×”×©××œ×” ×‘×ª××¦×™×ª×™×•×ª ×•×‘×“×™×•×§ ×ª×—×™×œ×”.
            * **×©××œ×•×ª ×”××©×š**: ×œ××—×¨ ××ª×Ÿ ×”×ª×©×•×‘×” ×”×ª××¦×™×ª×™×ª, ×©××œ ××ª ×”××©×ª××© ×”×× ×™×¨×¦×” ×œ×”×¨×—×™×‘ ×‘×¤×¨×˜×™× × ×•×¡×¤×™× ×¢×œ ×”××•×¦×¨ ×”××•××œ×¥ ××• ×œ×¨××•×ª ××•×¦×¨×™× × ×œ×•×•×™×. ×œ×“×•×’××”: "×”×× ×ª×¨×¦×” ×œ×”×¨×—×™×‘ ×‘×¤×¨×˜×™× × ×•×¡×¤×™× ×¢×œ [×©× ×”××•×¦×¨] ××• ×œ×¨××•×ª ××•×¦×¨×™× × ×œ×•×•×™×? ğŸ’¡".
            * **× ×ª×•× ×™× ×¡×¤×¦×™×¤×™×™×**: ×‘××™×“×ª ×”×¨×œ×•×•× ×˜×™×•×ª, ×”×ª×™×™×—×¡ ×œ×¡×•×’×™ ×—×•××¨×™× ×•×›×œ×™× ×¡×¤×¦×™×¤×™×™× ××”×§×˜×œ×•×’ ×©×œ× ×• (×ª×¨××•×§×™×¨, ×¡×™×§×”, ×‘×•×©, ××§×™×˜×”, ×—××ª, ×˜×™×—, ××™×˜×•×, ×“×‘×§×™×, ×¨×•×‘×”, ×›×œ×™ ×¢×‘×•×“×”, ×’×‘×¡, ×—×•××¨×™ ×¦×•×‘×¨).
            * **×¤×¨×•×™×§×˜×™×**: ×× ×”×©××œ×” ×¢×•×¡×§×ª ×‘×¤×¨×•×™×§×˜, ×¡×¤×§ ×©×œ×‘×™× ×›×œ×œ×™×™× ××• ×˜×™×¤×™× ×—×©×•×‘×™× ×œ×‘×™×¦×•×¢.
            * **×©×™×œ×•×‘ ××™×“×¢ ×¢×œ ×—.×¡×‘×Ÿ**: "×—.×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ ×”×™× ×—×‘×¨×” ×•×ª×™×§×” ×•××•×‘×™×œ×” ×‘×ª×—×•× ×—×•××¨×™ ×”×‘× ×™×™×Ÿ ×‘×™×©×¨××œ. ×× ×• ××¦×™×¢×™× ××’×•×•×Ÿ ×¨×—×‘ ×©×œ ××•×¦×¨×™× ×•×›×œ×™× ×××™×˜×‘ ×”××•×ª×’×™×. ×œ×—×‘×¨×” ××¡×¤×¨ ×¡× ×™×¤×™× ×‘×¨×—×‘×™ ×”××¨×¥, ×¢× ××—×œ×§×•×ª ×™×™×¢×•×“×™×•×ª ×œ×˜×™×—, ××™×˜×•×, ××™× ×¡×˜×œ×¦×™×”, ×›×œ×™ ×¢×‘×•×“×”, ×’×‘×¡ ×•×—×•××¨×™ ×¦×•×‘×¨. ×× ×• ××¡×¤×§×™× ×©×™×¨×•×ª×™ ×”×•×‘×œ×” ×™×¢×™×œ×™× ×¢×“ ××ª×¨ ×”×œ×§×•×—."
            * **×©×™×œ×•×‘ ××™××•×’'×™**: ×”×•×¡×£ ××™××•×’'×™ ×¨×œ×•×•× ×˜×™ ×•×××—×™×© ×œ×ª×©×•×‘×”.
            * **×¤×•×¨××˜ ×˜×‘×œ××™**: ×× ×”×ª×©×•×‘×” ×›×•×œ×œ×ª ×”×©×•×•××” ××• ×¨×©×™××” ×©×œ × ×ª×•× ×™×, ×”×¦×’ ××•×ª× ×‘×¤×•×¨××˜ ×©×œ ×˜×‘×œ×” (×‘×××¦×¢×•×ª Markdown).
            * **×–×™×”×•×™ ××•×¦×¨×™× ×§×˜×œ×•×’×™×™×**: × ×¡×” ×œ×–×”×•×ª ×©××•×ª ××•×¦×¨×™× ××”×§×˜×œ×•×’ ×›×“×™ ×œ×”×¦×™×¢ ×§×™×©×•×¨×™× ××• ×¤×¨×˜×™× × ×•×¡×¤×™×.
            * **××•×¦×¨×™× × ×œ×•×•×™× ×¡×¤×¦×™×¤×™×™×**: ×›××©×¨ ×”××©×ª××© ××‘×§×© "××•×¦×¨×™× × ×œ×•×•×™×" ×œ××•×¦×¨ ××¡×•×™× (×œ×“×•×’××”: SikaTop Seal-107), × ×¡×” ×œ×”×¦×™×¢ ×’× ×›×œ×™× ×¡×¤×¦×™×¤×™×™× (×›×’×•×Ÿ ××‘×¨×©×ª ×–×¤×ª ××• ×¨×•×œ×¨ ×œ×™×™×©×•×, ×›×¤×¤×•×ª, ×“×œ×™ ×¢×¨×‘×•×‘) ×‘× ×•×¡×£ ×œ××•×¦×¨×™ ×¢×–×¨ ××—×¨×™×.

            ×ª×©×•×‘×ª×š ×¦×¨×™×›×” ×œ×”×™×•×ª ×‘×¢×‘×¨×™×ª ×‘×œ×‘×“.`;

            const fullPrompt = [
                { role: "user", parts: [{ text: systemPrompt }] },
                ...chatHistory // Append previous chat messages
            ];

            const llmResponse = await getLLMResponse(fullPrompt);
            
            // Hide loading indicator
            advisorLoading.classList.add('hidden');
            addMessageToChat('ai', llmResponse, { showOptions: true }); // Show options after initial response
            chatHistory.push({ role: "model", parts: [{ text: llmResponse }] }); // Add AI response to history
        });

        clearFiltersButton.addEventListener('click', clearFilters);
        searchInput.addEventListener('input', applyFilters);
        cartItemsContainer.addEventListener('click', handleCartInteraction);

        // --- Gallery Modal Logic ---
        function renderGalleryImages(filterBranch = 'all') {
            galleryImageContainer.innerHTML = '';
            const imagesToDisplay = filterBranch === 'all' ? storeImages : storeImages.filter(img => img.branch === filterBranch);

            if (imagesToDisplay.length === 0) {
                galleryImageContainer.innerHTML = `<p class="text-center text-gray-500 col-span-full text-xl py-10">××™×Ÿ ×ª××•× ×•×ª ×–××™× ×•×ª ×¢×‘×•×¨ ×¡× ×™×£ ×–×”.</p>`;
                return;
            }

            imagesToDisplay.forEach(image => {
                const imgCard = document.createElement('div');
                imgCard.className = 'gallery-image-card';
                imgCard.innerHTML = `
                    <img src="${image.src}" alt="${image.alt}" onerror="this.src='https://placehold.co/600x400/E0F2F7/2563EB?text=×ª××•× ×”+×œ×+× ××¦××”'">
                    <p class="p-2 text-base font-semibold text-blue-800">${image.alt}</p>
                `;
                galleryImageContainer.appendChild(imgCard);
            });
        }

        showGalleryButton.addEventListener('click', () => {
            galleryModal.classList.remove('hidden');
            renderGalleryImages('all'); // Show all by default
            document.querySelectorAll('.active-filter-btn').forEach(btn => btn.classList.remove('active-filter-btn'));
            document.querySelector('[data-branch-filter="all"]').classList.add('active-filter-btn');
            hideKeyboard(); // Hide keyboard when gallery opens
        });

        closeGalleryModal.addEventListener('click', () => {
            galleryModal.classList.add('hidden');
        });

        galleryModal.querySelectorAll('.btn-secondary[data-branch-filter]').forEach(button => {
            button.addEventListener('click', (e) => {
                const branch = e.target.dataset.branchFilter;
                renderGalleryImages(branch);
                galleryModal.querySelectorAll('.active-filter-btn').forEach(btn => btn.classList.remove('active-filter-btn'));
                e.target.classList.add('active-filter-btn');
            });
        });
        // --- End Gallery Modal Logic ---


        // Typing effect for search placeholder
        const placeholderText = "×—×™×¤×•×© ×œ×¤×™ ×©×, ××•×ª×’, ×ª×™××•×¨...";
        let i = 0;
        function typeWriter() {
            if (i < placeholderText.length) {
                searchInput.placeholder = placeholderText.substring(0, i + 1);
                i++;
                setTimeout(typeWriter, 80);
            } else {
                 searchInput.placeholder += "|";
                 setInterval(() => {
                    const placeholder = searchInput.placeholder;
                    if (placeholder.endsWith('|')) {
                        searchInput.placeholder = placeholder.slice(0, -1);
                    } else {
                        searchInput.placeholder += '|';
                    }
                 }, 500);
            }
        }

        // --- Keyboard Focus Listeners ---
        searchInput.addEventListener('focus', () => showKeyboard(searchInput));
        projectAdvisorInput.addEventListener('focus', () => showKeyboard(projectAdvisorInput));
        customerNameInput.addEventListener('focus', () => showKeyboard(customerNameInput));
        customerPhoneInput.addEventListener('focus', () => showKeyboard(customerPhoneInput));
        orderNotesInput.addEventListener('focus', () => showKeyboard(orderNotesInput));

        // Close keyboard if user clicks outside of any input or keyboard
        document.addEventListener('click', (e) => {
            const isClickInsideKeyboard = virtualKeyboard.contains(e.target);
            const isClickInsideInput = (activeInput && activeInput.contains(e.target));
            
            if (!isClickInsideKeyboard && !isClickInsideInput && virtualKeyboard.classList.contains('active')) {
                hideKeyboard();
            }
        });
        // --- End Keyboard Focus Listeners ---

        // Load marked.js for Markdown parsing in chat responses
        const markedScript = document.createElement('script');
        markedScript.src = "https://cdn.jsdelivr.net/npm/marked/marked.min.js";
        markedScript.onload = () => {
             // After marked.js is loaded, set up the renderer
            const renderer = {
                table(header, body) {
                    return `<table class="min-w-full text-lg"><thead>${header}</thead><tbody>${body}</tbody></table>`;
                },
                tablerow(content) {
                    return `<tr>${content}</tr>`;
                },
                tablecell(content, flags) {
                    const tag = flags.header ? 'th' : 'td';
                    return `<${tag}>${content}</${tag}>`;
                },
                strong(text) {
                    return `<strong>${text}</strong>`;
                },
                paragraph(text) {
                    return `<p class="mb-2 text-lg">${text}</p>`;
                },
                list(body, ordered) {
                    const tag = ordered ? 'ol' : 'ul';
                    return `<${tag} class="list-${ordered ? 'decimal' : 'disc'} pr-5 space-y-1 text-lg">${body}</${tag}>`;
                },
                listitem(text) {
                    return `<li class="text-lg">${text}</li>`;
                }
            };

            if (typeof marked !== 'undefined' && typeof marked.use === 'function') {
                marked.use({ renderer });
            } else if (typeof marked !== 'undefined' && typeof marked.Renderer !== 'undefined') {
                const defaultRenderer = new marked.Renderer();
                for (const prop in renderer) {
                    if (renderer.hasOwnProperty(prop)) {
                        defaultRenderer[prop] = renderer[prop];
                    }
                }
                marked.setOptions({ renderer: defaultRenderer });
            } else {
                console.warn("Marked.js is not loaded or is an unsupported version. Markdown rendering might not work as expected.");
            }
             // Initial render of chat history after marked.js is ready
            projectAdvisorModal.addEventListener('transitionend', () => {
                if (!projectAdvisorModal.classList.contains('hidden')) {
                    renderChatHistory();
                }
            }, { once: true }); // Only run once per open
        };
        document.head.appendChild(markedScript);

        // Initialize chat history display when modal opens
        function renderChatHistory() {
            advisorChatHistoryDiv.innerHTML = '';
            // Add initial welcome message only if chat history is empty
            if (chatHistory.length === 0) {
                const initialMessageDiv = document.createElement('div');
                initialMessageDiv.className = 'chat-message ai';
                initialMessageDiv.textContent = '×©×œ×•×! ×× ×™ ×™×•×¢×¥ ×”××•×¦×¨ ×”××ª×§×“× ×©×œ ×—.×¡×‘×Ÿ ×—×•××¨×™ ×‘× ×™×™×Ÿ. ××™×š ××•×›×œ ×œ×¢×–×•×¨ ×œ×š ×”×™×•×? ğŸ˜Š';
                advisorChatHistoryDiv.appendChild(initialMessageDiv);
            } else {
                chatHistory.forEach(msg => {
                    if (msg.role !== 'system') { // Don't render the system prompt
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${msg.role}`;
                        messageDiv.innerHTML = marked.parse(msg.parts[0].text);
                        advisorChatHistoryDiv.appendChild(messageDiv);
                    }
                });
            }
            advisorChatHistoryDiv.scrollTop = advisorChatHistoryDiv.scrollHeight;
        }


        document.addEventListener('DOMContentLoaded', async () => {
            await populateProductImages(); // Fetch and set images
            setupFilters();
            updateCart();
            typeWriter();
            renderKeyboard(); // Initial keyboard render
            renderChatHistory(); // Render initial chat history
            renderGalleryImages('all'); // Initial render of gallery
        });

    </script>
</body>
</html>
ï¿½
